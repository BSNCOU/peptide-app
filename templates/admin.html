<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Research Materials</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f7fa; color: #333; line-height: 1.6; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        header { background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%); color: white; padding: 15px 0; margin-bottom: 30px; }
        header .container { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        header h1 { font-size: 1.4rem; }
        .header-nav { display: flex; gap: 10px; flex-wrap: wrap; }
        .header-nav button { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; }
        .header-nav button:hover { background: rgba(255,255,255,0.2); }
        .card { background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); padding: 25px; margin-bottom: 20px; }
        .card h2 { color: #1a202c; margin-bottom: 20px; font-size: 1.2rem; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); text-align: center; }
        .stat-card h3 { font-size: 2rem; color: #2b6cb0; margin-bottom: 5px; }
        .stat-card p { color: #718096; font-size: 0.9rem; }
        .stat-card.warning { border-left: 4px solid #ed8936; }
        .stat-card.danger { border-left: 4px solid #e53e3e; }
        .tabs { display: flex; border-bottom: 2px solid #e2e8f0; margin-bottom: 20px; overflow-x: auto; }
        .tabs button { background: none; border: none; padding: 12px 20px; cursor: pointer; font-size: 0.95rem; color: #718096; border-bottom: 2px solid transparent; margin-bottom: -2px; white-space: nowrap; }
        .tabs button.active { color: #2b6cb0; border-bottom-color: #4299e1; }
        .tabs button:hover { color: #2b6cb0; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        th { background: #f7fafc; font-weight: 600; color: #4a5568; font-size: 0.85rem; text-transform: uppercase; }
        tr:hover { background: #f7fafc; }
        .btn { background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s; }
        .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(66,153,225,0.3); }
        .btn:disabled { background: #a0aec0; cursor: not-allowed; transform: none; }
        .btn-small { padding: 5px 10px; font-size: 0.8rem; }
        .btn-secondary { background: linear-gradient(135deg, #718096 0%, #4a5568 100%); }
        .btn-success { background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); }
        .btn-danger { background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%); }
        .btn-warning { background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; color: #4a5568; font-size: 0.9rem; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 0.95rem; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #4299e1; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .alert { padding: 12px 16px; border-radius: 8px; margin-bottom: 15px; }
        .alert-error { background: #fed7d7; color: #c53030; }
        .alert-success { background: #c6f6d5; color: #276749; }
        .alert-warning { background: #fefcbf; color: #975a16; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; border-radius: 12px; padding: 25px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-content h3 { margin-bottom: 20px; }
        .status-badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 500; }
        .status-pending { background: #fefcbf; color: #975a16; }
        .status-paid { background: #c6f6d5; color: #276749; }
        .status-processing { background: #bee3f8; color: #2b6cb0; }
        .status-shipped { background: #e9d8fd; color: #6b46c1; }
        .status-delivered { background: #c6f6d5; color: #276749; }
        .status-fulfilled { background: #c6f6d5; color: #276749; }
        .status-cancelled { background: #fed7d7; color: #c53030; }
        .status-refunded { background: #feebc8; color: #c05621; }
        .low-stock { color: #e53e3e; font-weight: 600; }
        .inactive { opacity: 0.5; }
        .search-bar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .search-bar input, .search-bar select { padding: 10px; border: 2px solid #e2e8f0; border-radius: 6px; }
        .search-bar input { flex: 1; min-width: 200px; }
        .hidden { display: none !important; }
        .actions { display: flex; gap: 5px; flex-wrap: wrap; }
        .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .notification-item { padding: 12px; border-bottom: 1px solid #e2e8f0; }
        .notification-item:last-child { border-bottom: none; }
        .notification-item .meta { font-size: 0.85rem; color: #718096; margin-top: 5px; }
        .bulk-actions { background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        @media (max-width: 768px) {
            table { font-size: 0.85rem; }
            th, td { padding: 8px; }
            .actions { flex-direction: column; }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>üìä Admin Dashboard</h1>
            <div class="header-nav">
                <button onclick="window.location.href='/'">‚Üê Customer Site</button>
                <button onclick="logout()">Logout</button>
            </div>
        </div>
    </header>

    <div class="container">
        <div id="alertContainer"></div>
        <div id="statsContainer"></div>
        
        <div class="card">
            <div class="tabs">
                <button class="active" onclick="showTab('products')">Products</button>
                <button onclick="showTab('inventory')">Inventory</button>
                <button onclick="showTab('orders')">All Orders</button>
                <button onclick="showTab('openOrders')">Open Orders</button>
                <button onclick="showTab('discounts')">Discount Codes</button>
                <button onclick="showTab('reports')">Reports</button>
                <button onclick="showTab('users')">Users</button>
                <button onclick="showTab('notifications')">Notifications</button>
            </div>
            <div id="tabContent"></div>
        </div>
    </div>

    <div id="modalContainer"></div>

    <script>
        let state = {
            csrfToken: null,
            stats: null,
            products: [],
            orders: [],
            discounts: [],
            users: [],
            notifications: [],
            inventory: [],
            currentTab: 'products',
            orderStatusFilter: ''
        };

        async function api(endpoint, options = {}) {
            const headers = { 'Content-Type': 'application/json' };
            if (state.csrfToken && ['POST', 'PUT', 'DELETE'].includes(options.method)) {
                headers['X-CSRF-Token'] = state.csrfToken;
            }
            const res = await fetch(endpoint, { ...options, headers, credentials: 'same-origin' });
            const data = await res.json();
            if (!res.ok) throw new Error(data.error || 'Request failed');
            return data;
        }

        function showAlert(message, type = 'error') {
            const container = document.getElementById('alertContainer');
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }

        async function init() {
            try {
                const tokenRes = await api('/api/csrf-token');
                state.csrfToken = tokenRes.token;
            } catch (e) { console.error('CSRF error:', e); }

            try {
                await api('/api/me');
            } catch (e) {
                window.location.href = '/';
                return;
            }

            await loadStats();
            showTab('products');
        }

        async function loadStats() {
            try {
                state.stats = await api('/api/admin/stats');
                renderStats();
            } catch (e) {
                showAlert('Failed to load stats');
            }
        }

        function renderStats() {
            const s = state.stats;
            const lowStockCount = s.low_stock_items?.length || 0;
            
            document.getElementById('statsContainer').innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>${s.total_orders || 0}</h3>
                        <p>Total Orders</p>
                    </div>
                    <div class="stat-card">
                        <h3>$${(s.total_revenue || 0).toFixed(2)}</h3>
                        <p>Total Revenue</p>
                    </div>
                    <div class="stat-card">
                        <h3>${s.total_users || 0}</h3>
                        <p>Registered Users</p>
                    </div>
                    <div class="stat-card">
                        <h3>${s.total_products || 0}</h3>
                        <p>Products</p>
                    </div>
                    <div class="stat-card ${lowStockCount > 0 ? 'danger' : ''}">
                        <h3>${lowStockCount}</h3>
                        <p>Low Stock Items</p>
                    </div>
                </div>
                ${lowStockCount > 0 ? `
                    <div class="alert alert-warning">
                        <strong>‚ö†Ô∏è Low Stock Alert:</strong> 
                        ${s.low_stock_items.map(i => `${i.name} (${i.stock} left)`).join(', ')}
                    </div>
                ` : ''}
            `;
        }

        function showTab(tab) {
            state.currentTab = tab;
            document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
            const tabList = ['products','inventory','orders','openOrders','discounts','reports','users','notifications'];
            document.querySelector(`.tabs button:nth-child(${tabList.indexOf(tab)+1})`).classList.add('active');
            
            switch(tab) {
                case 'products': loadProducts(); break;
                case 'inventory': loadInventory(); break;
                case 'orders': loadOrders(); break;
                case 'openOrders': loadOpenOrders(); break;
                case 'discounts': loadDiscounts(); break;
                case 'reports': renderReports(); break;
                case 'users': loadUsers(); break;
                case 'notifications': loadNotifications(); break;
            }
        }

        // Products
        async function loadProducts() {
            try {
                state.products = await api('/api/admin/products');
                renderProducts();
            } catch (e) {
                showAlert('Failed to load products');
            }
        }

        function renderProducts() {
            const content = document.getElementById('tabContent');
            content.innerHTML = `
                <div class="toolbar">
                    <button class="btn" onclick="showAddProductModal()">+ Add Product</button>
                    <button class="btn btn-secondary" onclick="showBulkStockModal()">üì¶ Bulk Stock Update</button>
                </div>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>SKU</th>
                                <th>Name</th>
                                <th>Category</th>
                                <th>Price</th>
                                <th>Stock</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${state.products.map(p => `
                                <tr class="${!p.active ? 'inactive' : ''}">
                                    <td>${p.sku}</td>
                                    <td>${p.name}</td>
                                    <td>${p.category || '-'}</td>
                                    <td>$${p.price_single.toFixed(2)}${p.price_bulk ? ` / $${p.price_bulk.toFixed(2)}` : ''}</td>
                                    <td class="${p.stock < 10 ? 'low-stock' : ''}">${p.stock}</td>
                                    <td>${p.active ? '<span class="status-badge status-paid">Active</span>' : '<span class="status-badge status-cancelled">Inactive</span>'}</td>
                                    <td class="actions">
                                        <button class="btn btn-small" onclick="showEditProductModal(${p.id})">Edit</button>
                                        ${p.active 
                                            ? `<button class="btn btn-danger btn-small" onclick="deleteProduct(${p.id})">Deactivate</button>`
                                            : `<button class="btn btn-success btn-small" onclick="restoreProduct(${p.id})">Restore</button>`
                                        }
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function showAddProductModal() {
            document.getElementById('modalContainer').innerHTML = `
                <div class="modal" onclick="if(event.target===this)closeModal()">
                    <div class="modal-content">
                        <h3>Add New Product</h3>
                        <form onsubmit="addProduct(event)">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>SKU *</label>
                                    <input type="text" id="prodSku" required>
                                </div>
                                <div class="form-group">
                                    <label>Name *</label>
                                    <input type="text" id="prodName" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Description</label>
                                <textarea id="prodDesc" rows="2"></textarea>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Single Price *</label>
                                    <input type="number" id="prodPrice" step="0.01" required>
                                </div>
                                <div class="form-group">
                                    <label>Bulk Price</label>
                                    <input type="number" id="prodBulkPrice" step="0.01">
                                </div>
                                <div class="form-group">
                                    <label>Bulk Qty</label>
                                    <input type="number" id="prodBulkQty" value="10">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Category</label>
                                    <input type="text" id="prodCategory">
                                </div>
                                <div class="form-group">
                                    <label>Stock *</label>
                                    <input type="number" id="prodStock" required value="0">
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                                <button type="submit" class="btn">Add Product</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        async function addProduct(e) {
            e.preventDefault();
            try {
                await api('/api/admin/products', {
                    method: 'POST',
                    body: JSON.stringify({
                        sku: document.getElementById('prodSku').value,
                        name: document.getElementById('prodName').value,
                        description: document.getElementById('prodDesc').value,
                        price_single: parseFloat(document.getElementById('prodPrice').value),
                        price_bulk: parseFloat(document.getElementById('prodBulkPrice').value) || null,
                        bulk_quantity: parseInt(document.getElementById('prodBulkQty').value) || 10,
                        category: document.getElementById('prodCategory').value,
                        stock: parseInt(document.getElementById('prodStock').value)
                    })
                });
                closeModal();
                showAlert('Product added successfully', 'success');
                loadProducts();
            } catch (err) {
                showAlert(err.message);
            }
        }

        function showEditProductModal(id) {
            const p = state.products.find(x => x.id === id);
            if (!p) return;
            
            document.getElementById('modalContainer').innerHTML = `
                <div class="modal" onclick="if(event.target===this)closeModal()">
                    <div class="modal-content">
                        <h3>Edit Product: ${p.name}</h3>
                        <form onsubmit="updateProduct(event, ${id})">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>SKU</label>
                                    <input type="text" id="prodSku" value="${p.sku}" readonly style="background: #f7fafc;">
                                </div>
                                <div class="form-group">
                                    <label>Name *</label>
                                    <input type="text" id="prodName" value="${p.name}" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Description</label>
                                <textarea id="prodDesc" rows="2">${p.description || ''}</textarea>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Single Price *</label>
                                    <input type="number" id="prodPrice" step="0.01" value="${p.price_single}" required>
                                </div>
                                <div class="form-group">
                                    <label>Bulk Price</label>
                                    <input type="number" id="prodBulkPrice" step="0.01" value="${p.price_bulk || ''}">
                                </div>
                                <div class="form-group">
                                    <label>Bulk Qty</label>
                                    <input type="number" id="prodBulkQty" value="${p.bulk_quantity || 10}">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Category</label>
                                    <input type="text" id="prodCategory" value="${p.category || ''}">
                                </div>
                                <div class="form-group">
                                    <label>Stock *</label>
                                    <input type="number" id="prodStock" value="${p.stock}" required>
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                                <button type="submit" class="btn">Save Changes</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        async function updateProduct(e, id) {
            e.preventDefault();
            try {
                await api(`/api/admin/products/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        name: document.getElementById('prodName').value,
                        description: document.getElementById('prodDesc').value,
                        price_single: parseFloat(document.getElementById('prodPrice').value),
                        price_bulk: parseFloat(document.getElementById('prodBulkPrice').value) || null,
                        bulk_quantity: parseInt(document.getElementById('prodBulkQty').value) || 10,
                        category: document.getElementById('prodCategory').value,
                        stock: parseInt(document.getElementById('prodStock').value)
                    })
                });
                closeModal();
                showAlert('Product updated successfully', 'success');
                loadProducts();
                loadStats();
            } catch (err) {
                showAlert(err.message);
            }
        }

        async function deleteProduct(id) {
            if (!confirm('Are you sure you want to deactivate this product?')) return;
            try {
                await api(`/api/admin/products/${id}`, { method: 'DELETE' });
                showAlert('Product deactivated', 'success');
                loadProducts();
            } catch (err) {
                showAlert(err.message);
            }
        }

        async function restoreProduct(id) {
            try {
                await api(`/api/admin/products/${id}/restore`, { method: 'POST' });
                showAlert('Product restored', 'success');
                loadProducts();
            } catch (err) {
                showAlert(err.message);
            }
        }

        function showBulkStockModal() {
            const activeProducts = state.products.filter(p => p.active);
            document.getElementById('modalContainer').innerHTML = `
                <div class="modal" onclick="if(event.target===this)closeModal()">
                    <div class="modal-content">
                        <h3>Bulk Stock Update</h3>
                        <p style="color: #718096; margin-bottom: 15px;">Update stock levels for multiple products at once.</p>
                        <form onsubmit="bulkUpdateStock(event)">
                            <div style="max-height: 400px; overflow-y: auto;">
                                <table>
                                    <thead>
                                        <tr><th>SKU</th><th>Name</th><th>Current</th><th>New Stock</th></tr>
                                    </thead>
                                    <tbody>
                                        ${activeProducts.map(p => `
                                            <tr>
                                                <td>${p.sku}</td>
                                                <td>${p.name}</td>
                                                <td class="${p.stock < 10 ? 'low-stock' : ''}">${p.stock}</td>
                                                <td><input type="number" id="stock-${p.id}" value="${p.stock}" min="0" style="width: 80px;"></td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                                <button type="submit" class="btn btn-success">Update All</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        async function bulkUpdateStock(e) {
            e.preventDefault();
            const updates = state.products.filter(p => p.active).map(p => ({
                product_id: p.id,
                stock: parseInt(document.getElementById(`stock-${p.id}`).value) || 0
            }));
            
            try {
                await api('/api/admin/products/bulk-update-stock', {
                    method: 'POST',
                    body: JSON.stringify({ updates })
                });
                closeModal();
                showAlert('Stock levels updated', 'success');
                loadProducts();
                loadStats();
            } catch (err) {
                showAlert(err.message);
            }
        }

        // Inventory - Receive Products with Lot Numbers
        async function loadInventory() {
            try {
                state.products = await api('/api/admin/products');
                state.inventory = await api('/api/admin/inventory-receipts');
                renderInventory();
            } catch (e) {
                showAlert('Failed to load inventory');
            }
        }

        function renderInventory() {
            const activeProducts = state.products.filter(p => p.active);
            const content = document.getElementById('tabContent');
            content.innerHTML = `
                <div class="toolbar">
                    <h3 style="color: #2d3748;">Inventory Management</h3>
                    <button class="btn" onclick="showReceiveInventoryModal()">üì¶ Receive Inventory</button>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div class="card" style="margin-bottom: 0;">
                        <h4 style="margin-bottom: 15px;">Current Stock Levels</h4>
                        <div style="max-height: 300px; overflow-y: auto;">
                            <table>
                                <thead><tr><th>Product</th><th>SKU</th><th>Stock</th></tr></thead>
                                <tbody>
                                    ${activeProducts.map(p => `
                                        <tr>
                                            <td>${p.name}</td>
                                            <td>${p.sku}</td>
                                            <td class="${p.stock < 10 ? 'low-stock' : ''}">${p.stock}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <h4 style="margin-bottom: 15px;">Recent Inventory Receipts</h4>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Date Received</th>
                                <th>Lot Number</th>
                                <th>Product</th>
                                <th>Qty Received</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${state.inventory && state.inventory.length > 0 
                                ? state.inventory.map(r => `
                                    <tr>
                                        <td>${new Date(r.received_date).toLocaleDateString()}</td>
                                        <td><strong>${r.lot_number}</strong></td>
                                        <td>${r.product_name || r.sku}</td>
                                        <td>${r.quantity}</td>
                                        <td>${r.notes || '-'}</td>
                                    </tr>
                                `).join('')
                                : '<tr><td colspan="5" style="text-align: center; color: #718096;">No inventory receipts yet</td></tr>'
                            }
                        </tbody>
                    </table>
                </div>
            `;
        }

        function showReceiveInventoryModal() {
            const activeProducts = state.products.filter(p => p.active);
            const today = new Date().toISOString().split('T')[0];
            
            document.getElementById('modalContainer').innerHTML = `
                <div class="modal" onclick="if(event.target===this)closeModal()">
                    <div class="modal-content">
                        <h3>üì¶ Receive Inventory</h3>
                        <form onsubmit="receiveInventory(event)">
                            <div class="form-group">
                                <label>Product *</label>
                                <select id="receiveProductId" required onchange="generateLotNumber()">
                                    <option value="">Select product...</option>
                                    ${activeProducts.map(p => `<option value="${p.id}" data-sku="${p.sku}">${p.name} (${p.sku})</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Quantity Received *</label>
                                    <input type="number" id="receiveQty" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>Date Received *</label>
                                    <input type="date" id="receiveDate" value="${today}" required onchange="generateLotNumber()">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Lot Number</label>
                                <input type="text" id="receiveLotNumber" placeholder="Auto-generated or enter manually">
                                <small style="color: #718096;">Format: SKU-YYYYMMDD-XXX (auto-generated when you select product and date)</small>
                            </div>
                            <div class="form-group">
                                <label>Notes</label>
                                <textarea id="receiveNotes" rows="2" placeholder="Supplier, invoice #, etc."></textarea>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                                <button type="submit" class="btn btn-success">Receive & Update Stock</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        function generateLotNumber() {
            const productSelect = document.getElementById('receiveProductId');
            const dateInput = document.getElementById('receiveDate');
            const lotInput = document.getElementById('receiveLotNumber');
            
            if (productSelect.value && dateInput.value) {
                const sku = productSelect.options[productSelect.selectedIndex].dataset.sku;
                const dateStr = dateInput.value.replace(/-/g, '');
                const random = Math.floor(Math.random() * 900 + 100); // 3 digit random
                lotInput.value = `${sku}-${dateStr}-${random}`;
            }
        }

        async function receiveInventory(e) {
            e.preventDefault();
            
            const productId = document.getElementById('receiveProductId').value;
            const quantity = parseInt(document.getElementById('receiveQty').value);
            const receivedDate = document.getElementById('receiveDate').value;
            const lotNumber = document.getElementById('receiveLotNumber').value;
            const notes = document.getElementById('receiveNotes').value;
            
            if (!productId || !quantity || !receivedDate) {
                showAlert('Please fill in all required fields');
                return;
            }
            
            try {
                await api('/api/admin/inventory-receipts', {
                    method: 'POST',
                    body: JSON.stringify({
                        product_id: productId,
                        quantity: quantity,
                        received_date: receivedDate,
                        lot_number: lotNumber || null,
                        notes: notes
                    })
                });
                closeModal();
                showAlert(`Received ${quantity} units. Stock updated!`, 'success');
                loadInventory();
                loadStats();
            } catch (err) {
                showAlert(err.message);
            }
        }

        // Orders
        async function loadOrders() {
            try {
                const url = state.orderStatusFilter 
                    ? `/api/admin/orders?status=${state.orderStatusFilter}` 
                    : '/api/admin/orders';
                state.orders = await api(url);
                renderOrders();
            } catch (e) {
                showAlert('Failed to load orders');
            }
        }

        function renderOrders() {
            const content = document.getElementById('tabContent');
            content.innerHTML = `
                <div class="search-bar">
                    <select onchange="state.orderStatusFilter=this.value;loadOrders()">
                        <option value="">All Statuses</option>
                        <option value="pending" ${state.orderStatusFilter==='pending'?'selected':''}>Pending</option>
                        <option value="paid" ${state.orderStatusFilter==='paid'?'selected':''}>Paid</option>
                        <option value="processing" ${state.orderStatusFilter==='processing'?'selected':''}>Processing</option>
                        <option value="shipped" ${state.orderStatusFilter==='shipped'?'selected':''}>Shipped</option>
                        <option value="delivered" ${state.orderStatusFilter==='delivered'?'selected':''}>Delivered</option>
                        <option value="cancelled" ${state.orderStatusFilter==='cancelled'?'selected':''}>Cancelled</option>
                    </select>
                </div>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Order #</th>
                                <th>Customer</th>
                                <th>Items</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${state.orders.map(o => `
                                <tr>
                                    <td><strong>${o.order_number}</strong></td>
                                    <td>${o.full_name || o.customer_name || 'Unknown'}<br><small style="color:#718096;">${o.email || o.customer_email || ''}</small></td>
                                    <td>${o.items ? o.items.length : 0} items</td>
                                    <td>$${parseFloat(o.total || 0).toFixed(2)}</td>
                                    <td><span class="status-badge status-${o.status}">${o.status}</span></td>
                                    <td>${new Date(o.created_at).toLocaleDateString()}</td>
                                    <td class="actions">
                                        <button class="btn btn-small" onclick="showOrderDetailModal(${o.id})">View</button>
                                        <button class="btn btn-secondary btn-small" onclick="showUpdateStatusModal(${o.id})">Status</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function showOrderDetailModal(id) {
            const o = state.orders.find(x => x.id === id);
            if (!o) return;
            
            document.getElementById('modalContainer').innerHTML = `
                <div class="modal" onclick="if(event.target===this)closeModal()">
                    <div class="modal-content">
                        <h3>Order ${o.order_number}</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                            <div>
                                <p><strong>Customer:</strong> ${o.full_name || o.customer_name || 'Unknown'}</p>
                                <p><strong>Email:</strong> ${o.email || o.customer_email || '-'}</p>
                                <p><strong>Phone:</strong> ${o.phone || o.customer_phone || '-'}</p>
                            </div>
                            <div>
                                <p><strong>Status:</strong> <span class="status-badge status-${o.status}">${o.status}</span></p>
                                <p><strong>Delivery:</strong> ${o.delivery_method === 'ship' ? 'üì¶ Ship' : 'üè™ Pickup'}</p>
                                <p><strong>Date:</strong> ${new Date(o.created_at).toLocaleString()}</p>
                                ${o.tracking_number ? `<p><strong>Tracking:</strong> ${o.tracking_number}</p>` : ''}
                            </div>
                        </div>
                        ${o.delivery_method === 'ship' && o.shipping_address ? `
                            <p><strong>Shipping Address:</strong></p>
                            <p style="background: #f7fafc; padding: 10px; border-radius: 6px; margin-bottom: 15px; white-space: pre-line;">${o.shipping_address}</p>
                        ` : ''}
                        <h4 style="margin-bottom: 10px;">Items</h4>
                        <table>
                            <thead><tr><th>Product</th><th>Qty</th><th>Price</th><th>Subtotal</th></tr></thead>
                            <tbody>
                                ${o.items && o.items.length > 0 ? o.items.map(i => `
                                    <tr>
                                        <td>${i.name || i.product_name || 'Unknown'}</td>
                                        <td>${i.quantity}</td>
                                        <td>$${parseFloat(i.unit_price || i.price_each || 0).toFixed(2)}</td>
                                        <td>$${(i.quantity * parseFloat(i.unit_price || i.price_each || 0)).toFixed(2)}</td>
                                    </tr>
                                `).join('') : '<tr><td colspan="4">No items found</td></tr>'}
                            </tbody>
                        </table>
                        <div style="text-align: right; margin-top: 15px;">
                            <p>Subtotal: $${parseFloat(o.subtotal || 0).toFixed(2)}</p>
                            ${parseFloat(o.discount_amount || 0) > 0 ? `<p style="color: #38a169;">Discount: -$${parseFloat(o.discount_amount).toFixed(2)}</p>` : ''}
                            ${parseFloat(o.shipping_cost || 0) > 0 ? `<p>Shipping: $${parseFloat(o.shipping_cost).toFixed(2)}</p>` : ''}
                            <p style="font-size: 1.1rem; font-weight: 600;">Total: $${parseFloat(o.total || 0).toFixed(2)}</p>
                        </div>
                        <div style="margin-top: 20px;">
                            <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function showUpdateStatusModal(id) {
            const o = state.orders.find(x => x.id === id);
            if (!o) return;
            
            document.getElementById('modalContainer').innerHTML = `
                <div class="modal" onclick="if(event.target===this)closeModal()">
                    <div class="modal-content">
                        <h3>Update Status: ${o.order_number}</h3>
                        <form onsubmit="updateOrderStatus(event, ${id})">
                            <div class="form-group">
                                <label>Status</label>
                                <select id="orderStatus">
                                    <option value="pending" ${o.status==='pending'?'selected':''}>Pending</option>
                                    <option value="paid" ${o.status==='paid'?'selected':''}>Paid</option>
                                    <option value="processing" ${o.status==='processing'?'selected':''}>Processing</option>
                                    <option value="shipped" ${o.status==='shipped'?'selected':''}>Shipped</option>
                                    <option value="delivered" ${o.status==='delivered'?'selected':''}>Delivered</option>
                                    <option value="fulfilled" ${o.status==='fulfilled'?'selected':''}>Fulfilled</option>
                                    <option value="cancelled" ${o.status==='cancelled'?'selected':''}>Cancelled</option>
                                    <option value="refunded" ${o.status==='refunded'?'selected':''}>Refunded</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Tracking Number (for shipped orders)</label>
                                <input type="text" id="trackingNumber" value="${o.tracking_number || ''}" placeholder="Enter tracking number">
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                                <button type="submit" class="btn btn-success">Update Status</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        async function updateOrderStatus(e, id) {
            e.preventDefault();
            try {
                await api(`/api/admin/orders/${id}/status`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        status: document.getElementById('orderStatus').value,
                        tracking_number: document.getElementById('trackingNumber').value || null
                    })
                });
                closeModal();
                showAlert('Order status updated', 'success');
                loadOrders();
                loadStats();
            } catch (err) {
                showAlert(err.message);
            }
        }

        // Discount Codes
        async function loadDiscounts() {
            try {
                state.discounts = await api('/api/admin/discount-codes');
                renderDiscounts();
            } catch (e) {
                showAlert('Failed to load discount codes');
            }
        }

        function renderDiscounts() {
            const content = document.getElementById('tabContent');
            content.innerHTML = `
                <div class="toolbar">
                    <button class="btn" onclick="showAddDiscountModal()">+ Add Discount Code</button>
                    <button class="btn btn-secondary" onclick="showDiscountReportModal()">üìä Date Range Report</button>
                </div>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Description</th>
                                <th>Discount</th>
                                <th>Min Order</th>
                                <th>Usage</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${state.discounts.map(d => `
                                <tr class="${!d.active ? 'inactive' : ''}">
                                    <td><strong>${d.code}</strong></td>
                                    <td>${d.description || '-'}</td>
                                    <td>${d.discount_percent > 0 ? `${d.discount_percent}%` : `$${parseFloat(d.discount_amount || 0).toFixed(2)}`}</td>
                                    <td>${d.min_order_amount > 0 ? `$${parseFloat(d.min_order_amount).toFixed(2)}` : '-'}</td>
                                    <td>${d.times_used || 0}${d.usage_limit ? ` / ${d.usage_limit}` : ''}</td>
                                    <td>${d.active ? '<span class="status-badge status-paid">Active</span>' : '<span class="status-badge status-cancelled">Inactive</span>'}</td>
                                    <td class="actions">
                                        <button class="btn btn-small" onclick="showEditDiscountModal(${d.id})">Edit</button>
                                        ${d.active 
                                            ? `<button class="btn btn-warning btn-small" onclick="deactivateDiscount(${d.id})">Deactivate</button>`
                                            : ''
                                        }
                                        ${(d.times_used || 0) === 0
                                            ? `<button class="btn btn-danger btn-small" onclick="permanentlyDeleteDiscount(${d.id})">Delete</button>`
                                            : ''
                                        }
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function showDiscountReportModal() {
            const today = new Date().toISOString().split('T')[0];
            const lastMonth = new Date(Date.now() - 30*24*60*60*1000).toISOString().split('T')[0];
            
            document.getElementById('modalContainer').innerHTML = `
                <div class="modal" onclick="if(event.target===this)closeModal()">
                    <div class="modal-content" style="max-width: 400px;">
                        <h3>Generate Discount Report</h3>
                        <div class="form-group">
                            <label>Start Date</label>
                            <input type="date" id="reportStartDate" value="${lastMonth}">
                        </div>
                        <div class="form-group">
                            <label>End Date</label>
                            <input type="date" id="reportEndDate" value="${today}">
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn" onclick="generateDiscountReport()">Generate Report</button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function generateDiscountReport() {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            
            if (!startDate || !endDate) {
                showAlert('Please select both start and end dates');
                return;
            }
            
            try {
                const report = await api(`/api/admin/discount-codes/report?start_date=${startDate}&end_date=${endDate}`);
                
                const totals = report.totals || {};
                
                document.getElementById('modalContainer').innerHTML = `
                    <div class="modal" onclick="if(event.target===this)closeModal()">
                        <div class="modal-content" style="max-width: 700px;">
                            <h3>Discount Code Report</h3>
                            <p style="color: #718096; margin-bottom: 15px;">${startDate} to ${endDate}</p>
                            
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0;">
                                <div style="background: #edf2f7; padding: 15px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: 600; color: #3182ce;">
                                        ${totals.total_orders_with_discount || 0}
                                    </div>
                                    <div style="font-size: 0.85rem; color: #718096;">Orders with Discounts</div>
                                </div>
                                <div style="background: #edf2f7; padding: 15px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: 600; color: #e53e3e;">
                                        $${parseFloat(totals.total_discount_given || 0).toFixed(2)}
                                    </div>
                                    <div style="font-size: 0.85rem; color: #718096;">Total Discounts Given</div>
                                </div>
                                <div style="background: #edf2f7; padding: 15px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: 600; color: #38a169;">
                                        $${parseFloat(totals.total_revenue || 0).toFixed(2)}
                                    </div>
                                    <div style="font-size: 0.85rem; color: #718096;">Revenue (with discounts)</div>
                                </div>
                            </div>
                            
                            <h4 style="margin-top: 20px;">Usage by Code</h4>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Code</th>
                                        <th>Uses</th>
                                        <th>Discount Given</th>
                                        <th>Revenue Generated</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${report.usage && report.usage.length > 0 
                                        ? report.usage.map(u => `
                                            <tr>
                                                <td><strong>${u.code}</strong></td>
                                                <td>${u.times_used}</td>
                                                <td style="color: #e53e3e;">$${parseFloat(u.total_discount).toFixed(2)}</td>
                                                <td style="color: #38a169;">$${parseFloat(u.total_revenue).toFixed(2)}</td>
                                            </tr>
                                        `).join('')
                                        : '<tr><td colspan="4" style="text-align:center; color:#718096;">No discount usage in this period</td></tr>'
                                    }
                                </tbody>
                            </table>
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                            </div>
                        </div>
                    </div>
                `;
            } catch (err) {
                showAlert(err.message);
            }
        }

        async function deactivateDiscount(id) {
            if (!confirm('Deactivate this discount code?')) return;
            try {
                await api(`/api/admin/discount-codes/${id}`, {
                    method: 'DELETE'
                });
                showAlert('Discount code deactivated', 'success');
                loadDiscounts();
            } catch (err) {
                showAlert(err.message);
            }
        }

        async function permanentlyDeleteDiscount(id) {
            if (!confirm('Permanently delete this discount code? This cannot be undone.')) return;
            try {
                await api(`/api/admin/discount-codes/${id}/permanent`, {
                    method: 'DELETE'
                });
                showAlert('Discount code deleted', 'success');
                loadDiscounts();
            } catch (err) {
                showAlert(err.message);
            }
        }

        function showAddDiscountModal() {
            document.getElementById('modalContainer').innerHTML = `
                <div class="modal" onclick="if(event.target===this)closeModal()">
                    <div class="modal-content">
                        <h3>Add Discount Code</h3>
                        <form onsubmit="addDiscount(event)">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Code *</label>
                                    <input type="text" id="discCode" required style="text-transform: uppercase;">
                                </div>
                                <div class="form-group">
                                    <label>Description</label>
                                    <input type="text" id="discDesc">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Discount %</label>
                                    <input type="number" id="discPercent" step="0.01" value="0">
                                </div>
                                <div class="form-group">
                                    <label>Discount $</label>
                                    <input type="number" id="discAmount" step="0.01" value="0">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Min Order Amount</label>
                                    <input type="number" id="discMinOrder" step="0.01" value="0">
                                </div>
                                <div class="form-group">
                                    <label>Usage Limit (blank = unlimited)</label>
                                    <input type="number" id="discLimit">
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                                <button type="submit" class="btn">Add Code</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        async function addDiscount(e) {
            e.preventDefault();
            try {
                await api('/api/admin/discount-codes', {
                    method: 'POST',
                    body: JSON.stringify({
                        code: document.getElementById('discCode').value.toUpperCase(),
                        description: document.getElementById('discDesc').value,
                        discount_percent: parseFloat(document.getElementById('discPercent').value) || 0,
                        discount_amount: parseFloat(document.getElementById('discAmount').value) || 0,
                        min_order_amount: parseFloat(document.getElementById('discMinOrder').value) || 0,
                        usage_limit: parseInt(document.getElementById('discLimit').value) || null
                    })
                });
                closeModal();
                showAlert('Discount code added', 'success');
                loadDiscounts();
            } catch (err) {
                showAlert(err.message);
            }
        }

        function showEditDiscountModal(id) {
            const d = state.discounts.find(x => x.id === id);
            if (!d) return;
            
            document.getElementById('modalContainer').innerHTML = `
                <div class="modal" onclick="if(event.target===this)closeModal()">
                    <div class="modal-content">
                        <h3>Edit Discount: ${d.code}</h3>
                        <form onsubmit="updateDiscount(event, ${id})">
                            <div class="form-group">
                                <label>Description</label>
                                <input type="text" id="discDesc" value="${d.description || ''}">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Discount %</label>
                                    <input type="number" id="discPercent" step="0.01" value="${d.discount_percent}">
                                </div>
                                <div class="form-group">
                                    <label>Discount $</label>
                                    <input type="number" id="discAmount" step="0.01" value="${d.discount_amount}">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Min Order Amount</label>
                                    <input type="number" id="discMinOrder" step="0.01" value="${d.min_order_amount}">
                                </div>
                                <div class="form-group">
                                    <label>Usage Limit</label>
                                    <input type="number" id="discLimit" value="${d.usage_limit || ''}">
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                                <button type="submit" class="btn">Save Changes</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        async function updateDiscount(e, id) {
            e.preventDefault();
            try {
                await api(`/api/admin/discount-codes/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        description: document.getElementById('discDesc').value,
                        discount_percent: parseFloat(document.getElementById('discPercent').value) || 0,
                        discount_amount: parseFloat(document.getElementById('discAmount').value) || 0,
                        min_order_amount: parseFloat(document.getElementById('discMinOrder').value) || 0,
                        usage_limit: parseInt(document.getElementById('discLimit').value) || null
                    })
                });
                closeModal();
                showAlert('Discount code updated', 'success');
                loadDiscounts();
            } catch (err) {
                showAlert(err.message);
            }
        }

        // Users
        async function loadUsers() {
            try {
                state.users = await api('/api/admin/users');
                if (!Array.isArray(state.users)) {
                    console.error('Invalid users response:', state.users);
                    state.users = [];
                }
                renderUsers();
            } catch (e) {
                console.error('Failed to load users:', e);
                showAlert('Failed to load users: ' + e.message);
                state.users = [];
                renderUsers();
            }
        }

        function renderUsers() {
            const content = document.getElementById('tabContent');
            content.innerHTML = `
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Organization</th>
                                <th>Verified</th>
                                <th>Admin</th>
                                <th>Joined</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${state.users.map(u => `
                                <tr>
                                    <td>${u.full_name}</td>
                                    <td>${u.email}</td>
                                    <td>${u.phone || '-'}</td>
                                    <td>${u.organization || '-'}</td>
                                    <td>${u.email_verified ? '‚úÖ' : '‚ùå'}</td>
                                    <td>${u.is_admin ? 'üëë Yes' : 'No'}</td>
                                    <td>${new Date(u.created_at).toLocaleDateString()}</td>
                                    <td class="actions">
                                        <button class="btn btn-small" onclick="showUserDetailModal(${u.id})">View</button>
                                        <button class="btn btn-secondary btn-small" onclick="showEditUserModal(${u.id})">Edit</button>
                                        ${!u.email_verified ? `<button class="btn btn-success btn-small" onclick="resendVerification(${u.id})">Resend</button>` : ''}
                                        <button class="btn btn-small ${u.is_admin ? 'btn-warning' : 'btn-secondary'}" 
                                            onclick="toggleAdmin(${u.id})">
                                            ${u.is_admin ? 'Remove Admin' : 'Make Admin'}
                                        </button>
                                        ${!u.is_admin ? `<button class="btn btn-danger btn-small" onclick="deleteUser(${u.id})">Delete</button>` : ''}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function showUserDetailModal(id) {
            const u = state.users.find(x => x.id === id);
            if (!u) return;
            
            document.getElementById('modalContainer').innerHTML = `
                <div class="modal" onclick="if(event.target===this)closeModal()">
                    <div class="modal-content">
                        <h3>User Details: ${u.full_name}</h3>
                        <div style="display: grid; gap: 10px; margin: 20px 0;">
                            <p><strong>Email:</strong> ${u.email}</p>
                            <p><strong>Phone:</strong> ${u.phone || '-'}</p>
                            <p><strong>Organization:</strong> ${u.organization || '-'}</p>
                            <p><strong>Country:</strong> ${u.country || '-'}</p>
                            <p><strong>Email Verified:</strong> ${u.email_verified ? 'Yes ‚úÖ' : 'No ‚ùå'}</p>
                            <p><strong>Admin:</strong> ${u.is_admin ? 'Yes üëë' : 'No'}</p>
                            <p><strong>Joined:</strong> ${new Date(u.created_at).toLocaleString()}</p>
                        </div>
                        <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                    </div>
                </div>
            `;
        }

        function showEditUserModal(id) {
            const u = state.users.find(x => x.id === id);
            if (!u) return;
            
            document.getElementById('modalContainer').innerHTML = `
                <div class="modal" onclick="if(event.target===this)closeModal()">
                    <div class="modal-content">
                        <h3>Edit User: ${u.full_name}</h3>
                        <form onsubmit="updateUser(event, ${id})">
                            <div class="form-group">
                                <label>Full Name</label>
                                <input type="text" id="editUserName" value="${u.full_name}" required>
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="editUserEmail" value="${u.email}" required>
                            </div>
                            <div class="form-group">
                                <label>Phone</label>
                                <input type="text" id="editUserPhone" value="${u.phone || ''}">
                            </div>
                            <div class="form-group">
                                <label>Organization</label>
                                <input type="text" id="editUserOrg" value="${u.organization || ''}">
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="editUserVerified" ${u.email_verified ? 'checked' : ''}>
                                    Email Verified
                                </label>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                                <button type="submit" class="btn btn-success">Save Changes</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        async function updateUser(e, id) {
            e.preventDefault();
            try {
                await api(`/api/admin/users/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        full_name: document.getElementById('editUserName').value,
                        email: document.getElementById('editUserEmail').value,
                        phone: document.getElementById('editUserPhone').value,
                        organization: document.getElementById('editUserOrg').value,
                        email_verified: document.getElementById('editUserVerified').checked
                    })
                });
                closeModal();
                showAlert('User updated successfully', 'success');
                loadUsers();
            } catch (err) {
                showAlert(err.message);
            }
        }

        async function deleteUser(id) {
            const user = state.users.find(u => u.id === id);
            if (!confirm(`Are you sure you want to delete user "${user.full_name}"? This cannot be undone.`)) return;
            
            try {
                await api(`/api/admin/users/${id}`, { method: 'DELETE' });
                showAlert('User deleted', 'success');
                loadUsers();
            } catch (err) {
                showAlert(err.message);
            }
        }

        async function toggleAdmin(id) {
            const user = state.users.find(u => u.id === id);
            const action = user.is_admin ? 'remove admin privileges from' : 'grant admin privileges to';
            if (!confirm(`Are you sure you want to ${action} ${user.full_name}?`)) return;
            
            try {
                await api(`/api/admin/users/${id}/toggle-admin`, { method: 'POST' });
                showAlert('User updated', 'success');
                loadUsers();
            } catch (err) {
                showAlert(err.message);
            }
        }

        async function resendVerification(id) {
            const user = state.users.find(u => u.id === id);
            if (!confirm(`Resend verification email to ${user.email}?`)) return;
            
            try {
                await api(`/api/admin/users/${id}/resend-verification`, { method: 'POST' });
                showAlert('Verification email sent!', 'success');
            } catch (err) {
                showAlert(err.message);
            }
        }

        // Notifications
        async function loadNotifications() {
            try {
                state.notifications = await api('/api/admin/notifications');
                renderNotifications();
            } catch (e) {
                showAlert('Failed to load notifications');
            }
        }

        function renderNotifications() {
            const content = document.getElementById('tabContent');
            content.innerHTML = `
                <p style="color: #718096; margin-bottom: 15px;">Last 100 notification attempts</p>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Channel</th>
                                <th>Recipient</th>
                                <th>Status</th>
                                <th>Sent At</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${state.notifications.map(n => `
                                <tr>
                                    <td>${n.notification_type}</td>
                                    <td>${n.channel}</td>
                                    <td>${n.recipient}</td>
                                    <td><span class="status-badge status-${n.status === 'sent' ? 'paid' : 'cancelled'}">${n.status}</span></td>
                                    <td>${new Date(n.sent_at).toLocaleString()}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Open Orders
        async function loadOpenOrders() {
            try {
                state.orders = await api('/api/admin/orders');
                renderOpenOrders();
            } catch (e) {
                showAlert('Failed to load orders');
            }
        }

        function renderOpenOrders() {
            const openOrders = state.orders.filter(o => 
                !['fulfilled', 'delivered', 'cancelled', 'refunded'].includes(o.status)
            );
            
            const content = document.getElementById('tabContent');
            content.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <h3 style="color: #2d3748;">Open Orders (${openOrders.length})</h3>
                    <p style="color: #718096; font-size: 0.9rem;">Orders that need to be fulfilled</p>
                </div>
                ${openOrders.length === 0 ? '<p style="text-align: center; color: #718096; padding: 40px;">üéâ No open orders! All caught up.</p>' : `
                    <div style="overflow-x: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Order #</th>
                                    <th>Customer</th>
                                    <th>Items</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${openOrders.map(o => `
                                    <tr>
                                        <td><strong>${o.order_number}</strong></td>
                                        <td>${o.full_name || o.customer_name || 'Unknown'}<br><small style="color:#718096;">${o.email || o.customer_email || ''}</small></td>
                                        <td>${o.items ? o.items.length : 0} items</td>
                                        <td>$${parseFloat(o.total || 0).toFixed(2)}</td>
                                        <td><span class="status-badge status-${o.status}">${o.status}</span></td>
                                        <td>${new Date(o.created_at).toLocaleDateString()}</td>
                                        <td class="actions">
                                            <button class="btn btn-small" onclick="showOpenOrderDetailModal(${o.id})">View</button>
                                            <button class="btn btn-success btn-small" onclick="markOrderFulfilled(${o.id})">‚úì Complete</button>
                                            <button class="btn btn-danger btn-small" onclick="cancelOrder(${o.id})">‚úó Cancel</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `}
            `;
        }

        function showOpenOrderDetailModal(id) {
            const o = state.orders.find(x => x.id === id);
            if (!o) return;
            
            document.getElementById('modalContainer').innerHTML = `
                <div class="modal" onclick="if(event.target===this)closeModal()">
                    <div class="modal-content">
                        <h3>Order ${o.order_number}</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                            <div>
                                <p><strong>Customer:</strong> ${o.full_name || o.customer_name || 'Unknown'}</p>
                                <p><strong>Email:</strong> ${o.email || o.customer_email || '-'}</p>
                                <p><strong>Phone:</strong> ${o.phone || o.customer_phone || '-'}</p>
                            </div>
                            <div>
                                <p><strong>Status:</strong> <span class="status-badge status-${o.status}">${o.status}</span></p>
                                <p><strong>Date:</strong> ${new Date(o.created_at).toLocaleString()}</p>
                            </div>
                        </div>
                        ${o.shipping_address ? `
                            <p><strong>Shipping Address:</strong></p>
                            <p style="background: #f7fafc; padding: 10px; border-radius: 6px; margin-bottom: 15px; white-space: pre-line;">${o.shipping_address}</p>
                        ` : ''}
                        <h4 style="margin-bottom: 10px;">Items to Ship</h4>
                        <table>
                            <thead><tr><th>Product</th><th>SKU</th><th>Qty</th><th>Price</th></tr></thead>
                            <tbody>
                                ${o.items && o.items.length > 0 ? o.items.map(i => `
                                    <tr>
                                        <td>${i.name || i.product_name || 'Unknown'}</td>
                                        <td>${i.sku || '-'}</td>
                                        <td><strong>${i.quantity}</strong></td>
                                        <td>$${parseFloat(i.unit_price || i.price_each || 0).toFixed(2)}</td>
                                    </tr>
                                `).join('') : '<tr><td colspan="4">No items found</td></tr>'}
                            </tbody>
                        </table>
                        <div style="text-align: right; margin-top: 15px;">
                            <p style="font-size: 1.1rem; font-weight: 600;">Total: $${parseFloat(o.total || 0).toFixed(2)}</p>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                            <button class="btn btn-success" onclick="markOrderFulfilled(${o.id}); closeModal();">‚úì Mark as Fulfilled</button>
                            <button class="btn btn-danger" onclick="cancelOrder(${o.id}); closeModal();">‚úó Cancel Order</button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function markOrderFulfilled(id) {
            if (!confirm('Mark this order as fulfilled?')) return;
            try {
                await api(`/api/admin/orders/${id}/status`, {
                    method: 'PUT',
                    body: JSON.stringify({ status: 'fulfilled' })
                });
                showAlert('Order marked as fulfilled!', 'success');
                loadOpenOrders();
            } catch (err) {
                showAlert(err.message);
            }
        }

        async function cancelOrder(id) {
            if (!confirm('Are you sure you want to cancel this order? This will remove it from revenue calculations.')) return;
            try {
                await api(`/api/admin/orders/${id}/status`, {
                    method: 'PUT',
                    body: JSON.stringify({ status: 'cancelled' })
                });
                showAlert('Order cancelled!', 'success');
                loadOpenOrders();
                loadStats();
            } catch (err) {
                showAlert(err.message);
            }
        }

        // Reports
        async function renderReports() {
            const content = document.getElementById('tabContent');
            content.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div class="card" style="margin-bottom: 0;">
                        <h3 style="margin-bottom: 15px;">üìä Discount Code Report</h3>
                        <p style="color: #718096; margin-bottom: 15px;">Sales breakdown by discount code</p>
                        <button class="btn" onclick="loadDiscountReport()">Generate Report</button>
                        <div id="discountReportContent" style="margin-top: 20px;"></div>
                    </div>
                    <div class="card" style="margin-bottom: 0;">
                        <h3 style="margin-bottom: 15px;">üì¶ Order Summary</h3>
                        <p style="color: #718096; margin-bottom: 15px;">Overview of order statuses</p>
                        <button class="btn" onclick="loadOrderSummary()">Generate Report</button>
                        <div id="orderSummaryContent" style="margin-top: 20px;"></div>
                    </div>
                </div>
            `;
        }

        async function loadDiscountReport() {
            try {
                const report = await api('/api/admin/reports/discounts');
                const container = document.getElementById('discountReportContent');
                
                if (report.length === 0) {
                    container.innerHTML = '<p style="color: #718096;">No discount codes have been used yet.</p>';
                    return;
                }
                
                const totalRevenue = report.reduce((sum, r) => sum + r.total_sales, 0);
                const totalOrders = report.reduce((sum, r) => sum + r.order_count, 0);
                const totalDiscount = report.reduce((sum, r) => sum + r.total_discounted, 0);
                
                container.innerHTML = `
                    <div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; text-align: center;">
                            <div>
                                <div style="font-size: 1.5rem; font-weight: 600; color: #2b6cb0;">$${totalRevenue.toFixed(2)}</div>
                                <div style="font-size: 0.8rem; color: #718096;">Total Sales</div>
                            </div>
                            <div>
                                <div style="font-size: 1.5rem; font-weight: 600; color: #38a169;">${totalOrders}</div>
                                <div style="font-size: 0.8rem; color: #718096;">Orders</div>
                            </div>
                            <div>
                                <div style="font-size: 1.5rem; font-weight: 600; color: #e53e3e;">$${totalDiscount.toFixed(2)}</div>
                                <div style="font-size: 0.8rem; color: #718096;">Discounts Given</div>
                            </div>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Orders</th>
                                <th>Total Sales</th>
                                <th>Discounts Given</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${report.map(r => `
                                <tr>
                                    <td><strong>${r.code}</strong></td>
                                    <td>${r.order_count}</td>
                                    <td>$${r.total_sales.toFixed(2)}</td>
                                    <td style="color: #e53e3e;">-$${r.total_discounted.toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (err) {
                document.getElementById('discountReportContent').innerHTML = `<p style="color: #e53e3e;">Error: ${err.message}</p>`;
            }
        }

        async function loadOrderSummary() {
            try {
                const orders = await api('/api/admin/orders');
                const container = document.getElementById('orderSummaryContent');
                
                const statusCounts = {};
                const statusTotals = {};
                orders.forEach(o => {
                    statusCounts[o.status] = (statusCounts[o.status] || 0) + 1;
                    statusTotals[o.status] = (statusTotals[o.status] || 0) + parseFloat(o.total || 0);
                });
                
                const statuses = Object.keys(statusCounts).sort();
                const totalOrders = orders.length;
                const totalRevenue = orders.reduce((sum, o) => sum + parseFloat(o.total || 0), 0);
                
                container.innerHTML = `
                    <div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; text-align: center;">
                            <div>
                                <div style="font-size: 1.5rem; font-weight: 600; color: #2b6cb0;">${totalOrders}</div>
                                <div style="font-size: 0.8rem; color: #718096;">Total Orders</div>
                            </div>
                            <div>
                                <div style="font-size: 1.5rem; font-weight: 600; color: #38a169;">$${totalRevenue.toFixed(2)}</div>
                                <div style="font-size: 0.8rem; color: #718096;">Total Revenue</div>
                            </div>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Status</th>
                                <th>Count</th>
                                <th>Total Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${statuses.map(status => `
                                <tr>
                                    <td><span class="status-badge status-${status}">${status}</span></td>
                                    <td>${statusCounts[status]}</td>
                                    <td>$${statusTotals[status].toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (err) {
                document.getElementById('orderSummaryContent').innerHTML = `<p style="color: #e53e3e;">Error: ${err.message}</p>`;
            }
        }

        async function logout() {
            try {
                await api('/api/logout', { method: 'POST' });
            } catch (e) {}
            window.location.href = '/';
        }

        function closeModal() {
            document.getElementById('modalContainer').innerHTML = '';
        }

        init();
    </script>
</body>
</html>
