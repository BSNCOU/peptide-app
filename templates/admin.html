<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Research Materials</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f7fa; color: #333; line-height: 1.6; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        header { background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%); color: white; padding: 15px 0; margin-bottom: 30px; }
        header .container { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        header h1 { font-size: 1.4rem; }
        .header-nav { display: flex; gap: 10px; flex-wrap: wrap; }
        .header-nav button { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; }
        .header-nav button:hover { background: rgba(255,255,255,0.2); }
        .card { background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); padding: 25px; margin-bottom: 20px; }
        .card h2 { color: #1a202c; margin-bottom: 20px; font-size: 1.2rem; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); text-align: center; }
        .stat-card h3 { font-size: 2rem; color: #2b6cb0; margin-bottom: 5px; }
        .stat-card p { color: #718096; font-size: 0.9rem; }
        .stat-card.warning { border-left: 4px solid #ed8936; }
        .stat-card.danger { border-left: 4px solid #e53e3e; }
        .tabs { display: flex; border-bottom: 2px solid #e2e8f0; margin-bottom: 20px; overflow-x: auto; }
        .tabs button { background: none; border: none; padding: 12px 20px; cursor: pointer; font-size: 0.95rem; color: #718096; border-bottom: 2px solid transparent; margin-bottom: -2px; white-space: nowrap; }
        .tabs button.active { color: #2b6cb0; border-bottom-color: #4299e1; }
        .tabs button:hover { color: #2b6cb0; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        th { background: #f7fafc; font-weight: 600; color: #4a5568; font-size: 0.85rem; text-transform: uppercase; }
        tr:hover { background: #f7fafc; }
        .btn { background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s; }
        .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(66,153,225,0.3); }
        .btn:disabled { background: #a0aec0; cursor: not-allowed; transform: none; }
        .btn-small { padding: 5px 10px; font-size: 0.8rem; }
        .btn-secondary { background: linear-gradient(135deg, #718096 0%, #4a5568 100%); }
        .btn-success { background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); }
        .btn-danger { background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%); }
        .btn-warning { background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; color: #4a5568; font-size: 0.9rem; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 0.95rem; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #4299e1; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .alert { padding: 12px 16px; border-radius: 8px; margin-bottom: 15px; }
        .alert-error { background: #fed7d7; color: #c53030; }
        .alert-success { background: #c6f6d5; color: #276749; }
        .alert-warning { background: #fefcbf; color: #975a16; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; border-radius: 12px; padding: 25px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-content h3 { margin-bottom: 20px; }
        .status-badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 500; }
        .status-pending { background: #fefcbf; color: #975a16; }
        .status-paid { background: #c6f6d5; color: #276749; }
        .status-processing { background: #bee3f8; color: #2b6cb0; }
        .status-shipped { background: #e9d8fd; color: #6b46c1; }
        .status-delivered { background: #c6f6d5; color: #276749; }
        .status-fulfilled { background: #c6f6d5; color: #276749; }
        .status-cancelled { background: #fed7d7; color: #c53030; }
        .status-refunded { background: #feebc8; color: #c05621; }
        .low-stock { color: #e53e3e; font-weight: 600; }
        .inactive { opacity: 0.5; }
        .search-bar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .search-bar input, .search-bar select { padding: 10px; border: 2px solid #e2e8f0; border-radius: 6px; }
        .search-bar input { flex: 1; min-width: 200px; }
        .hidden { display: none !important; }
        .actions { display: flex; gap: 5px; flex-wrap: wrap; }
        .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .notification-item { padding: 12px; border-bottom: 1px solid #e2e8f0; }
        .notification-item:last-child { border-bottom: none; }
        .notification-item .meta { font-size: 0.85rem; color: #718096; margin-top: 5px; }
        .bulk-actions { background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        /* Returns styles */
        .return-card-admin { background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; margin-bottom: 15px; }
        .return-card-admin.pending { border-left: 4px solid #ed8936; }
        .return-card-admin.approved { border-left: 4px solid #48bb78; }
        .return-card-admin.denied { border-left: 4px solid #e53e3e; }
        .return-card-admin.refund_pending { border-left: 4px solid #4299e1; }
        .return-card-admin.refunded { border-left: 4px solid #48bb78; }
        .return-card-admin.replacement_pending { border-left: 4px solid #9f7aea; }
        .return-status-admin { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 500; }
        .return-status-admin.pending { background: #fefcbf; color: #975a16; }
        .return-status-admin.approved { background: #c6f6d5; color: #276749; }
        .return-status-admin.denied { background: #fed7d7; color: #c53030; }
        .return-status-admin.refund_pending { background: #bee3f8; color: #2b6cb0; }
        .return-status-admin.refunded { background: #c6f6d5; color: #276749; }
        .return-status-admin.replacement_pending { background: #e9d8fd; color: #6b46c1; }
        .process-form { background: #f7fafc; border-radius: 8px; padding: 20px; margin-top: 15px; }
        @media (max-width: 768px) {
            table { font-size: 0.85rem; }
            th, td { padding: 8px; }
            .actions { flex-direction: column; }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>üìä Admin Dashboard</h1>
            <div class="header-nav">
                <button onclick="window.location.href='/'">‚Üê Customer Site</button>
                <button onclick="logout()">Logout</button>
            </div>
        </div>
    </header>

    <div class="container">
        <div id="alertContainer"></div>
        <div id="statsContainer"></div>
        
        <div class="card">
            <div class="tabs">
                <button class="active" onclick="showTab('products')">Products</button>
                <button onclick="showTab('inventory')">Inventory</button>
                <button onclick="showTab('orders')">All Orders</button>
                <button onclick="showTab('openOrders')">Open Orders</button>
                <button onclick="showTab('purchaseOrders')">üì¶ Purchase Orders</button>
                <button onclick="showTab('returns')">üîÑ Returns</button>
                <button onclick="showTab('discounts')">Discount Codes</button>
                <button onclick="showTab('reports')">Reports</button>
                <button onclick="showTab('users')">Users</button>
                <button onclick="showTab('email')">üìß Email</button>
                <button onclick="showTab('notifications')">Notifications</button>
            </div>
            <div id="tabContent"></div>
        </div>
    </div>

    <div id="modalContainer"></div>

    <script>
        let state = {
            csrfToken: null,
            stats: null,
            products: [],
            orders: [],
            discounts: [],
            users: [],
            notifications: [],
            inventory: [],
            currentTab: 'products',
            orderStatusFilter: '',
            showInactiveProducts: false,
            currentReferrerReport: null,
            returns: [],
            returnsFilter: '',
            purchaseOrders: [],
            currentPO: null,
            poFilter: ''
        };
        
        // Global HTML escape helper
        function escapeHtml(str) {
            if (!str) return '';
            return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        }

        async function api(endpoint, options = {}) {
            const headers = { 'Content-Type': 'application/json' };
            if (state.csrfToken && ['POST', 'PUT', 'DELETE'].includes(options.method)) {
                headers['X-CSRF-Token'] = state.csrfToken;
            }
            const res = await fetch(endpoint, { ...options, headers, credentials: 'same-origin' });
            const data = await res.json();
            if (!res.ok) throw new Error(data.error || 'Request failed');
            return data;
        }

        function showAlert(message, type = 'error') {
            const container = document.getElementById('alertContainer');
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }

        async function init() {
            try {
                const tokenRes = await api('/api/csrf-token');
                state.csrfToken = tokenRes.token;
            } catch (e) { console.error('CSRF error:', e); }

            try {
                await api('/api/me');
            } catch (e) {
                window.location.href = '/';
                return;
            }

            await loadStats();
            showTab('products');
        }

        async function loadStats() {
            try {
                state.stats = await api('/api/admin/stats');
                renderStats();
            } catch (e) {
                showAlert('Failed to load stats');
            }
        }

        function renderStats() {
            const s = state.stats;
            const lowStockCount = s.low_stock_items?.length || 0;
            
            document.getElementById('statsContainer').innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>${s.total_orders || 0}</h3>
                        <p>Total Orders</p>
                    </div>
                    <div class="stat-card">
                        <h3>$${(s.total_revenue || 0).toFixed(2)}</h3>
                        <p>Total Revenue</p>
                    </div>
                    <div class="stat-card">
                        <h3>${s.total_users || 0}</h3>
                        <p>Registered Users</p>
                    </div>
                    <div class="stat-card">
                        <h3>${s.total_products || 0}</h3>
                        <p>Products</p>
                    </div>
                    <div class="stat-card ${lowStockCount > 0 ? 'danger' : ''}">
                        <h3>${lowStockCount}</h3>
                        <p>Low Stock Items</p>
                    </div>
                </div>
                ${lowStockCount > 0 ? `
                    <div class="alert alert-warning">
                        <strong>‚ö†Ô∏è Low Stock Alert:</strong> 
                        ${s.low_stock_items.map(i => `${i.sku} (${i.stock}/${i.reorder_qty * 10})`).join(', ')}
                    </div>
                ` : ''}
            `;
        }

        function showTab(tab) {
            state.currentTab = tab;
            document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
            const tabList = ['products','inventory','orders','openOrders','purchaseOrders','returns','discounts','reports','users','email','notifications'];
            document.querySelector(`.tabs button:nth-child(${tabList.indexOf(tab)+1})`).classList.add('active');
            
            switch(tab) {
                case 'products': loadProducts(); break;
                case 'inventory': loadInventory(); break;
                case 'orders': loadOrders(); break;
                case 'openOrders': loadOpenOrders(); break;
                case 'purchaseOrders': loadPurchaseOrders(); break;
                case 'returns': loadReturns(); break;
                case 'discounts': loadDiscounts(); break;
                case 'reports': renderReports(); break;
                case 'users': loadUsers(); break;
                case 'email': loadEmail(); break;
                case 'notifications': loadNotifications(); break;
            }
        }

        // Products
        async function loadProducts() {
            try {
                state.products = await api('/api/admin/products');
                renderProducts();
            } catch (e) {
                showAlert('Failed to load products');
            }
        }

        function renderProducts() {
            const content = document.getElementById('tabContent');
            // Handle NULL active field - treat as active
            const activeProducts = state.products.filter(p => p.active === 1 || p.active === true || p.active === null || p.active === undefined);
            const inactiveProducts = state.products.filter(p => p.active === 0 || p.active === false);
            const showInactive = state.showInactiveProducts || false;
            const displayProducts = showInactive ? state.products : activeProducts;
            
            content.innerHTML = `
                <div class="toolbar" style="justify-content: flex-start;">
                    <button class="btn" onclick="showAddProductModal()">+ Add Product</button>
                    <button class="btn btn-secondary" onclick="showBulkStockModal()">üì¶ Bulk Stock Update</button>
                    <button class="btn btn-secondary" onclick="showBulkCostsModal()">üí∞ Upload Costs</button>
                    <button class="btn btn-secondary" onclick="showPdfImportModal()">üìÑ Import PDF</button>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 10px; background: #f7fafc; border-radius: 6px;">
                    <span style="color: #4a5568; font-size: 0.9rem;">
                        <strong>${activeProducts.length}</strong> active products${inactiveProducts.length > 0 ? `, <strong style="color: #e53e3e;">${inactiveProducts.length}</strong> inactive` : ''}
                    </span>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; ${inactiveProducts.length > 0 ? 'background: #fef3c7;' : 'background: #edf2f7;'} padding: 6px 12px; border-radius: 4px;">
                        <input type="checkbox" ${showInactive ? 'checked' : ''} onchange="toggleInactiveProducts(this.checked)" style="width: 16px; height: 16px;">
                        <span style="font-size: 0.9rem; font-weight: 500;">Show Inactive (${inactiveProducts.length})</span>
                    </label>
                </div>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>SKU</th>
                                <th>Name</th>
                                <th>Price</th>
                                <th>Cost</th>
                                <th>Margin</th>
                                <th>Stock</th>
                                <th>Reorder</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${displayProducts.map(p => {
                                const margin = p.cost > 0 ? ((p.price_single - p.cost) / p.price_single * 100).toFixed(0) : '-';
                                const marginClass = p.cost > 0 ? (margin < 20 ? 'low-stock' : margin < 40 ? '' : 'status-paid') : '';
                                const reorderQty = p.reorder_qty !== null && p.reorder_qty !== undefined ? p.reorder_qty : 4;
                                const minUnits = reorderQty * 10;
                                const needsReorder = reorderQty > 0 && p.stock < minUnits;
                                const isActive = p.active === 1 || p.active === true || p.active === null || p.active === undefined;
                                
                                // Check if on sale
                                const now = new Date();
                                let isOnSale = false;
                                if (p.sale_price && p.sale_price > 0) {
                                    const saleStart = p.sale_start ? new Date(p.sale_start) : null;
                                    const saleEnd = p.sale_end ? new Date(p.sale_end) : null;
                                    const startOk = !saleStart || now >= saleStart;
                                    const endOk = !saleEnd || now <= saleEnd;
                                    isOnSale = startOk && endOk;
                                }
                                
                                return `
                                <tr class="${!isActive ? 'inactive' : ''}" style="${!isActive ? 'background: #fff5f5;' : isOnSale ? 'background: #fffaf0;' : ''}">
                                    <td>${escapeHtml(p.sku)} ${isOnSale ? '<span style="background:#e53e3e;color:white;padding:2px 5px;border-radius:3px;font-size:0.7rem;">SALE</span>' : ''}</td>
                                    <td>${escapeHtml(p.name)}</td>
                                    <td>
                                        ${isOnSale 
                                            ? '<span style="text-decoration:line-through;color:#a0aec0;">$' + p.price_single.toFixed(2) + '</span> <strong style="color:#e53e3e;">$' + p.sale_price.toFixed(2) + '</strong>'
                                            : '$' + p.price_single.toFixed(2) + (p.price_bulk ? ' / $' + p.price_bulk.toFixed(2) : '')
                                        }
                                    </td>
                                    <td>${p.cost > 0 ? '$' + p.cost.toFixed(2) : '<span style="color:#a0aec0">-</span>'}</td>
                                    <td><span class="${marginClass}">${margin}${margin !== '-' ? '%' : ''}</span></td>
                                    <td class="${p.stock < 10 ? 'low-stock' : ''}">${p.stock}</td>
                                    <td>${reorderQty > 0 ? reorderQty + ' boxes' : '<span style="color:#a0aec0">-</span>'}${needsReorder ? ' ‚ö†Ô∏è' : ''}</td>
                                    <td>${isActive ? '<span class="status-badge status-paid">Active</span>' : '<span class="status-badge status-cancelled">Inactive</span>'}</td>
                                    <td class="actions">
                                        <button class="btn btn-small" onclick="showEditProductModal(${p.id})">Edit</button>
                                        ${isActive 
                                            ? '<button class="btn btn-danger btn-small" onclick="deleteProduct(' + p.id + ')">Deactivate</button>'
                                            : '<button class="btn btn-success btn-small" onclick="restoreProduct(' + p.id + ')">Restore</button>'
                                        }
                                    </td>
                                </tr>
                            `}).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function toggleInactiveProducts(show) {
            state.showInactiveProducts = show;
            renderProducts();
        }

        function showAddProductModal() {
            document.getElementById('modalContainer').innerHTML = `
                <div class="modal" onclick="if(event.target===this)closeModal()">
                    <div class="modal-content">
                        <h3>Add New Product</h3>
                        <form onsubmit="addProduct(event)">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>SKU *</label>
                                    <input type="text" id="prodSku" required>
                                </div>
                                <div class="form-group">
                                    <label>Name *</label>
                                    <input type="text" id="prodName" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Description</label>
                                <textarea id="prodDesc" rows="2"></textarea>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Single Price *</label>
                                    <input type="number" id="prodPrice" step="0.01" required>
                                </div>
                                <div class="form-group">
                                    <label>Bulk Price</label>
                                    <input type="number" id="prodBulkPrice" step="0.01">
                                </div>
                                <div class="form-group">
                                    <label>Bulk Qty</label>
                                    <input type="number" id="prodBulkQty" value="10">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Your Cost (per unit)</label>
                                    <input type="number" id="prodCost" step="0.01" value="0">
                                </div>
                                <div class="form-group">
                                    <label>Reorder Qty (boxes)</label>
                                    <input type="number" id="prodReorderQty" value="4" min="0">
                                    <small style="color: #718096;">0 = don't reorder</small>
                                </div>
                                <div class="form-group">
                                    <label>Stock *</label>
                                    <input type="number" id="prodStock" required value="0">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Category</label>
                                    <input type="text" id="prodCategory">
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                                <button type="submit" class="btn">Add Product</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        async function addProduct(e) {
            e.preventDefault();
            try {
                await api('/api/admin/products', {
                    method: 'POST',
                    body: JSON.stringify({
                        sku: document.getElementById('prodSku').value,
                        name: document.getElementById('prodName').value,
                        description: document.getElementById('prodDesc').value,
                        price_single: parseFloat(document.getElementById('prodPrice').value),
                        price_bulk: parseFloat(document.getElementById('prodBulkPrice').value) || null,
                        bulk_quantity: parseInt(document.getElementById('prodBulkQty').value) || 10,
                        category: document.getElementById('prodCategory').value,
                        stock: parseInt(document.getElementById('prodStock').value),
                        cost: parseFloat(document.getElementById('prodCost').value) || 0,
                        reorder_qty: parseInt(document.getElementById('prodReorderQty').value) || 4
                    })
                });
                closeModal();
                showAlert('Product added successfully', 'success');
                loadProducts();
            } catch (err) {
                showAlert(err.message);
            }
        }

        function showEditProductModal(id) {
            const p = state.products.find(x => x.id === id);
            if (!p) return;
            
            // Calculate margin if cost is set
            const margin = p.cost > 0 ? ((p.price_single - p.cost) / p.price_single * 100).toFixed(1) : 'N/A';
            const reorderQty = p.reorder_qty !== null && p.reorder_qty !== undefined ? p.reorder_qty : 4;
            
            // Format dates for input fields
            const saleStart = p.sale_start ? p.sale_start.split('T')[0] : '';
            const saleEnd = p.sale_end ? p.sale_end.split('T')[0] : '';
            const isOnSale = p.sale_price && p.sale_price > 0;
            
            document.getElementById('modalContainer').innerHTML = `
                <div class="modal" onclick="if(event.target===this)closeModal()">
                    <div class="modal-content" style="max-width: 600px;">
                        <h3>Edit Product: ${escapeHtml(p.name)}</h3>
                        <form onsubmit="updateProduct(event, ${id})">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>SKU</label>
                                    <input type="text" id="prodSku" value="${escapeHtml(p.sku)}" readonly style="background: #f7fafc;">
                                </div>
                                <div class="form-group">
                                    <label>Name *</label>
                                    <input type="text" id="prodName" value="${escapeHtml(p.name)}" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Description</label>
                                <textarea id="prodDesc" rows="2">${escapeHtml(p.description || '')}</textarea>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Single Price *</label>
                                    <input type="number" id="prodPrice" step="0.01" value="${p.price_single}" required>
                                </div>
                                <div class="form-group">
                                    <label>Bulk Price</label>
                                    <input type="number" id="prodBulkPrice" step="0.01" value="${p.price_bulk || ''}">
                                </div>
                                <div class="form-group">
                                    <label>Bulk Qty</label>
                                    <input type="number" id="prodBulkQty" value="${p.bulk_quantity || 10}">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Your Cost (per unit)</label>
                                    <input type="number" id="prodCost" step="0.01" value="${p.cost || 0}">
                                    <small style="color: #718096;">Margin: ${margin}%</small>
                                </div>
                                <div class="form-group">
                                    <label>Reorder Qty (packs)</label>
                                    <input type="number" id="prodReorderQty" value="${reorderQty}" min="0">
                                    <small style="color: #718096;">0 = don't reorder</small>
                                </div>
                                <div class="form-group">
                                    <label>Pack Size (units/pack)</label>
                                    <input type="number" id="prodPackSize" value="${p.supplier_pack_size || 1}" min="1">
                                    <small style="color: #718096;">Units per supplier pack</small>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Stock *</label>
                                    <input type="number" id="prodStock" value="${p.stock}" required>
                                </div>
                                <div class="form-group">
                                    <label>Category</label>
                                    <input type="text" id="prodCategory" value="${escapeHtml(p.category || '')}">
                                </div>
                            </div>
                            
                            <div style="background: ${isOnSale ? '#fef3c7' : '#f0fff4'}; padding: 15px; border-radius: 8px; margin-top: 15px; border: 2px solid ${isOnSale ? '#f59e0b' : '#c6f6d5'};">
                                <h4 style="margin-bottom: 10px; color: ${isOnSale ? '#d97706' : '#276749'};">üè∑Ô∏è Sale Settings ${isOnSale ? '(ACTIVE)' : ''}</h4>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Sale Price (per bottle)</label>
                                        <input type="number" id="prodSalePrice" step="0.01" value="${p.sale_price || ''}" placeholder="Leave blank for no sale">
                                        <small style="color: #718096;">Price per unit when on sale</small>
                                    </div>
                                    <div class="form-group">
                                        <label>Min Qty for Sale</label>
                                        <input type="number" id="prodSaleMinQty" value="${p.sale_min_qty || 1}" min="1">
                                        <small style="color: #718096;">Customer must buy this many to get sale price</small>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Sale Starts</label>
                                        <input type="date" id="prodSaleStart" value="${saleStart}">
                                        <small style="color: #718096;">Leave blank for immediate</small>
                                    </div>
                                    <div class="form-group">
                                        <label>Sale Ends</label>
                                        <input type="date" id="prodSaleEnd" value="${saleEnd}">
                                        <small style="color: #718096;">Leave blank for no end date</small>
                                    </div>
                                </div>
                                ${isOnSale ? '<p style="color: #d97706; font-weight: 600; margin-top: 10px;">‚ö†Ô∏è This product is currently on sale!</p>' : ''}
                            </div>
                            
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                                <button type="submit" class="btn">Save Changes</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        async function updateProduct(e, id) {
            e.preventDefault();
            try {
                await api('/api/admin/products/' + id, {
                    method: 'PUT',
                    body: JSON.stringify({
                        sku: document.getElementById('prodSku').value,
                        name: document.getElementById('prodName').value,
                        description: document.getElementById('prodDesc').value,
                        price_single: parseFloat(document.getElementById('prodPrice').value),
                        price_bulk: parseFloat(document.getElementById('prodBulkPrice').value) || null,
                        bulk_quantity: parseInt(document.getElementById('prodBulkQty').value) || 10,
                        category: document.getElementById('prodCategory').value,
                        stock: parseInt(document.getElementById('prodStock').value),
                        cost: parseFloat(document.getElementById('prodCost').value) || 0,
                        reorder_qty: parseInt(document.getElementById('prodReorderQty').value) || 0,
                        supplier_pack_size: parseInt(document.getElementById('prodPackSize').value) || 1,
                        sale_price: parseFloat(document.getElementById('prodSalePrice').value) || null,
                        sale_min_qty: parseInt(document.getElementById('prodSaleMinQty').value) || 1,
                        sale_start: document.getElementById('prodSaleStart').value || null,
                        sale_end: document.getElementById('prodSaleEnd').value || null
                    })
                });
                closeModal();
                showAlert('Product updated successfully', 'success');
                loadProducts();
                loadStats();
            } catch (err) {
                showAlert(err.message);
            }
        }

        async function deleteProduct(id) {
            const product = state.products.find(p => p.id === id);
            const productName = product ? product.name : 'this product';
            if (!confirm(`‚ö†Ô∏è DEACTIVATE PRODUCT\n\nAre you sure you want to deactivate "${productName}"?\n\nThis will:\n‚Ä¢ Hide it from the store\n‚Ä¢ Keep all order history\n‚Ä¢ You can restore it later via "Show Inactive" checkbox`)) return;
            try {
                await api(`/api/admin/products/${id}`, { method: 'DELETE' });
                showAlert('Product deactivated. Check "Show Inactive" to restore.', 'success');
                loadProducts();
            } catch (err) {
                showAlert(err.message);
            }
        }

        async function restoreProduct(id) {
            try {
                await api(`/api/admin/products/${id}/restore`, { method: 'POST' });
                showAlert('Product restored', 'success');
                loadProducts();
            } catch (err) {
                showAlert(err.message);
            }
        }

        function showBulkStockModal() {
            const activeProducts = state.products.filter(p => p.active);
            document.getElementById('modalContainer').innerHTML = `
                <div class="modal" onclick="if(event.target===this)closeModal()">
                    <div class="modal-content">
                        <h3>Bulk Stock Update</h3>
                        <p style="color: #718096; margin-bottom: 15px;">Update stock levels for multiple products at once.</p>
                        <form onsubmit="bulkUpdateStock(event)">
                            <div style="max-height: 400px; overflow-y: auto;">
                                <table>
                                    <thead>
                                        <tr><th>SKU</th><th>Name</th><th>Current</th><th>New Stock</th></tr>
                                    </thead>
                                    <tbody>
                                        ${activeProducts.map(p => `
                                            <tr>
                                                <td>${p.sku}</td>
                                                <td>${p.name}</td>
                                                <td class="${p.stock < 10 ? 'low-stock' : ''}">${p.stock}</td>
                                                <td><input type="number" id="stock-${p.id}" value="${p.stock}" min="0" style="width: 80px;"></td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                                <button type="submit" class="btn btn-success">Update All</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        async function bulkUpdateStock(e) {
            e.preventDefault();
            const updates = state.products.filter(p => p.active).map(p => ({
                product_id: p.id,
                stock: parseInt(document.getElementById(`stock-${p.id}`).value) || 0
            }));
            
            try {
                await api('/api/admin/products/bulk-update-stock', {
                    method: 'POST',
                    body: JSON.stringify({ updates })
                });
                closeModal();
                showAlert('Stock levels updated', 'success');
                loadProducts();
                loadStats();
            } catch (err) {
                showAlert(err.message);
            }
        }

        function showBulkCostsModal() {
            document.getElementById('modalContainer').innerHTML = `
                <div class="modal" onclick="if(event.target===this)closeModal()">
                    <div class="modal-content" style="max-width: 700px;">
                        <h3>üí∞ Upload Product Costs</h3>
                        <p style="color: #718096; margin-bottom: 15px;">Upload a CSV file with SKU and Cost columns to bulk update your product costs.</p>
                        
                        <div style="background: #edf2f7; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <strong>CSV Format:</strong>
                            <pre style="background: white; padding: 10px; border-radius: 4px; margin-top: 10px; font-size: 0.85rem;">SKU,Cost
SM10,6.50
TR10,7.00
BC10,8.00</pre>
                            <small style="color: #718096;">Note: Cost should be per unit (not per box). First row should be headers.</small>
                        </div>
                        
                        <div class="form-group">
                            <label>Select CSV File</label>
                            <input type="file" id="costsFile" accept=".csv,.txt" onchange="previewCostsFile()">
                        </div>
                        
                        <div id="costsPreview" style="display: none; margin-bottom: 20px;">
                            <h4 style="margin-bottom: 10px;">Preview:</h4>
                            <div style="max-height: 200px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 6px;">
                                <table id="costsPreviewTable">
                                    <thead><tr><th>SKU</th><th>Cost</th></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                            <button type="button" class="btn btn-success" onclick="uploadCosts()" id="uploadCostsBtn" disabled>Upload & Update Costs</button>
                        </div>
                    </div>
                </div>
            `;
        }

        let parsedCosts = [];

        function previewCostsFile() {
            const file = document.getElementById('costsFile').files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.trim().split(/\r?\n/);
                
                parsedCosts = [];
                const tbody = document.querySelector('#costsPreviewTable tbody');
                tbody.innerHTML = '';
                
                for (let i = 1; i < lines.length; i++) { // Skip header
                    const parts = lines[i].split(',');
                    if (parts.length >= 2) {
                        const sku = parts[0].trim().toUpperCase();
                        const cost = parseFloat(parts[1].trim()) || 0;
                        if (sku && cost > 0) {
                            parsedCosts.push({ sku, cost });
                            tbody.innerHTML += '<tr><td>' + sku + '</td><td>$' + cost.toFixed(2) + '</td></tr>';
                        }
                    }
                }
                
                document.getElementById('costsPreview').style.display = 'block';
                document.getElementById('uploadCostsBtn').disabled = parsedCosts.length === 0;
            };
            reader.readAsText(file);
        }

        async function uploadCosts() {
            if (parsedCosts.length === 0) {
                showAlert('No valid costs to upload');
                return;
            }
            
            try {
                const result = await api('/api/admin/products/bulk-update-costs', {
                    method: 'POST',
                    body: JSON.stringify({ costs: parsedCosts })
                });
                
                closeModal();
                
                let msg = result.updated + ' products updated';
                if (result.not_found && result.not_found.length > 0) {
                    msg += '. SKUs not found: ' + result.not_found.join(', ');
                }
                showAlert(msg, 'success');
                loadProducts();
            } catch (err) {
                showAlert(err.message);
            }
        }

        // PDF Import for Vendor Pricing
        function showPdfImportModal() {
            document.getElementById('modalContainer').innerHTML = `
                <div class="modal" onclick="if(event.target===this)closeModal()">
                    <div class="modal-content" style="max-width: 800px;">
                        <h3>üìÑ Import Vendor Pricing PDF</h3>
                        <p style="color: #718096; margin-bottom: 15px;">Upload a vendor pricing PDF to extract product costs.</p>
                        
                        <div class="form-group">
                            <label>Select PDF File</label>
                            <input type="file" id="pdfFile" accept=".pdf" onchange="uploadPdfForExtraction()">
                        </div>
                        
                        <div id="pdfLoading" style="display: none; text-align: center; padding: 30px;">
                            <div style="font-size: 2rem;">‚è≥</div>
                            <p>Extracting tables from PDF...</p>
                        </div>
                        
                        <div id="pdfExtracted" style="display: none;">
                            <div style="background: #f0fff4; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                <strong style="color: #276749;">‚úÖ Found <span id="pdfRowCount">0</span> rows across <span id="pdfPageCount">0</span> pages</strong>
                            </div>
                            
                            <div style="background: #edf2f7; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                <p style="margin-bottom: 10px;"><strong>Map Columns:</strong></p>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div class="form-group" style="margin-bottom: 0;">
                                        <label>SKU Column</label>
                                        <select id="pdfSkuCol" onchange="updatePdfPreview()"></select>
                                    </div>
                                    <div class="form-group" style="margin-bottom: 0;">
                                        <label>Cost Column</label>
                                        <select id="pdfCostCol" onchange="updatePdfPreview()"></select>
                                    </div>
                                </div>
                                <div class="form-group" style="margin-top: 10px; margin-bottom: 0;">
                                    <label>
                                        <input type="checkbox" id="pdfDivideBy10" checked>
                                        Divide cost by 10 (vendor prices are per box of 10)
                                    </label>
                                </div>
                            </div>
                            
                            <h4 style="margin-bottom: 10px;">Preview (first 10 rows):</h4>
                            <div style="max-height: 200px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 6px; margin-bottom: 15px;">
                                <table id="pdfPreviewTable">
                                    <thead><tr><th>SKU</th><th>Cost (per unit)</th></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                            
                            <div style="display: flex; gap: 10px;">
                                <button type="button" class="btn btn-secondary" onclick="downloadPdfAsCsv()">üì• Download as CSV</button>
                                <button type="button" class="btn btn-success" onclick="uploadPdfCosts()">üí∞ Upload Costs Now</button>
                            </div>
                        </div>
                        
                        <div id="pdfError" style="display: none;" class="alert alert-danger"></div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
        }

        let pdfExtractedData = [];
        let pdfColumns = [];

        async function uploadPdfForExtraction() {
            const file = document.getElementById('pdfFile').files[0];
            if (!file) return;
            
            document.getElementById('pdfLoading').style.display = 'block';
            document.getElementById('pdfExtracted').style.display = 'none';
            document.getElementById('pdfError').style.display = 'none';
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const res = await fetch('/api/admin/extract-pdf', {
                    method: 'POST',
                    body: formData,
                    credentials: 'same-origin',
                    headers: state.csrfToken ? {'X-CSRF-Token': state.csrfToken} : {}
                });
                const result = await res.json();
                
                document.getElementById('pdfLoading').style.display = 'none';
                
                if (!res.ok) throw new Error(result.error || 'Failed to extract PDF');
                
                if (!result.rows || result.rows.length === 0) {
                    throw new Error('No tables found in PDF');
                }
                
                pdfExtractedData = result.rows;
                pdfColumns = result.columns || [];
                
                document.getElementById('pdfRowCount').textContent = result.rows.length;
                document.getElementById('pdfPageCount').textContent = result.pages || 1;
                
                // Populate column dropdowns
                const skuSelect = document.getElementById('pdfSkuCol');
                const costSelect = document.getElementById('pdfCostCol');
                skuSelect.innerHTML = '';
                costSelect.innerHTML = '';
                
                pdfColumns.forEach((col, i) => {
                    skuSelect.innerHTML += '<option value="' + i + '"' + (col.toLowerCase().includes('sku') || col.toLowerCase().includes('code') || col.toLowerCase().includes('item') ? ' selected' : '') + '>' + escapeHtml(col) + '</option>';
                    costSelect.innerHTML += '<option value="' + i + '"' + (col.toLowerCase().includes('price') || col.toLowerCase().includes('cost') || col.toLowerCase().includes('amount') ? ' selected' : '') + '>' + escapeHtml(col) + '</option>';
                });
                
                updatePdfPreview();
                document.getElementById('pdfExtracted').style.display = 'block';
                
            } catch (err) {
                document.getElementById('pdfLoading').style.display = 'none';
                document.getElementById('pdfError').style.display = 'block';
                document.getElementById('pdfError').textContent = err.message;
            }
        }

        function updatePdfPreview() {
            const skuCol = parseInt(document.getElementById('pdfSkuCol').value);
            const costCol = parseInt(document.getElementById('pdfCostCol').value);
            const divideBy10 = document.getElementById('pdfDivideBy10').checked;
            
            const tbody = document.querySelector('#pdfPreviewTable tbody');
            tbody.innerHTML = '';
            
            const previewRows = pdfExtractedData.slice(0, 10);
            previewRows.forEach(row => {
                const sku = (row[skuCol] || '').toString().trim().toUpperCase();
                let cost = parseFloat((row[costCol] || '0').toString().replace(/[^0-9.]/g, '')) || 0;
                if (divideBy10 && cost > 0) cost = cost / 10;
                
                if (sku && cost > 0) {
                    tbody.innerHTML += '<tr><td>' + escapeHtml(sku) + '</td><td>$' + cost.toFixed(2) + '</td></tr>';
                }
            });
        }

        function getPdfCostData() {
            const skuCol = parseInt(document.getElementById('pdfSkuCol').value);
            const costCol = parseInt(document.getElementById('pdfCostCol').value);
            const divideBy10 = document.getElementById('pdfDivideBy10').checked;
            
            const costs = [];
            pdfExtractedData.forEach(row => {
                const sku = (row[skuCol] || '').toString().trim().toUpperCase();
                let cost = parseFloat((row[costCol] || '0').toString().replace(/[^0-9.]/g, '')) || 0;
                if (divideBy10 && cost > 0) cost = cost / 10;
                
                if (sku && cost > 0) {
                    costs.push({ sku, cost });
                }
            });
            return costs;
        }

        function downloadPdfAsCsv() {
            const costs = getPdfCostData();
            if (costs.length === 0) {
                showAlert('No valid data to download');
                return;
            }
            
            let csv = 'SKU,Cost\n';
            costs.forEach(c => {
                csv += c.sku + ',' + c.cost.toFixed(2) + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'vendor-costs.csv';
            a.click();
            URL.revokeObjectURL(url);
            
            showAlert('CSV downloaded!', 'success');
        }

        async function uploadPdfCosts() {
            const costs = getPdfCostData();
            if (costs.length === 0) {
                showAlert('No valid costs to upload');
                return;
            }
            
            try {
                const result = await api('/api/admin/products/bulk-update-costs', {
                    method: 'POST',
                    body: JSON.stringify({ costs })
                });
                
                closeModal();
                
                let msg = result.updated + ' products updated';
                if (result.not_found && result.not_found.length > 0) {
                    msg += '. SKUs not found: ' + result.not_found.join(', ');
                }
                showAlert(msg, 'success');
                loadProducts();
            } catch (err) {
                showAlert(err.message);
            }
        }

        // Inventory - Receive Products with Lot Numbers
        async function loadInventory() {
            try {
                state.products = await api('/api/admin/products');
                state.inventory = await api('/api/admin/inventory-receipts');
                renderInventory();
            } catch (e) {
                showAlert('Failed to load inventory');
            }
        }

        function renderInventory() {
            const activeProducts = state.products.filter(p => p.active);
            const content = document.getElementById('tabContent');
            content.innerHTML = `
                <div class="toolbar">
                    <h3 style="color: #2d3748;">Inventory Management</h3>
                    <button class="btn" onclick="showReceiveInventoryModal()">üì¶ Receive Inventory</button>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div class="card" style="margin-bottom: 0;">
                        <h4 style="margin-bottom: 15px;">Current Stock Levels</h4>
                        <div style="max-height: 300px; overflow-y: auto;">
                            <table>
                                <thead><tr><th>Product</th><th>SKU</th><th>Stock</th></tr></thead>
                                <tbody>
                                    ${activeProducts.map(p => `
                                        <tr>
                                            <td>${p.name}</td>
                                            <td>${p.sku}</td>
                                            <td class="${p.stock < 10 ? 'low-stock' : ''}">${p.stock}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <h4 style="margin-bottom: 15px;">Recent Inventory Receipts</h4>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Date Received</th>
                                <th>Lot Number</th>
                                <th>Product</th>
                                <th>Qty Received</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${state.inventory && state.inventory.length > 0 
                                ? state.inventory.map(r => `
                                    <tr>
                                        <td>${new Date(r.received_date).toLocaleDateString()}</td>
                                        <td><strong>${r.lot_number}</strong></td>
                                        <td>${r.product_name || r.sku}</td>
                                        <td>${r.quantity}</td>
                                        <td>${r.notes || '-'}</td>
                                    </tr>
                                `).join('')
                                : '<tr><td colspan="5" style="text-align: center; color: #718096;">No inventory receipts yet</td></tr>'
                            }
                        </tbody>
                    </table>
                </div>
            `;
        }

        function showReceiveInventoryModal() {
            const activeProducts = state.products.filter(p => p.active);
            const today = new Date().toISOString().split('T')[0];
            
            document.getElementById('modalContainer').innerHTML = `
                <div class="modal" onclick="if(event.target===this)closeModal()">
                    <div class="modal-content">
                        <h3>üì¶ Receive Inventory</h3>
                        <form onsubmit="receiveInventory(event)">
                            <div class="form-group">
                                <label>Product *</label>
                                <select id="receiveProductId" required onchange="generateLotNumber()">
                                    <option value="">Select product...</option>
                                    ${activeProducts.map(p => `<option value="${p.id}" data-sku="${p.sku}">${p.name} (${p.sku})</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Quantity Received *</label>
                                    <input type="number" id="receiveQty" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>Date Received *</label>
                                    <input type="date" id="receiveDate" value="${today}" required onchange="generateLotNumber()">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Lot Number</label>
                                <input type="text" id="receiveLotNumber" placeholder="Auto-generated or enter manually">
                                <small style="color: #718096;">Format: SKU-YYYYMMDD-XXX (auto-generated when you select product and date)</small>
                            </div>
                            <div class="form-group">
                                <label>Notes</label>
                                <textarea id="receiveNotes" rows="2" placeholder="Supplier, invoice #, etc."></textarea>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                                <button type="submit" class="btn btn-success">Receive & Update Stock</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        function generateLotNumber() {
            const productSelect = document.getElementById('receiveProductId');
            const dateInput = document.getElementById('receiveDate');
            const lotInput = document.getElementById('receiveLotNumber');
            
            if (productSelect.value && dateInput.value) {
                const sku = productSelect.options[productSelect.selectedIndex].dataset.sku;
                const dateStr = dateInput.value.replace(/-/g, '');
                const random = Math.floor(Math.random() * 900 + 100); // 3 digit random
                lotInput.value = `${sku}-${dateStr}-${random}`;
            }
        }

        async function receiveInventory(e) {
            e.preventDefault();
            
            const productId = document.getElementById('receiveProductId').value;
            const quantity = parseInt(document.getElementById('receiveQty').value);
            const receivedDate = document.getElementById('receiveDate').value;
            const lotNumber = document.getElementById('receiveLotNumber').value;
            const notes = document.getElementById('receiveNotes').value;
            
            if (!productId || !quantity || !receivedDate) {
                showAlert('Please fill in all required fields');
                return;
            }
            
            try {
                await api('/api/admin/inventory-receipts', {
                    method: 'POST',
                    body: JSON.stringify({
                        product_id: productId,
                        quantity: quantity,
                        received_date: receivedDate,
                        lot_number: lotNumber || null,
                        notes: notes
                    })
                });
                closeModal();
                showAlert(`Received ${quantity} units. Stock updated!`, 'success');
                loadInventory();
                loadStats();
            } catch (err) {
                showAlert(err.message);
            }
        }

        // Orders
        async function loadOrders() {
            try {
                const url = state.orderStatusFilter 
                    ? `/api/admin/orders?status=${state.orderStatusFilter}` 
                    : '/api/admin/orders';
                state.orders = await api(url);
                renderOrders();
            } catch (e) {
                showAlert('Failed to load orders');
            }
        }

        function renderOrders() {
            const content = document.getElementById('tabContent');
            content.innerHTML = `
                <div class="search-bar">
                    <select onchange="state.orderStatusFilter=this.value;loadOrders()">
                        <option value="">All Statuses</option>
                        <option value="pending" ${state.orderStatusFilter==='pending'?'selected':''}>Pending</option>
                        <option value="paid" ${state.orderStatusFilter==='paid'?'selected':''}>Paid</option>
                        <option value="processing" ${state.orderStatusFilter==='processing'?'selected':''}>Processing</option>
                        <option value="shipped" ${state.orderStatusFilter==='shipped'?'selected':''}>Shipped</option>
                        <option value="delivered" ${state.orderStatusFilter==='delivered'?'selected':''}>Delivered</option>
                        <option value="cancelled" ${state.orderStatusFilter==='cancelled'?'selected':''}>Cancelled</option>
                    </select>
                </div>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Order #</th>
                                <th>Customer</th>
                                <th>Items</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${state.orders.map(o => `
                                <tr>
                                    <td><strong>${o.order_number}</strong></td>
                                    <td>${o.full_name || o.customer_name || 'Unknown'}<br><small style="color:#718096;">${o.email || o.customer_email || ''}</small></td>
                                    <td>${o.items ? o.items.length : 0} items</td>
                                    <td>$${parseFloat(o.total || 0).toFixed(2)}</td>
                                    <td><span class="status-badge status-${o.status}">${o.status}</span></td>
                                    <td>${new Date(o.created_at).toLocaleDateString()}</td>
                                    <td class="actions">
                                        <button class="btn btn-small" onclick="showOrderDetailModal(${o.id})">View</button>
                                        <button class="btn btn-secondary btn-small" onclick="showUpdateStatusModal(${o.id})">Status</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function showOrderDetailModal(id) {
            const o = state.orders.find(x => x.id === id);
            if (!o) return;
            
            document.getElementById('modalContainer').innerHTML = `
                <div class="modal" onclick="if(event.target===this)closeModal()">
                    <div class="modal-content">
                        <h3>Order ${o.order_number}</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                            <div>
                                <p><strong>Customer:</strong> ${o.full_name || o.customer_name || 'Unknown'}</p>
                                <p><strong>Email:</strong> ${o.email || o.customer_email || '-'}</p>
                                <p><strong>Phone:</strong> ${o.phone || o.customer_phone || '-'}</p>
                            </div>
                            <div>
                                <p><strong>Status:</strong> <span class="status-badge status-${o.status}">${o.status}</span></p>
                                <p><strong>Delivery:</strong> ${o.delivery_method === 'ship' ? 'üì¶ Ship' : 'üè™ Pickup'}</p>
                                <p><strong>Date:</strong> ${new Date(o.created_at).toLocaleString()}</p>
                                ${o.tracking_number ? `<p><strong>Tracking:</strong> ${o.tracking_number}</p>` : ''}
                            </div>
                        </div>
                        ${o.delivery_method === 'ship' && o.shipping_address ? `
                            <p><strong>Shipping Address:</strong></p>
                            <p style="background: #f7fafc; padding: 10px; border-radius: 6px; margin-bottom: 15px; white-space: pre-line;">${o.shipping_address}</p>
                        ` : ''}
                        <h4 style="margin-bottom: 10px;">Items</h4>
                        <table>
                            <thead><tr><th>Product</th><th>Qty</th><th>Price</th><th>Subtotal</th></tr></thead>
                            <tbody>
                                ${o.items && o.items.length > 0 ? o.items.map(i => `
                                    <tr>
                                        <td>${i.name || i.product_name || 'Unknown'}</td>
                                        <td>${i.quantity}</td>
                                        <td>$${parseFloat(i.unit_price || i.price_each || 0).toFixed(2)}</td>
                                        <td>$${(i.quantity * parseFloat(i.unit_price || i.price_each || 0)).toFixed(2)}</td>
                                    </tr>
                                `).join('') : '<tr><td colspan="4">No items found</td></tr>'}
                            </tbody>
                        </table>
                        <div style="text-align: right; margin-top: 15px; padding: 15px; background: #f7fafc; border-radius: 8px;">
                            <p>Subtotal: $${parseFloat(o.subtotal || 0).toFixed(2)}</p>
                            ${o.discount_code ? `<p style="color: #2b6cb0;">Discount Code: <strong>${escapeHtml(o.discount_code)}</strong></p>` : ''}
                            ${parseFloat(o.discount_amount || 0) > 0 ? `<p style="color: #38a169;">Discount: -$${parseFloat(o.discount_amount).toFixed(2)}</p>` : ''}
                            ${parseFloat(o.shipping_cost || 0) > 0 ? `<p>Shipping: $${parseFloat(o.shipping_cost).toFixed(2)}</p>` : ''}
                            ${parseFloat(o.credit_applied || 0) > 0 ? `<p style="color: #805ad5;">Store Credit: -$${parseFloat(o.credit_applied).toFixed(2)}</p>` : ''}
                            <p style="font-size: 1.2rem; font-weight: 700; margin-top: 10px; padding-top: 10px; border-top: 2px solid #e2e8f0;">Total: $${parseFloat(o.total || 0).toFixed(2)}</p>
                        </div>
                        ${o.admin_notes ? `
                            <div style="margin-top: 15px; padding: 10px; background: #fffbeb; border-left: 3px solid #f6e05e; border-radius: 4px;">
                                <strong>Admin Notes:</strong><br>
                                <span style="white-space: pre-line; font-size: 0.9rem;">${escapeHtml(o.admin_notes)}</span>
                            </div>
                        ` : ''}
                        <div style="margin-top: 20px; display: flex; gap: 10px;">
                            <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                            <button class="btn" onclick="showEditOrderModal(${o.id})">‚úèÔ∏è Edit Order</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function showUpdateStatusModal(id) {
            const o = state.orders.find(x => x.id === id);
            if (!o) return;
            
            document.getElementById('modalContainer').innerHTML = `
                <div class="modal" onclick="if(event.target===this)closeModal()">
                    <div class="modal-content">
                        <h3>Update Status: ${o.order_number}</h3>
                        <form onsubmit="updateOrderStatus(event, ${id})">
                            <div class="form-group">
                                <label>Status</label>
                                <select id="orderStatus">
                                    <option value="pending" ${o.status==='pending'?'selected':''}>Pending</option>
                                    <option value="paid" ${o.status==='paid'?'selected':''}>Paid</option>
                                    <option value="processing" ${o.status==='processing'?'selected':''}>Processing</option>
                                    <option value="shipped" ${o.status==='shipped'?'selected':''}>Shipped</option>
                                    <option value="delivered" ${o.status==='delivered'?'selected':''}>Delivered</option>
                                    <option value="fulfilled" ${o.status==='fulfilled'?'selected':''}>Fulfilled</option>
                                    <option value="cancelled" ${o.status==='cancelled'?'selected':''}>Cancelled</option>
                                    <option value="refunded" ${o.status==='refunded'?'selected':''}>Refunded</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Tracking Number (for shipped orders)</label>
                                <input type="text" id="trackingNumber" value="${o.tracking_number || ''}" placeholder="Enter tracking number">
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                                <button type="submit" class="btn btn-success">Update Status</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        async function updateOrderStatus(e, id) {
            e.preventDefault();
            try {
                await api(`/api/admin/orders/${id}/status`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        status: document.getElementById('orderStatus').value,
                        tracking_number: document.getElementById('trackingNumber').value || null
                    })
                });
                closeModal();
                showAlert('Order status updated', 'success');
                loadOrders();
                loadStats();
            } catch (err) {
                showAlert(err.message);
            }
        }

        // Discount Codes
        async function loadDiscounts() {
            try {
                state.discounts = await api('/api/admin/discount-codes');
                renderDiscounts();
            } catch (e) {
                showAlert('Failed to load discount codes');
            }
        }

        function renderDiscounts() {
            const content = document.getElementById('tabContent');
            content.innerHTML = `
                <div class="toolbar">
                    <button class="btn" onclick="showAddDiscountModal()">+ Add Discount Code</button>
                    <button class="btn btn-secondary" onclick="showDiscountReportModal()">üìä Date Range Report</button>
                    <button class="btn btn-secondary" onclick="showReferralReportModal()">üë• Referral Report</button>
                </div>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Description</th>
                                <th>Discount</th>
                                <th>Referrer</th>
                                <th>Usage</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${state.discounts.map(d => `
                                <tr class="${!d.active ? 'inactive' : ''}">
                                    <td><strong>${d.code}</strong></td>
                                    <td>${d.description || '-'}</td>
                                    <td>${d.discount_percent > 0 ? d.discount_percent + '%' : '$' + parseFloat(d.discount_amount || 0).toFixed(2)}</td>
                                    <td>${d.referrer_name ? '<span style="color: #2b6cb0;">' + d.referrer_name + '</span><br><small style="color: #718096;">' + (d.commission_percent || 20) + '% commission</small>' : '<span style="color: #a0aec0;">-</span>'}</td>
                                    <td>${d.times_used || 0}${d.usage_limit ? ' / ' + d.usage_limit : ''}</td>
                                    <td>${d.active ? '<span class="status-badge status-paid">Active</span>' : '<span class="status-badge status-cancelled">Inactive</span>'}</td>
                                    <td class="actions">
                                        <button class="btn btn-small" onclick="showEditDiscountModal(${d.id})">Edit</button>
                                        ${d.referrer_user_id ? '<button class="btn btn-small" onclick="showReferrerReport(' + d.referrer_user_id + ')">üìä</button>' : ''}
                                        ${d.active 
                                            ? '<button class="btn btn-warning btn-small" onclick="deactivateDiscount(' + d.id + ')">Deactivate</button>'
                                            : ''
                                        }
                                        ${(d.times_used || 0) === 0
                                            ? '<button class="btn btn-danger btn-small" onclick="permanentlyDeleteDiscount(' + d.id + ')">Delete</button>'
                                            : ''
                                        }
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function showDiscountReportModal() {
            const today = new Date().toISOString().split('T')[0];
            const lastMonth = new Date(Date.now() - 30*24*60*60*1000).toISOString().split('T')[0];
            
            document.getElementById('modalContainer').innerHTML = `
                <div class="modal" onclick="if(event.target===this)closeModal()">
                    <div class="modal-content" style="max-width: 400px;">
                        <h3>Generate Discount Report</h3>
                        <div class="form-group">
                            <label>Start Date</label>
                            <input type="date" id="reportStartDate" value="${lastMonth}">
                        </div>
                        <div class="form-group">
                            <label>End Date</label>
                            <input type="date" id="reportEndDate" value="${today}">
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn" onclick="generateDiscountReport()">Generate Report</button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function generateDiscountReport() {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            
            if (!startDate || !endDate) {
                showAlert('Please select both start and end dates');
                return;
            }
            
            try {
                const report = await api(`/api/admin/discount-codes/report?start_date=${startDate}&end_date=${endDate}`);
                
                const totals = report.totals || {};
                
                document.getElementById('modalContainer').innerHTML = `
                    <div class="modal" onclick="if(event.target===this)closeModal()">
                        <div class="modal-content" style="max-width: 700px;">
                            <h3>Discount Code Report</h3>
                            <p style="color: #718096; margin-bottom: 15px;">${startDate} to ${endDate}</p>
                            
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0;">
                                <div style="background: #edf2f7; padding: 15px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: 600; color: #3182ce;">
                                        ${totals.total_orders_with_discount || 0}
                                    </div>
                                    <div style="font-size: 0.85rem; color: #718096;">Orders with Discounts</div>
                                </div>
                                <div style="background: #edf2f7; padding: 15px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: 600; color: #e53e3e;">
                                        $${parseFloat(totals.total_discount_given || 0).toFixed(2)}
                                    </div>
                                    <div style="font-size: 0.85rem; color: #718096;">Total Discounts Given</div>
                                </div>
                                <div style="background: #edf2f7; padding: 15px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: 600; color: #38a169;">
                                        $${parseFloat(totals.total_revenue || 0).toFixed(2)}
                                    </div>
                                    <div style="font-size: 0.85rem; color: #718096;">Revenue (with discounts)</div>
                                </div>
                            </div>
                            
                            <h4 style="margin-top: 20px;">Usage by Code</h4>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Code</th>
                                        <th>Uses</th>
                                        <th>Discount Given</th>
                                        <th>Revenue Generated</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${report.usage && report.usage.length > 0 
                                        ? report.usage.map(u => `
                                            <tr>
                                                <td><strong>${u.code}</strong></td>
                                                <td>${u.times_used}</td>
                                                <td style="color: #e53e3e;">$${parseFloat(u.total_discount).toFixed(2)}</td>
                                                <td style="color: #38a169;">$${parseFloat(u.total_revenue).toFixed(2)}</td>
                                            </tr>
                                        `).join('')
                                        : '<tr><td colspan="4" style="text-align:center; color:#718096;">No discount usage in this period</td></tr>'
                                    }
                                </tbody>
                            </table>
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                            </div>
                        </div>
                    </div>
                `;
            } catch (err) {
                showAlert(err.message);
            }
        }

        async function deactivateDiscount(id) {
            if (!confirm('Deactivate this discount code?')) return;
            try {
                await api(`/api/admin/discount-codes/${id}`, {
                    method: 'DELETE'
                });
                showAlert('Discount code deactivated', 'success');
                loadDiscounts();
            } catch (err) {
                showAlert(err.message);
            }
        }

        async function permanentlyDeleteDiscount(id) {
            if (!confirm('Permanently delete this discount code? This cannot be undone.')) return;
            try {
                await api(`/api/admin/discount-codes/${id}/permanent`, {
                    method: 'DELETE'
                });
                showAlert('Discount code deleted', 'success');
                loadDiscounts();
            } catch (err) {
                showAlert(err.message);
            }
        }

        async function showAddDiscountModal() {
            // Load users for referrer dropdown
            const users = await api('/api/admin/users');
            const userOptions = users.filter(u => !u.is_admin).map(u => 
                '<option value="' + u.id + '">' + escapeHtml(u.full_name) + ' (' + escapeHtml(u.email) + ')</option>'
            ).join('');
            
            document.getElementById('modalContainer').innerHTML = `
                <div class="modal" onclick="if(event.target===this)closeModal()">
                    <div class="modal-content">
                        <h3>Add Discount Code</h3>
                        <form onsubmit="addDiscount(event)">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Code *</label>
                                    <input type="text" id="discCode" required style="text-transform: uppercase;">
                                </div>
                                <div class="form-group">
                                    <label>Description</label>
                                    <input type="text" id="discDesc">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Discount %</label>
                                    <input type="number" id="discPercent" step="0.01" value="0">
                                </div>
                                <div class="form-group">
                                    <label>Discount $</label>
                                    <input type="number" id="discAmount" step="0.01" value="0">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Min Order Amount</label>
                                    <input type="number" id="discMinOrder" step="0.01" value="0">
                                </div>
                                <div class="form-group">
                                    <label>Usage Limit (blank = unlimited)</label>
                                    <input type="number" id="discLimit">
                                </div>
                            </div>
                            <div style="background: #f0fff4; padding: 15px; border-radius: 8px; margin-top: 15px;">
                                <h4 style="margin-bottom: 10px; color: #276749;">üë• Referral Settings</h4>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Assign to Referrer</label>
                                        <select id="discReferrer">
                                            <option value="">-- None (regular discount) --</option>
                                            ${userOptions}
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Commission %</label>
                                        <input type="number" id="discCommission" step="1" value="20" min="0" max="100">
                                        <small style="color: #718096;">% of sale given to referrer</small>
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                                <button type="submit" class="btn">Add Code</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        async function addDiscount(e) {
            e.preventDefault();
            try {
                await api('/api/admin/discount-codes', {
                    method: 'POST',
                    body: JSON.stringify({
                        code: document.getElementById('discCode').value.toUpperCase(),
                        description: document.getElementById('discDesc').value,
                        discount_percent: parseFloat(document.getElementById('discPercent').value) || 0,
                        discount_amount: parseFloat(document.getElementById('discAmount').value) || 0,
                        min_order_amount: parseFloat(document.getElementById('discMinOrder').value) || 0,
                        usage_limit: parseInt(document.getElementById('discLimit').value) || null,
                        referrer_user_id: parseInt(document.getElementById('discReferrer').value) || null,
                        commission_percent: parseFloat(document.getElementById('discCommission').value) || 20
                    })
                });
                closeModal();
                showAlert('Discount code added', 'success');
                loadDiscounts();
            } catch (err) {
                showAlert(err.message);
            }
        }

        async function showEditDiscountModal(id) {
            const d = state.discounts.find(x => x.id === id);
            if (!d) return;
            
            // Load users for referrer dropdown
            const users = await api('/api/admin/users');
            const userOptions = users.filter(u => !u.is_admin).map(u => {
                const selected = d.referrer_user_id === u.id ? ' selected' : '';
                return '<option value="' + u.id + '"' + selected + '>' + escapeHtml(u.full_name) + ' (' + escapeHtml(u.email) + ')</option>';
            }).join('');
            
            const descValue = escapeHtml(d.description || '');
            
            document.getElementById('modalContainer').innerHTML = `
                <div class="modal" onclick="if(event.target===this)closeModal()">
                    <div class="modal-content">
                        <h3>Edit Discount: ${escapeHtml(d.code)}</h3>
                        <form onsubmit="updateDiscount(event, ${id}, '${escapeHtml(d.code)}')">
                            <div class="form-group">
                                <label>Description</label>
                                <input type="text" id="discDesc" value="${descValue}">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Discount %</label>
                                    <input type="number" id="discPercent" step="0.01" value="${d.discount_percent || 0}">
                                </div>
                                <div class="form-group">
                                    <label>Discount $</label>
                                    <input type="number" id="discAmount" step="0.01" value="${d.discount_amount || 0}">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Min Order Amount</label>
                                    <input type="number" id="discMinOrder" step="0.01" value="${d.min_order_amount || 0}">
                                </div>
                                <div class="form-group">
                                    <label>Usage Limit</label>
                                    <input type="number" id="discLimit" value="${d.usage_limit || ''}">
                                </div>
                            </div>
                            <div style="background: #f0fff4; padding: 15px; border-radius: 8px; margin-top: 15px;">
                                <h4 style="margin-bottom: 10px; color: #276749;">üë• Referral Settings</h4>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Assign to Referrer</label>
                                        <select id="discReferrer">
                                            <option value="">-- None (regular discount) --</option>
                                            ${userOptions}
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Commission %</label>
                                        <input type="number" id="discCommission" step="1" value="${d.commission_percent || 20}" min="0" max="100">
                                        <small style="color: #718096;">% of sale given to referrer</small>
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                                <button type="submit" class="btn">Save Changes</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        async function updateDiscount(e, id, code) {
            e.preventDefault();
            try {
                await api('/api/admin/discount-codes/' + id, {
                    method: 'PUT',
                    body: JSON.stringify({
                        code: code,
                        description: document.getElementById('discDesc').value,
                        discount_percent: parseFloat(document.getElementById('discPercent').value) || 0,
                        discount_amount: parseFloat(document.getElementById('discAmount').value) || 0,
                        min_order_amount: parseFloat(document.getElementById('discMinOrder').value) || 0,
                        usage_limit: parseInt(document.getElementById('discLimit').value) || null,
                        referrer_user_id: parseInt(document.getElementById('discReferrer').value) || null,
                        commission_percent: parseFloat(document.getElementById('discCommission').value) || 20
                    })
                });
                closeModal();
                showAlert('Discount code updated', 'success');
                loadDiscounts();
            } catch (err) {
                showAlert(err.message);
            }
        }

        async function showReferralReportModal() {
            try {
                const report = await api('/api/admin/reports/referrals');
                
                document.getElementById('modalContainer').innerHTML = `
                    <div class="modal" onclick="if(event.target===this)closeModal()">
                        <div class="modal-content" style="max-width: 800px;">
                            <h3>üë• Referral Program Summary</h3>
                            ${report.referrers && report.referrers.length > 0 ? `
                                <div style="max-height: 400px; overflow-y: auto; margin-top: 15px;">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Referrer</th>
                                                <th>Code</th>
                                                <th>Referrals</th>
                                                <th>Total Earned</th>
                                                <th>Balance</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${report.referrers.map(r => `
                                                <tr>
                                                    <td><strong>${escapeHtml(r.full_name)}</strong><br><small style="color: #718096;">${escapeHtml(r.email)}</small></td>
                                                    <td><code>${escapeHtml(r.code)}</code></td>
                                                    <td>${r.referral_count || 0}</td>
                                                    <td style="color: #38a169;">$${parseFloat(r.total_earned || 0).toFixed(2)}</td>
                                                    <td style="color: #2b6cb0; font-weight: 600;">$${parseFloat(r.referral_credit || 0).toFixed(2)}</td>
                                                    <td><button class="btn btn-small" onclick="closeModal(); showReferrerReport(${r.id})">View Details</button></td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            ` : '<p style="color: #718096; text-align: center; padding: 20px;">No referrers set up yet. Assign a user to a discount code to enable referrals.</p>'}
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                            </div>
                        </div>
                    </div>
                `;
            } catch (err) {
                showAlert('Error loading referral report: ' + err.message);
            }
        }

        async function showReferrerReport(userId) {
            const today = new Date().toISOString().split('T')[0];
            const lastMonth = new Date(Date.now() - 30*24*60*60*1000).toISOString().split('T')[0];
            
            try {
                const report = await api('/api/admin/reports/referrals?referrer_id=' + userId + '&start_date=' + lastMonth + '&end_date=' + today);
                
                // Store report data for copy function
                state.currentReferrerReport = {
                    name: report.referrer.full_name,
                    balance: report.totals.current_balance
                };
                
                document.getElementById('modalContainer').innerHTML = `
                    <div class="modal" onclick="if(event.target===this)closeModal()">
                        <div class="modal-content" style="max-width: 800px;">
                            <h3>üìä Referral Report: ${escapeHtml(report.referrer.full_name)}</h3>
                            <p style="color: #718096;">${escapeHtml(report.referrer.email)} | Code: <code>${escapeHtml(report.code) || 'Not assigned'}</code></p>
                            
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 20px 0;">
                                <div style="background: #f0fff4; padding: 15px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: 600; color: #38a169;">$${report.totals.total_earned.toFixed(2)}</div>
                                    <div style="font-size: 0.8rem; color: #276749;">Total Earned</div>
                                </div>
                                <div style="background: #fff5f5; padding: 15px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: 600; color: #c53030;">$${report.totals.total_used.toFixed(2)}</div>
                                    <div style="font-size: 0.8rem; color: #9b2c2c;">Total Used</div>
                                </div>
                                <div style="background: #ebf8ff; padding: 15px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: 600; color: #2b6cb0;">$${report.totals.current_balance.toFixed(2)}</div>
                                    <div style="font-size: 0.8rem; color: #2c5282;">Current Balance</div>
                                </div>
                                <div style="background: #faf5ff; padding: 15px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: 600; color: #805ad5;">${report.totals.referral_count}</div>
                                    <div style="font-size: 0.8rem; color: #553c9a;">Referrals</div>
                                </div>
                            </div>
                            
                            ${report.transactions && report.transactions.length > 0 ? `
                                <h4 style="margin-bottom: 10px;">Transaction History (Last 30 Days)</h4>
                                <div style="max-height: 250px; overflow-y: auto;">
                                    <table style="font-size: 0.9rem;">
                                        <thead>
                                            <tr><th>Date</th><th>Type</th><th>Order</th><th>Amount</th><th>Description</th></tr>
                                        </thead>
                                        <tbody>
                                            ${report.transactions.map(t => `
                                                <tr>
                                                    <td>${new Date(t.created_at).toLocaleDateString()}</td>
                                                    <td>${t.type === 'earned' ? '<span style="color: #38a169;">Earned</span>' : '<span style="color: #e53e3e;">Used</span>'}</td>
                                                    <td>${escapeHtml(t.order_number) || '-'}</td>
                                                    <td style="color: ${t.amount >= 0 ? '#38a169' : '#e53e3e'}; font-weight: 500;">${t.amount >= 0 ? '+' : ''}$${parseFloat(t.amount).toFixed(2)}</td>
                                                    <td style="color: #718096; font-size: 0.85rem;">${escapeHtml(t.description) || '-'}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            ` : '<p style="color: #718096; text-align: center; padding: 20px;">No transactions in this period.</p>'}
                            
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                                <button class="btn" onclick="copyReferrerReport()">üìã Copy Report for Referrer</button>
                            </div>
                        </div>
                    </div>
                `;
            } catch (err) {
                showAlert('Error loading referrer report: ' + err.message);
            }
        }

        function copyReferrerReport() {
            const data = state.currentReferrerReport;
            if (!data) return;
            const text = 'Hi ' + data.name + ',\n\nHere is your referral credit summary:\n\nCurrent Balance: $' + data.balance.toFixed(2) + '\n\nYou can use this credit on your next order. Just select "Apply Credit" at checkout.\n\nThank you for your referrals!';
            navigator.clipboard.writeText(text).then(() => {
                showAlert('Report copied to clipboard!', 'success');
            });
        }

        // Users
        async function loadUsers() {
            try {
                state.users = await api('/api/admin/users');
                if (!Array.isArray(state.users)) {
                    console.error('Invalid users response:', state.users);
                    state.users = [];
                }
                renderUsers();
            } catch (e) {
                console.error('Failed to load users:', e);
                showAlert('Failed to load users: ' + e.message);
                state.users = [];
                renderUsers();
            }
        }

        function renderUsers() {
            const content = document.getElementById('tabContent');
            content.innerHTML = `
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Organization</th>
                                <th>Credit</th>
                                <th>Verified</th>
                                <th>Admin</th>
                                <th>Joined</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${state.users.map(u => {
                                const credit = parseFloat(u.referral_credit) || 0;
                                return `
                                <tr>
                                    <td>${escapeHtml(u.full_name)}</td>
                                    <td>${escapeHtml(u.email)}</td>
                                    <td>${escapeHtml(u.phone) || '-'}</td>
                                    <td>${escapeHtml(u.organization) || '-'}</td>
                                    <td>${credit > 0 ? '<span style="color: #2b6cb0; font-weight: 600;">$' + credit.toFixed(2) + '</span>' : '<span style="color: #a0aec0;">$0.00</span>'}</td>
                                    <td>${u.email_verified ? '‚úÖ' : '‚ùå'}</td>
                                    <td>${u.is_admin ? 'üëë Yes' : 'No'}</td>
                                    <td>${new Date(u.created_at).toLocaleDateString()}</td>
                                    <td class="actions">
                                        <button class="btn btn-small" onclick="showUserDetailModal(${u.id})">View</button>
                                        <button class="btn btn-secondary btn-small" onclick="showEditUserModal(${u.id})">Edit</button>
                                        <button class="btn btn-success btn-small" onclick="showAddCreditModal(${u.id}, '${escapeHtml(u.full_name).replace(/'/g, "\\'")}', ${credit})">üí∞ Credit</button>
                                        <button class="btn btn-warning btn-small" onclick="showResetPasswordModal(${u.id}, '${escapeHtml(u.full_name).replace(/'/g, "\\'")}', '${escapeHtml(u.email).replace(/'/g, "\\'")}')">üîê Reset PW</button>
                                        ${!u.email_verified ? '<button class="btn btn-success btn-small" onclick="resendVerification(' + u.id + ')">Resend</button>' : ''}
                                        <button class="btn btn-small ${u.is_admin ? 'btn-warning' : 'btn-secondary'}" 
                                            onclick="toggleAdmin(${u.id})">
                                            ${u.is_admin ? 'Remove Admin' : 'Make Admin'}
                                        </button>
                                        ${!u.is_admin ? '<button class="btn btn-danger btn-small" onclick="deleteUser(' + u.id + ')">Delete</button>' : ''}
                                    </td>
                                </tr>
                            `}).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function showUserDetailModal(id) {
            const u = state.users.find(x => x.id === id);
            if (!u) return;
            
            document.getElementById('modalContainer').innerHTML = `
                <div class="modal" onclick="if(event.target===this)closeModal()">
                    <div class="modal-content">
                        <h3>User Details: ${u.full_name}</h3>
                        <div style="display: grid; gap: 10px; margin: 20px 0;">
                            <p><strong>Email:</strong> ${u.email}</p>
                            <p><strong>Phone:</strong> ${u.phone || '-'}</p>
                            <p><strong>Organization:</strong> ${u.organization || '-'}</p>
                            <p><strong>Country:</strong> ${u.country || '-'}</p>
                            <p><strong>Email Verified:</strong> ${u.email_verified ? 'Yes ‚úÖ' : 'No ‚ùå'}</p>
                            <p><strong>Admin:</strong> ${u.is_admin ? 'Yes üëë' : 'No'}</p>
                            <p><strong>Joined:</strong> ${new Date(u.created_at).toLocaleString()}</p>
                        </div>
                        <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                    </div>
                </div>
            `;
        }

        function showEditUserModal(id) {
            const u = state.users.find(x => x.id === id);
            if (!u) return;
            
            const credit = parseFloat(u.referral_credit) || 0;
            
            document.getElementById('modalContainer').innerHTML = `
                <div class="modal" onclick="if(event.target===this)closeModal()">
                    <div class="modal-content">
                        <h3>Edit User: ${escapeHtml(u.full_name)}</h3>
                        <form onsubmit="updateUser(event, ${id})">
                            <div class="form-group">
                                <label>Full Name</label>
                                <input type="text" id="editUserName" value="${escapeHtml(u.full_name)}" required>
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="editUserEmail" value="${escapeHtml(u.email)}" required>
                            </div>
                            <div class="form-group">
                                <label>Phone</label>
                                <input type="text" id="editUserPhone" value="${escapeHtml(u.phone) || ''}">
                            </div>
                            <div class="form-group">
                                <label>Organization</label>
                                <input type="text" id="editUserOrg" value="${escapeHtml(u.organization) || ''}">
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="editUserVerified" ${u.email_verified ? 'checked' : ''}>
                                    Email Verified
                                </label>
                            </div>
                            <div style="background: #ebf8ff; padding: 15px; border-radius: 8px; margin-top: 15px;">
                                <h4 style="margin-bottom: 10px; color: #2c5282;">üí∞ Referral Credit</h4>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label>Credit Balance ($)</label>
                                    <input type="number" id="editUserCredit" step="0.01" min="0" value="${credit.toFixed(2)}">
                                    <small style="color: #718096;">Adjust manually if needed (e.g., to correct errors or give bonus credit)</small>
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                                <button type="submit" class="btn btn-success">Save Changes</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        async function updateUser(e, id) {
            e.preventDefault();
            try {
                await api('/api/admin/users/' + id, {
                    method: 'PUT',
                    body: JSON.stringify({
                        full_name: document.getElementById('editUserName').value,
                        email: document.getElementById('editUserEmail').value,
                        phone: document.getElementById('editUserPhone').value,
                        organization: document.getElementById('editUserOrg').value,
                        email_verified: document.getElementById('editUserVerified').checked,
                        referral_credit: parseFloat(document.getElementById('editUserCredit').value) || 0
                    })
                });
                closeModal();
                showAlert('User updated successfully', 'success');
                loadUsers();
            } catch (err) {
                showAlert(err.message);
            }
        }

        async function deleteUser(id) {
            const user = state.users.find(u => u.id === id);
            if (!confirm(`Are you sure you want to delete user "${user.full_name}"? This cannot be undone.`)) return;
            
            try {
                await api(`/api/admin/users/${id}`, { method: 'DELETE' });
                showAlert('User deleted', 'success');
                loadUsers();
            } catch (err) {
                showAlert(err.message);
            }
        }

        async function toggleAdmin(id) {
            const user = state.users.find(u => u.id === id);
            const action = user.is_admin ? 'remove admin privileges from' : 'grant admin privileges to';
            if (!confirm(`Are you sure you want to ${action} ${user.full_name}?`)) return;
            
            try {
                await api(`/api/admin/users/${id}/toggle-admin`, { method: 'POST' });
                showAlert('User updated', 'success');
                loadUsers();
            } catch (err) {
                showAlert(err.message);
            }
        }

        async function resendVerification(id) {
            const user = state.users.find(u => u.id === id);
            if (!confirm(`Resend verification email to ${user.email}?`)) return;
            
            try {
                await api(`/api/admin/users/${id}/resend-verification`, { method: 'POST' });
                showAlert('Verification email sent!', 'success');
            } catch (err) {
                showAlert(err.message);
            }
        }

        // Email Blast
        let emailHistory = [];
        let emailUsers = [];
        let selectedUserIds = new Set();
        
        async function loadEmail() {
            try {
                // Load products if not already loaded (needed for sale products display)
                if (!state.products || state.products.length === 0) {
                    state.products = await api('/api/admin/products');
                }
                const preview = await api('/api/admin/email-blast/preview', { method: 'POST', body: '{}' });
                emailUsers = preview.users || [];
                selectedUserIds = new Set(emailUsers.map(u => u.id)); // Select all by default
                emailHistory = await api('/api/admin/email-blast/history');
                renderEmail();
            } catch (e) {
                showAlert('Failed to load email info');
                renderEmail();
            }
        }
        
        function renderEmail() {
            const content = document.getElementById('tabContent');
            const selectedCount = selectedUserIds.size;
            
            content.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="card">
                        <h3 style="margin-bottom: 15px;">üìß Send Email Blast</h3>
                        
                        <div class="form-group">
                            <label>Subject Line *</label>
                            <input type="text" id="emailSubject" placeholder="e.g., üéâ Special Sale - 20% Off All Peptides!">
                        </div>
                        
                        <div class="form-group">
                            <label>Email Body *</label>
                            <textarea id="emailBody" rows="8" placeholder="Write your email here...

Use {{name}} to personalize with customer's name.

Example:
Hi {{name}},

We're excited to announce our biggest sale of the year!

Use code SAVE20 at checkout for 20% off your entire order.

Shop now at thepeptidewizard.com

Best regards,
The Peptide Wizard Team"></textarea>
                        </div>
                        
                        <div style="background: #ebf8ff; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <h4 style="color: #2b6cb0; margin-bottom: 10px;">üí° Tips</h4>
                            <ul style="color: #4a5568; font-size: 0.9rem; margin: 0; padding-left: 20px;">
                                <li>Use <code>{{name}}</code> to insert customer's name</li>
                                <li>Keep subject lines short and attention-grabbing</li>
                                <li>Include a clear call-to-action</li>
                            </ul>
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-secondary" onclick="previewEmailBlast()">üëÅÔ∏è Preview</button>
                            <button class="btn btn-success" onclick="sendEmailBlast()" ${selectedCount === 0 ? 'disabled' : ''}>
                                üì§ Send to ${selectedCount} Customer${selectedCount !== 1 ? 's' : ''}
                            </button>
                        </div>
                    </div>
                    
                    <div>
                        <div class="card" style="margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="margin: 0;">üë• Select Recipients</h3>
                                <div style="display: flex; gap: 10px;">
                                    <button class="btn btn-small btn-secondary" onclick="selectAllEmailUsers()">Select All</button>
                                    <button class="btn btn-small btn-secondary" onclick="deselectAllEmailUsers()">Deselect All</button>
                                </div>
                            </div>
                            <p style="color: #718096; margin-bottom: 10px;">${selectedCount} of ${emailUsers.length} customers selected</p>
                            
                            ${emailUsers.length === 0 ? 
                                '<p style="color: #718096; text-align: center; padding: 20px;">No verified customers yet.</p>' : `
                                <div style="max-height: 250px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px;">
                                    ${emailUsers.map(u => `
                                        <label style="display: flex; align-items: center; padding: 10px 15px; border-bottom: 1px solid #e2e8f0; cursor: pointer; ${selectedUserIds.has(u.id) ? 'background: #ebf8ff;' : ''}" 
                                               onmouseover="this.style.background='#f7fafc'" 
                                               onmouseout="this.style.background='${selectedUserIds.has(u.id) ? '#ebf8ff' : 'white'}'">
                                            <input type="checkbox" ${selectedUserIds.has(u.id) ? 'checked' : ''} 
                                                   onchange="toggleEmailUser(${u.id})" style="margin-right: 10px;">
                                            <div>
                                                <strong>${escapeHtml(u.full_name || 'Unknown')}</strong>
                                                <div style="font-size: 0.85rem; color: #718096;">${escapeHtml(u.email)}</div>
                                            </div>
                                        </label>
                                    `).join('')}
                                </div>
                            `}
                        </div>
                        
                        <div class="card">
                            <h3 style="margin-bottom: 15px;">üìú Email History</h3>
                            ${emailHistory.length === 0 ? 
                                '<p style="color: #718096; text-align: center; padding: 20px;">No emails sent yet.</p>' : `
                                <div style="max-height: 200px; overflow-y: auto;">
                                    ${emailHistory.map(e => `
                                        <div style="border-bottom: 1px solid #e2e8f0; padding: 10px 0;">
                                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                                <strong style="font-size: 0.9rem;">${escapeHtml(e.subject)}</strong>
                                                <small style="color: #718096;">${new Date(e.created_at).toLocaleDateString()}</small>
                                            </div>
                                            <div style="font-size: 0.8rem; color: #4a5568;">
                                                Sent to <strong>${e.recipients_count}</strong> recipients
                                            </div>
                                            <button class="btn btn-small btn-secondary" style="margin-top: 5px; font-size: 0.75rem;" onclick="viewEmailBlast(${e.id})">View</button>
                                        </div>
                                    `).join('')}
                                </div>
                            `}
                        </div>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <h3 style="margin-bottom: 15px;">üè∑Ô∏è Products On Sale</h3>
                    <p style="color: #718096; margin-bottom: 15px;">Quick view of products currently on sale - great for including in your email!</p>
                    ${renderSaleProducts()}
                </div>
            `;
        }
        
        function renderSaleProducts() {
            const now = new Date();
            const onSale = state.products.filter(p => {
                if (!p.sale_price || p.sale_price <= 0) return false;
                if (p.sale_start && new Date(p.sale_start) > now) return false;
                if (p.sale_end && new Date(p.sale_end) < now) return false;
                return true;
            });
            
            if (onSale.length === 0) {
                return '<p style="color: #718096; text-align: center;">No products currently on sale. Edit a product to set up a sale.</p>';
            }
            
            return `
                <table>
                    <thead>
                        <tr>
                            <th>SKU</th>
                            <th>Product</th>
                            <th>Regular Price</th>
                            <th>Sale Price</th>
                            <th>Min Qty</th>
                            <th>Discount</th>
                            <th>Sale Ends</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${onSale.map(p => {
                            const discount = ((p.price_single - p.sale_price) / p.price_single * 100).toFixed(0);
                            const endDate = p.sale_end ? new Date(p.sale_end).toLocaleDateString() : 'No end date';
                            const minQty = p.sale_min_qty || 1;
                            return `
                                <tr>
                                    <td><code>${escapeHtml(p.sku)}</code></td>
                                    <td>${escapeHtml(p.name)}</td>
                                    <td style="text-decoration: line-through; color: #a0aec0;">$${p.price_single.toFixed(2)}</td>
                                    <td style="color: #e53e3e; font-weight: 600;">$${p.sale_price.toFixed(2)}</td>
                                    <td>${minQty > 1 ? '<strong>' + minQty + '+</strong>' : 'Any'}</td>
                                    <td><span style="background: #fed7d7; color: #c53030; padding: 2px 8px; border-radius: 4px; font-weight: 600;">${discount}% OFF</span></td>
                                    <td>${endDate}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }
        
        function previewEmailBlast() {
            const subject = document.getElementById('emailSubject').value.trim();
            const body = document.getElementById('emailBody').value.trim();
            
            if (!subject || !body) {
                showAlert('Please enter subject and body');
                return;
            }
            
            const previewBody = body.replace(/\{\{name\}\}/g, 'John Smith');
            
            document.getElementById('modalContainer').innerHTML = `
                <div class="modal" onclick="if(event.target===this)closeModal()">
                    <div class="modal-content" style="max-width: 600px;">
                        <h3>üìß Email Preview</h3>
                        <div style="background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 8px; margin-top: 15px;">
                            <div style="background: #667eea; color: white; padding: 20px; text-align: center; border-radius: 8px 8px 0 0;">
                                <h2 style="margin: 0;">üß™ The Peptide Wizard</h2>
                            </div>
                            <div style="padding: 20px;">
                                <p style="font-weight: 600; color: #2d3748; border-bottom: 1px solid #e2e8f0; padding-bottom: 10px;">
                                    Subject: ${escapeHtml(subject)}
                                </p>
                                <div style="white-space: pre-wrap; color: #4a5568; line-height: 1.6;">${escapeHtml(previewBody)}</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function toggleEmailUser(userId) {
            if (selectedUserIds.has(userId)) {
                selectedUserIds.delete(userId);
            } else {
                selectedUserIds.add(userId);
            }
            renderEmail();
        }
        
        function selectAllEmailUsers() {
            selectedUserIds = new Set(emailUsers.map(u => u.id));
            renderEmail();
        }
        
        function deselectAllEmailUsers() {
            selectedUserIds.clear();
            renderEmail();
        }
        
        async function sendEmailBlast() {
            const subject = document.getElementById('emailSubject').value.trim();
            const body = document.getElementById('emailBody').value.trim();
            
            if (!subject || !body) {
                showAlert('Please enter subject and body');
                return;
            }
            
            if (selectedUserIds.size === 0) {
                showAlert('Please select at least one recipient');
                return;
            }
            
            const recipientCount = selectedUserIds.size;
            const isAll = recipientCount === emailUsers.length;
            const confirmMsg = isAll 
                ? `Send this email to ALL ${recipientCount} customers?` 
                : `Send this email to ${recipientCount} selected customer${recipientCount !== 1 ? 's' : ''}?`;
            
            if (!confirm(confirmMsg + ' This cannot be undone.')) {
                return;
            }
            
            try {
                const result = await api('/api/admin/email-blast/send', {
                    method: 'POST',
                    body: JSON.stringify({ 
                        subject, 
                        body, 
                        user_ids: Array.from(selectedUserIds)
                    })
                });
                
                showAlert('Email sent to ' + result.sent + ' customer' + (result.sent !== 1 ? 's' : '') + '!' + (result.failed > 0 ? ' (' + result.failed + ' failed)' : ''), 'success');
                document.getElementById('emailSubject').value = '';
                document.getElementById('emailBody').value = '';
                loadEmail();
            } catch (err) {
                showAlert(err.message);
            }
        }
        
        function viewEmailBlast(id) {
            const e = emailHistory.find(x => x.id === id);
            if (!e) return;
            
            document.getElementById('modalContainer').innerHTML = `
                <div class="modal" onclick="if(event.target===this)closeModal()">
                    <div class="modal-content" style="max-width: 600px;">
                        <h3>üìß Sent Email</h3>
                        <p style="color: #718096; margin-bottom: 15px;">
                            Sent on ${new Date(e.created_at).toLocaleString()} to ${e.recipients_count} recipients
                        </p>
                        <div style="background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 8px;">
                            <div style="background: #667eea; color: white; padding: 20px; text-align: center; border-radius: 8px 8px 0 0;">
                                <h2 style="margin: 0;">üß™ The Peptide Wizard</h2>
                            </div>
                            <div style="padding: 20px;">
                                <p style="font-weight: 600; color: #2d3748; border-bottom: 1px solid #e2e8f0; padding-bottom: 10px;">
                                    Subject: ${escapeHtml(e.subject)}
                                </p>
                                <div style="white-space: pre-wrap; color: #4a5568; line-height: 1.6;">${escapeHtml(e.body)}</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                            <button class="btn" onclick="reuseEmailBlast(${id})">üìù Use as Template</button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function reuseEmailBlast(id) {
            const e = emailHistory.find(x => x.id === id);
            if (!e) return;
            
            document.getElementById('emailSubject').value = e.subject;
            document.getElementById('emailBody').value = e.body;
            closeModal();
            showAlert('Template loaded - edit and send!', 'success');
        }

        // Notifications
        async function loadNotifications() {
            try {
                state.notifications = await api('/api/admin/notifications');
                renderNotifications();
            } catch (e) {
                showAlert('Failed to load notifications');
            }
        }

        function renderNotifications() {
            const content = document.getElementById('tabContent');
            content.innerHTML = `
                <p style="color: #718096; margin-bottom: 15px;">Last 100 notification attempts</p>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Channel</th>
                                <th>Recipient</th>
                                <th>Status</th>
                                <th>Sent At</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${state.notifications.map(n => `
                                <tr>
                                    <td>${n.notification_type}</td>
                                    <td>${n.channel}</td>
                                    <td>${n.recipient}</td>
                                    <td><span class="status-badge status-${n.status === 'sent' ? 'paid' : 'cancelled'}">${n.status}</span></td>
                                    <td>${new Date(n.sent_at).toLocaleString()}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Open Orders
        async function loadOpenOrders() {
            try {
                state.orders = await api('/api/admin/orders');
                renderOpenOrders();
            } catch (e) {
                showAlert('Failed to load orders');
            }
        }

        function renderOpenOrders() {
            const openOrders = state.orders.filter(o => 
                !['fulfilled', 'delivered', 'cancelled', 'refunded'].includes(o.status)
            );
            
            const content = document.getElementById('tabContent');
            content.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div>
                        <h3 style="color: #2d3748; margin: 0;">Open Orders (${openOrders.length})</h3>
                        <p style="color: #718096; font-size: 0.9rem; margin: 5px 0 0 0;">Orders that need to be fulfilled</p>
                    </div>
                    ${openOrders.length > 0 ? '<button class="btn btn-secondary" onclick="printOpenOrders()">üñ®Ô∏è Print Pick List</button>' : ''}
                </div>
                ${openOrders.length === 0 ? '<p style="text-align: center; color: #718096; padding: 40px;">üéâ No open orders! All caught up.</p>' : `
                    <div style="overflow-x: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Order #</th>
                                    <th>Customer</th>
                                    <th>Items</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${openOrders.map(o => `
                                    <tr>
                                        <td><strong>${escapeHtml(o.order_number)}</strong></td>
                                        <td>${escapeHtml(o.full_name || o.customer_name || 'Unknown')}<br><small style="color:#718096;">${escapeHtml(o.email || o.customer_email || '')}</small></td>
                                        <td>${o.items ? o.items.length : 0} items</td>
                                        <td>$${parseFloat(o.total || 0).toFixed(2)}</td>
                                        <td><span class="status-badge status-${o.status}">${o.status}</span></td>
                                        <td>${new Date(o.created_at).toLocaleDateString()}</td>
                                        <td class="actions">
                                            <button class="btn btn-small" onclick="showOpenOrderDetailModal(${o.id})">View</button>
                                            <button class="btn btn-success btn-small" onclick="markOrderFulfilled(${o.id})">‚úì Complete</button>
                                            <button class="btn btn-danger btn-small" onclick="cancelOrder(${o.id})">‚úó Cancel</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `}
            `;
        }
        
        function printOpenOrders() {
            const openOrders = state.orders.filter(o => 
                !['fulfilled', 'delivered', 'cancelled', 'refunded'].includes(o.status)
            );
            
            let html = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Open Orders - Pick List</title>
                    <style>
                        body { font-family: Arial, sans-serif; font-size: 12px; margin: 20px; }
                        h1 { font-size: 18px; margin-bottom: 5px; }
                        .date { color: #666; margin-bottom: 20px; }
                        .order { border: 1px solid #333; margin-bottom: 20px; page-break-inside: avoid; }
                        .order-header { background: #f0f0f0; padding: 10px; border-bottom: 1px solid #333; }
                        .order-header h2 { margin: 0; font-size: 14px; }
                        .customer { margin: 5px 0; }
                        .items { padding: 10px; }
                        .items table { width: 100%; border-collapse: collapse; }
                        .items th, .items td { border: 1px solid #ccc; padding: 5px; text-align: left; }
                        .items th { background: #f9f9f9; }
                        .checkbox { width: 30px; text-align: center; }
                        .qty { width: 50px; text-align: center; font-weight: bold; }
                        .notes { background: #fffde7; padding: 8px; margin-top: 10px; border-left: 3px solid #ffc107; }
                        .shipping { background: #e3f2fd; padding: 8px; margin-top: 10px; }
                        @media print {
                            .order { page-break-inside: avoid; }
                        }
                    </style>
                </head>
                <body>
                    <h1>üß™ The Peptide Wizard - Pick List</h1>
                    <div class="date">Generated: ${new Date().toLocaleString()} | ${openOrders.length} orders</div>
            `;
            
            openOrders.forEach(o => {
                html += `
                    <div class="order">
                        <div class="order-header">
                            <h2>Order: ${escapeHtml(o.order_number)} | ${o.status.toUpperCase()}</h2>
                            <div class="customer">
                                <strong>${escapeHtml(o.full_name || o.customer_name || 'Unknown')}</strong> | 
                                ${escapeHtml(o.email || o.customer_email || '-')} | 
                                ${escapeHtml(o.phone || o.customer_phone || '-')}
                            </div>
                            <div>Date: ${new Date(o.created_at).toLocaleString()} | Total: $${parseFloat(o.total || 0).toFixed(2)}${o.discount_code ? ' | <strong>Code: ' + escapeHtml(o.discount_code) + '</strong>' : ''}${parseFloat(o.discount_amount || 0) > 0 ? ' (Discount: -$' + parseFloat(o.discount_amount).toFixed(2) + ')' : ''}</div>
                        </div>
                        <div class="items">
                            <table>
                                <thead>
                                    <tr>
                                        <th class="checkbox">‚úì</th>
                                        <th>SKU</th>
                                        <th>Product</th>
                                        <th class="qty">Qty</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                if (o.items && o.items.length > 0) {
                    o.items.forEach(i => {
                        html += `
                            <tr>
                                <td class="checkbox">‚òê</td>
                                <td><strong>${escapeHtml(i.sku || '-')}</strong></td>
                                <td>${escapeHtml(i.name || '-')}</td>
                                <td class="qty">${i.quantity}</td>
                            </tr>
                        `;
                    });
                }
                
                html += `
                                </tbody>
                            </table>
                `;
                
                if (o.notes) {
                    html += `<div class="notes"><strong>Notes:</strong> ${escapeHtml(o.notes)}</div>`;
                }
                
                if (o.delivery_method === 'ship' && o.shipping_address) {
                    html += `<div class="shipping"><strong>üì¶ SHIP TO:</strong><br>${escapeHtml(o.shipping_address).replace(/\n/g, '<br>')}</div>`;
                } else {
                    html += `<div class="shipping"><strong>üè™ PICKUP</strong></div>`;
                }
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            html += `
                </body>
                </html>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(html);
            printWindow.document.close();
            printWindow.print();
        }

        function showOpenOrderDetailModal(id) {
            const o = state.orders.find(x => x.id === id);
            if (!o) return;
            
            document.getElementById('modalContainer').innerHTML = `
                <div class="modal" onclick="if(event.target===this)closeModal()">
                    <div class="modal-content">
                        <h3>Order ${o.order_number}</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                            <div>
                                <p><strong>Customer:</strong> ${o.full_name || o.customer_name || 'Unknown'}</p>
                                <p><strong>Email:</strong> ${o.email || o.customer_email || '-'}</p>
                                <p><strong>Phone:</strong> ${o.phone || o.customer_phone || '-'}</p>
                            </div>
                            <div>
                                <p><strong>Status:</strong> <span class="status-badge status-${o.status}">${o.status}</span></p>
                                <p><strong>Delivery:</strong> ${o.delivery_method === 'ship' ? 'üì¶ Ship' : 'üè™ Pickup'}</p>
                                <p><strong>Date:</strong> ${new Date(o.created_at).toLocaleString()}</p>
                            </div>
                        </div>
                        ${o.shipping_address && o.delivery_method === 'ship' ? `
                            <p><strong>Shipping Address:</strong></p>
                            <p style="background: #f7fafc; padding: 10px; border-radius: 6px; margin-bottom: 15px; white-space: pre-line;">${o.shipping_address}</p>
                        ` : ''}
                        <h4 style="margin-bottom: 10px;">Items to Ship</h4>
                        <table>
                            <thead><tr><th>Product</th><th>SKU</th><th>Qty</th><th>Unit Price</th><th>Subtotal</th></tr></thead>
                            <tbody>
                                ${o.items && o.items.length > 0 ? o.items.map(i => `
                                    <tr>
                                        <td>${i.name || i.product_name || 'Unknown'}</td>
                                        <td>${i.sku || '-'}</td>
                                        <td><strong>${i.quantity}</strong></td>
                                        <td>$${parseFloat(i.unit_price || i.price_each || 0).toFixed(2)}</td>
                                        <td>$${(i.quantity * parseFloat(i.unit_price || i.price_each || 0)).toFixed(2)}</td>
                                    </tr>
                                `).join('') : '<tr><td colspan="5">No items found</td></tr>'}
                            </tbody>
                        </table>
                        <div style="text-align: right; margin-top: 15px; padding: 15px; background: #f7fafc; border-radius: 8px;">
                            <p>Subtotal: $${parseFloat(o.subtotal || 0).toFixed(2)}</p>
                            ${o.discount_code ? `<p style="color: #2b6cb0;">Discount Code: <strong>${escapeHtml(o.discount_code)}</strong></p>` : ''}
                            ${parseFloat(o.discount_amount || 0) > 0 ? `<p style="color: #38a169;">Discount: -$${parseFloat(o.discount_amount).toFixed(2)}</p>` : ''}
                            ${parseFloat(o.shipping_cost || 0) > 0 ? `<p>Shipping: $${parseFloat(o.shipping_cost).toFixed(2)}</p>` : ''}
                            ${parseFloat(o.credit_applied || 0) > 0 ? `<p style="color: #805ad5;">Store Credit: -$${parseFloat(o.credit_applied).toFixed(2)}</p>` : ''}
                            <p style="font-size: 1.2rem; font-weight: 700; margin-top: 10px; padding-top: 10px; border-top: 2px solid #e2e8f0;">Total: $${parseFloat(o.total || 0).toFixed(2)}</p>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                            <button class="btn" onclick="showEditOrderModal(${o.id})">‚úèÔ∏è Edit Order</button>
                            <button class="btn btn-success" onclick="markOrderFulfilled(${o.id}); closeModal();">‚úì Mark as Fulfilled</button>
                            <button class="btn btn-danger" onclick="cancelOrder(${o.id}); closeModal();">‚úó Cancel Order</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function showEditOrderModal(id) {
            const o = state.orders.find(x => x.id === id);
            if (!o) return;
            
            const itemsHtml = o.items && o.items.length > 0 ? o.items.map(i => `
                <div class="edit-item-row" style="display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid #e2e8f0;">
                    <div style="flex: 1;">
                        <strong>${escapeHtml(i.name || 'Unknown')}</strong>
                        <div style="font-size: 0.85rem; color: #718096;">${escapeHtml(i.sku || '')} @ $${parseFloat(i.unit_price || 0).toFixed(2)} each</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <label style="font-size: 0.85rem; color: #718096;">Qty:</label>
                        <input type="number" class="edit-item-qty" data-item-id="${i.id}" data-unit-price="${i.unit_price || 0}" 
                               value="${i.quantity}" min="0" style="width: 60px; padding: 5px; border: 1px solid #e2e8f0; border-radius: 4px;"
                               onchange="recalculateEditSubtotal()">
                    </div>
                    <div style="width: 80px; text-align: right; font-weight: 500;" id="itemSubtotal_${i.id}">
                        $${(i.quantity * parseFloat(i.unit_price || 0)).toFixed(2)}
                    </div>
                </div>
            `).join('') : '<p style="color: #718096;">No items</p>';
            
            document.getElementById('modalContainer').innerHTML = `
                <div class="modal" onclick="if(event.target===this)closeModal()">
                    <div class="modal-content" style="max-width: 600px;">
                        <h3>‚úèÔ∏è Edit Order ${escapeHtml(o.order_number)}</h3>
                        <p style="color: #718096; margin-bottom: 20px;">Customer: ${escapeHtml(o.full_name || 'Unknown')}</p>
                        
                        <div style="margin-bottom: 20px;">
                            <h4 style="margin-bottom: 10px;">Order Items</h4>
                            <p style="font-size: 0.85rem; color: #718096; margin-bottom: 10px;">Set quantity to 0 to remove an item. Stock will be adjusted automatically.</p>
                            <div style="border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden;">
                                ${itemsHtml}
                            </div>
                            <div style="text-align: right; padding: 10px; background: #f7fafc; border-radius: 0 0 8px 8px;">
                                <span style="color: #718096;">New Subtotal:</span> 
                                <strong id="editNewSubtotal">$${parseFloat(o.subtotal || 0).toFixed(2)}</strong>
                            </div>
                        </div>
                        
                        <form onsubmit="submitOrderEdit(event, ${o.id})">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="form-group" style="margin-bottom: 10px;">
                                    <label>Apply Discount Code</label>
                                    <input type="text" id="editDiscountCode" placeholder="e.g. SAVE10" style="text-transform: uppercase;">
                                </div>
                                
                                <div class="form-group" style="margin-bottom: 10px;">
                                    <label>OR Manual Discount ($)</label>
                                    <input type="number" id="editManualDiscount" step="0.01" min="0" value="${parseFloat(o.discount_amount || 0).toFixed(2)}">
                                </div>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 10px;">
                                <label>Shipping Cost ($)</label>
                                <input type="number" id="editShippingCost" step="0.01" min="0" value="${parseFloat(o.shipping_cost || 0).toFixed(2)}" style="width: 120px;">
                            </div>
                            
                            <div class="form-group">
                                <label>Reason for Edit <span style="color: #e53e3e;">*</span></label>
                                <input type="text" id="editNote" placeholder="e.g. Customer requested quantity change" required>
                            </div>
                            
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                                <button type="submit" class="btn btn-success">üíæ Save Changes</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        function recalculateEditSubtotal() {
            let newSubtotal = 0;
            document.querySelectorAll('.edit-item-qty').forEach(input => {
                const qty = parseInt(input.value) || 0;
                const unitPrice = parseFloat(input.dataset.unitPrice) || 0;
                const itemId = input.dataset.itemId;
                const itemTotal = qty * unitPrice;
                newSubtotal += itemTotal;
                
                const subtotalEl = document.getElementById('itemSubtotal_' + itemId);
                if (subtotalEl) {
                    subtotalEl.textContent = '$' + itemTotal.toFixed(2);
                    subtotalEl.style.color = qty === 0 ? '#e53e3e' : 'inherit';
                    subtotalEl.style.textDecoration = qty === 0 ? 'line-through' : 'none';
                }
            });
            
            document.getElementById('editNewSubtotal').textContent = '$' + newSubtotal.toFixed(2);
        }

        async function submitOrderEdit(e, orderId) {
            e.preventDefault();
            
            const discountCode = document.getElementById('editDiscountCode').value.trim();
            const manualDiscount = document.getElementById('editManualDiscount').value;
            const shippingCost = document.getElementById('editShippingCost').value;
            const editNote = document.getElementById('editNote').value.trim();
            
            // Gather item quantities
            const items = [];
            document.querySelectorAll('.edit-item-qty').forEach(input => {
                items.push({
                    id: parseInt(input.dataset.itemId),
                    quantity: parseInt(input.value) || 0
                });
            });
            
            const payload = {
                edit_note: editNote,
                shipping_cost: parseFloat(shippingCost) || 0,
                items: items
            };
            
            // If discount code entered, use that; otherwise use manual discount
            if (discountCode) {
                payload.discount_code = discountCode;
            } else {
                payload.manual_discount = parseFloat(manualDiscount) || 0;
            }
            
            try {
                const result = await api('/api/admin/orders/' + orderId + '/edit', {
                    method: 'PUT',
                    body: JSON.stringify(payload)
                });
                
                showAlert('Order updated! New total: $' + parseFloat(result.new_total).toFixed(2), 'success');
                closeModal();
                
                // Reload orders to reflect changes
                if (state.currentTab === 'openOrders') {
                    loadOpenOrders();
                } else {
                    loadOrders();
                }
                
            } catch (err) {
                showAlert('Error: ' + err.message, 'error');
            }
        }

        async function markOrderFulfilled(id) {
            if (!confirm('Mark this order as fulfilled?')) return;
            try {
                await api(`/api/admin/orders/${id}/status`, {
                    method: 'PUT',
                    body: JSON.stringify({ status: 'fulfilled' })
                });
                showAlert('Order marked as fulfilled!', 'success');
                loadOpenOrders();
            } catch (err) {
                showAlert(err.message);
            }
        }

        async function cancelOrder(id) {
            if (!confirm('Are you sure you want to cancel this order? This will remove it from revenue calculations.')) return;
            try {
                await api(`/api/admin/orders/${id}/status`, {
                    method: 'PUT',
                    body: JSON.stringify({ status: 'cancelled' })
                });
                showAlert('Order cancelled!', 'success');
                loadOpenOrders();
                loadStats();
            } catch (err) {
                showAlert(err.message);
            }
        }

        // ============================================
        // PURCHASE ORDERS
        // ============================================
        
        async function loadPurchaseOrders() {
            try {
                const url = state.poFilter ? `/api/admin/po?status=${state.poFilter}` : '/api/admin/po';
                state.purchaseOrders = await api(url);
                renderPurchaseOrders();
            } catch (e) {
                showAlert('Failed to load purchase orders: ' + e.message);
            }
        }

        function renderPurchaseOrders() {
            const content = document.getElementById('tabContent');
            const pos = state.purchaseOrders;
            
            content.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                    <h3 style="margin: 0;">üì¶ Purchase Orders</h3>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select onchange="state.poFilter=this.value;loadPurchaseOrders()" style="padding: 8px; border-radius: 6px; border: 1px solid #e2e8f0;">
                            <option value="">All POs</option>
                            <option value="draft" ${state.poFilter==='draft'?'selected':''}>Draft</option>
                            <option value="submitted" ${state.poFilter==='submitted'?'selected':''}>Submitted</option>
                            <option value="partial" ${state.poFilter==='partial'?'selected':''}>Partial</option>
                            <option value="received" ${state.poFilter==='received'?'selected':''}>Received</option>
                            <option value="closed" ${state.poFilter==='closed'?'selected':''}>Closed</option>
                        </select>
                        <button class="btn" onclick="showCreatePOModal()">+ New PO</button>
                        <button class="btn btn-secondary" onclick="showQuickPOFromLowStock()">‚ö° Quick PO from Low Stock</button>
                    </div>
                </div>
                
                ${pos.length === 0 ? '<p style="text-align: center; color: #718096; padding: 40px;">No purchase orders found.</p>' : `
                    <div style="overflow-x: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>PO Number</th>
                                    <th>Supplier</th>
                                    <th>Items</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${pos.map(po => {
                                    const statusColors = {
                                        draft: '#718096',
                                        submitted: '#3182ce',
                                        partial: '#d69e2e',
                                        received: '#38a169',
                                        closed: '#a0aec0',
                                        open: '#805ad5'
                                    };
                                    return `
                                        <tr>
                                            <td><strong>${escapeHtml(po.po_number)}</strong></td>
                                            <td>${escapeHtml(po.supplier_name || 'Primary Supplier')}</td>
                                            <td>${po.items ? po.items.length : 0} items</td>
                                            <td><span style="background: ${statusColors[po.status] || '#718096'}; color: white; padding: 3px 10px; border-radius: 12px; font-size: 0.8rem;">${po.status.toUpperCase()}</span></td>
                                            <td>${new Date(po.created_at).toLocaleDateString()}</td>
                                            <td class="actions">
                                                <button class="btn btn-small" onclick="showPODetail(${po.id})">View</button>
                                                ${po.status === 'draft' || po.status === 'open' ? `<button class="btn btn-small btn-success" onclick="showPOWhatsApp(${po.id})">üì± WhatsApp</button>` : ''}
                                                ${po.status === 'submitted' || po.status === 'partial' ? `<button class="btn btn-small btn-success" onclick="showReceivePO(${po.id})">üì• Receive</button>` : ''}
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `}
            `;
        }

        function showCreatePOModal() {
            document.getElementById('modalContainer').innerHTML = `
                <div class="modal" onclick="if(event.target===this)closeModal()">
                    <div class="modal-content" style="max-width: 400px;">
                        <h3>üì¶ Create New Purchase Order</h3>
                        <form onsubmit="createPO(event)">
                            <div class="form-group">
                                <label>Supplier Name</label>
                                <input type="text" id="poSupplier" value="Primary Supplier" placeholder="Supplier name">
                            </div>
                            <div class="form-group">
                                <label>Notes</label>
                                <textarea id="poNotes" rows="2" placeholder="Optional notes"></textarea>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                                <button type="submit" class="btn btn-success">Create PO</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        async function createPO(e) {
            e.preventDefault();
            try {
                const result = await api('/api/admin/po', {
                    method: 'POST',
                    body: JSON.stringify({
                        supplier_name: document.getElementById('poSupplier').value,
                        notes: document.getElementById('poNotes').value
                    })
                });
                showAlert(`PO ${result.po_number} created!`, 'success');
                closeModal();
                loadPurchaseOrders();
                // Open the new PO for editing
                showPODetail(result.po_id);
            } catch (err) {
                showAlert(err.message);
            }
        }

        async function showQuickPOFromLowStock() {
            try {
                const lowStock = await api('/api/admin/po/low-stock-items');
                
                if (lowStock.length === 0) {
                    showAlert('No low stock items found!', 'success');
                    return;
                }
                
                document.getElementById('modalContainer').innerHTML = `
                    <div class="modal" onclick="if(event.target===this)closeModal()">
                        <div class="modal-content" style="max-width: 700px;">
                            <h3>‚ö° Quick PO from Low Stock Items</h3>
                            <p style="color: #718096; margin-bottom: 15px;">Select items to include in the new PO:</p>
                            
                            <div style="max-height: 400px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px;">
                                <table>
                                    <thead style="position: sticky; top: 0; background: white;">
                                        <tr>
                                            <th style="width: 40px;"><input type="checkbox" onchange="toggleAllLowStock(this.checked)" checked></th>
                                            <th>SKU</th>
                                            <th>Product</th>
                                            <th>Stock</th>
                                            <th>Order Qty</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${lowStock.map(item => `
                                            <tr>
                                                <td><input type="checkbox" class="low-stock-check" data-id="${item.id}" checked></td>
                                                <td>${escapeHtml(item.sku)}</td>
                                                <td>${escapeHtml(item.name)}</td>
                                                <td style="color: ${item.stock <= 5 ? '#e53e3e' : '#d69e2e'}; font-weight: 600;">${item.stock}</td>
                                                <td><input type="number" class="low-stock-qty" data-id="${item.id}" value="${item.reorder_qty || 10}" min="1" style="width: 70px; padding: 5px;"></td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                            
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                                <button class="btn btn-success" onclick="createPOFromLowStock()">Create PO with Selected Items</button>
                            </div>
                        </div>
                    </div>
                `;
            } catch (err) {
                showAlert('Error loading low stock: ' + err.message);
            }
        }

        function toggleAllLowStock(checked) {
            document.querySelectorAll('.low-stock-check').forEach(cb => cb.checked = checked);
        }

        async function createPOFromLowStock() {
            try {
                // First create the PO
                const result = await api('/api/admin/po', {
                    method: 'POST',
                    body: JSON.stringify({ supplier_name: 'Primary Supplier', notes: 'Auto-generated from low stock' })
                });
                
                // Then add selected items
                const items = [];
                document.querySelectorAll('.low-stock-check:checked').forEach(cb => {
                    const id = cb.dataset.id;
                    const qty = document.querySelector(`.low-stock-qty[data-id="${id}"]`).value;
                    items.push({ product_id: parseInt(id), quantity: parseInt(qty) });
                });
                
                for (const item of items) {
                    await api(`/api/admin/po/${result.po_id}/items`, {
                        method: 'POST',
                        body: JSON.stringify(item)
                    });
                }
                
                showAlert(`PO ${result.po_number} created with ${items.length} items!`, 'success');
                closeModal();
                loadPurchaseOrders();
                showPODetail(result.po_id);
            } catch (err) {
                showAlert(err.message);
            }
        }

        async function showPODetail(poId) {
            try {
                const po = await api(`/api/admin/po/${poId}`);
                state.currentPO = po;
                
                const isEditable = po.status === 'draft' || po.status === 'open';
                const totalCost = po.items.reduce((sum, i) => sum + (i.quantity_ordered * i.unit_cost), 0);
                
                document.getElementById('modalContainer').innerHTML = `
                    <div class="modal" onclick="if(event.target===this)closeModal()">
                        <div class="modal-content" style="max-width: 800px;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">
                                <div>
                                    <h3 style="margin: 0;">üì¶ ${escapeHtml(po.po_number)}</h3>
                                    <p style="color: #718096; margin: 5px 0;">Supplier: ${escapeHtml(po.supplier_name || 'Primary Supplier')}</p>
                                </div>
                                <span style="background: ${getStatusColor(po.status)}; color: white; padding: 5px 15px; border-radius: 15px;">${po.status.toUpperCase()}</span>
                            </div>
                            
                            ${isEditable ? `
                                <div style="margin-bottom: 20px; padding: 15px; background: #f7fafc; border-radius: 8px;">
                                    <strong>Add Item:</strong>
                                    <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                                        <select id="addPoProductId" style="flex: 1; min-width: 200px; padding: 8px;">
                                            <option value="">Select product...</option>
                                            ${state.products.filter(p => p.active).map(p => `<option value="${p.id}">${p.sku} - ${p.name}</option>`).join('')}
                                        </select>
                                        <input type="number" id="addPoQty" value="10" min="1" style="width: 80px; padding: 8px;" placeholder="Qty">
                                        <button class="btn btn-success" onclick="addItemToPO(${po.id})">+ Add</button>
                                    </div>
                                </div>
                            ` : ''}
                            
                            <div style="max-height: 350px; overflow-y: auto;">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>SKU</th>
                                            <th>Product</th>
                                            <th>Packs Ordered</th>
                                            <th>Pack Size</th>
                                            <th>Units (Stock)</th>
                                            <th>Received</th>
                                            <th>Unit Cost</th>
                                            <th>Total</th>
                                            ${isEditable ? '<th>Actions</th>' : ''}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${po.items.length === 0 ? '<tr><td colspan="9" style="text-align: center; color: #718096;">No items yet</td></tr>' : 
                                            po.items.map(i => {
                                                const packSize = i.supplier_pack_size || 1;
                                                const totalUnits = i.quantity_ordered * packSize;
                                                const receivedUnits = i.quantity_received * packSize;
                                                return `
                                                <tr style="${i.quantity_received >= i.quantity_ordered ? 'background: #c6f6d5;' : i.quantity_received > 0 ? 'background: #fefcbf;' : ''}">
                                                    <td><strong>${escapeHtml(i.sku)}</strong></td>
                                                    <td>${escapeHtml(i.name)}</td>
                                                    <td>${isEditable ? `<input type="number" value="${i.quantity_ordered}" min="0" style="width: 60px;" onchange="updatePOItemQty(${po.id}, ${i.id}, this.value)">` : i.quantity_ordered}</td>
                                                    <td style="color: #718096;">${packSize}/pack</td>
                                                    <td><strong>${totalUnits}</strong></td>
                                                    <td>${i.quantity_received} packs (${receivedUnits} units)</td>
                                                    <td>$${parseFloat(i.unit_cost || 0).toFixed(2)}</td>
                                                    <td>$${(i.quantity_ordered * (i.unit_cost || 0)).toFixed(2)}</td>
                                                    ${isEditable ? `<td><button class="btn btn-danger btn-small" onclick="removePOItem(${po.id}, ${i.id})">‚úï</button></td>` : ''}
                                                </tr>
                                            `}).join('')
                                        }
                                    </tbody>
                                </table>
                            </div>
                            
                            <div style="text-align: right; margin-top: 15px; padding: 15px; background: #f7fafc; border-radius: 8px;">
                                <strong>Total: $${totalCost.toFixed(2)}</strong>
                            </div>
                            
                            <div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
                                <button class="btn btn-secondary" onclick="closeModal(); loadPurchaseOrders();">Close</button>
                                ${po.status === 'draft' && po.items.length > 0 ? `<button class="btn" onclick="showPOWhatsApp(${po.id})">üì± WhatsApp Text</button>` : ''}
                                ${po.status === 'draft' && po.items.length > 0 ? `<button class="btn btn-success" onclick="submitPO(${po.id})">‚úì Mark as Submitted</button>` : ''}
                                ${po.status === 'submitted' || po.status === 'partial' ? `<button class="btn btn-success" onclick="showReceivePO(${po.id})">üì• Receive Items</button>` : ''}
                                ${po.status === 'submitted' || po.status === 'partial' ? `<button class="btn" onclick="showBackorderText(${po.id})">üì± Backorder Follow-up</button>` : ''}
                                ${po.status !== 'closed' && po.status !== 'draft' ? `<button class="btn btn-warning" onclick="closePO(${po.id})">Close PO</button>` : ''}
                                ${po.status === 'closed' ? `<button class="btn" onclick="reopenPO(${po.id})">Reopen PO</button>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            } catch (err) {
                showAlert('Error loading PO: ' + err.message);
            }
        }

        function getStatusColor(status) {
            const colors = { draft: '#718096', submitted: '#3182ce', partial: '#d69e2e', received: '#38a169', closed: '#a0aec0', open: '#805ad5' };
            return colors[status] || '#718096';
        }

        async function addItemToPO(poId) {
            const productId = document.getElementById('addPoProductId').value;
            const qty = document.getElementById('addPoQty').value;
            
            if (!productId) {
                showAlert('Please select a product');
                return;
            }
            
            try {
                await api(`/api/admin/po/${poId}/items`, {
                    method: 'POST',
                    body: JSON.stringify({ product_id: parseInt(productId), quantity: parseInt(qty) })
                });
                showPODetail(poId);
            } catch (err) {
                showAlert(err.message);
            }
        }

        async function updatePOItemQty(poId, itemId, qty) {
            try {
                await api(`/api/admin/po/${poId}/items/${itemId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ quantity_ordered: parseInt(qty) })
                });
                // Always refresh to show updated totals
                showPODetail(poId);
            } catch (err) {
                showAlert(err.message);
            }
        }

        async function removePOItem(poId, itemId) {
            if (!confirm('Remove this item from PO?')) return;
            try {
                await api(`/api/admin/po/${poId}/items/${itemId}`, { method: 'DELETE' });
                showPODetail(poId);
            } catch (err) {
                showAlert(err.message);
            }
        }

        async function submitPO(poId) {
            if (!confirm('Mark this PO as submitted/ordered?')) return;
            try {
                await api(`/api/admin/po/${poId}/submit`, { method: 'POST' });
                showAlert('PO marked as submitted!', 'success');
                showPODetail(poId);
            } catch (err) {
                showAlert(err.message);
            }
        }

        async function showPOWhatsApp(poId) {
            try {
                const result = await api(`/api/admin/po/${poId}/whatsapp`);
                
                document.getElementById('modalContainer').innerHTML = `
                    <div class="modal" onclick="if(event.target===this)closeModal()">
                        <div class="modal-content" style="max-width: 500px;">
                            <h3>üì± WhatsApp Order Text</h3>
                            <p style="color: #718096; margin-bottom: 15px;">Copy this text and paste into WhatsApp:</p>
                            
                            <textarea id="whatsappText" style="width: 100%; height: 300px; font-family: monospace; padding: 15px; border: 1px solid #e2e8f0; border-radius: 8px; resize: vertical;">${escapeHtml(result.text)}</textarea>
                            
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button class="btn btn-secondary" onclick="showPODetail(${poId})">Back to PO</button>
                                <button class="btn btn-success" onclick="copyWhatsAppText()">üìã Copy to Clipboard</button>
                            </div>
                        </div>
                    </div>
                `;
            } catch (err) {
                showAlert(err.message);
            }
        }

        async function showBackorderText(poId) {
            try {
                const result = await api(`/api/admin/po/${poId}/backorder-text`);
                
                document.getElementById('modalContainer').innerHTML = `
                    <div class="modal" onclick="if(event.target===this)closeModal()">
                        <div class="modal-content" style="max-width: 500px;">
                            <h3>üì± Backorder Follow-up Text</h3>
                            <p style="color: #718096; margin-bottom: 15px;">Copy this text to follow up on outstanding items:</p>
                            
                            <textarea id="whatsappText" style="width: 100%; height: 300px; font-family: monospace; padding: 15px; border: 1px solid #e2e8f0; border-radius: 8px; resize: vertical;">${escapeHtml(result.text)}</textarea>
                            
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button class="btn btn-secondary" onclick="showPODetail(${poId})">Back to PO</button>
                                <button class="btn btn-success" onclick="copyWhatsAppText()">üìã Copy to Clipboard</button>
                            </div>
                        </div>
                    </div>
                `;
            } catch (err) {
                showAlert(err.message);
            }
        }

        function copyWhatsAppText() {
            const text = document.getElementById('whatsappText');
            text.select();
            document.execCommand('copy');
            showAlert('Copied to clipboard!', 'success');
        }

        async function showReceivePO(poId) {
            try {
                const po = await api(`/api/admin/po/${poId}`);
                
                // Only show items that aren't fully received
                const pendingItems = po.items.filter(i => i.quantity_received < i.quantity_ordered);
                
                document.getElementById('modalContainer').innerHTML = `
                    <div class="modal" onclick="if(event.target===this)closeModal()">
                        <div class="modal-content" style="max-width: 800px;">
                            <h3>üì• Receive Items - ${escapeHtml(po.po_number)}</h3>
                            <p style="color: #718096; margin-bottom: 15px;">Enter number of <strong>packs</strong> received (units will be calculated automatically):</p>
                            
                            <div style="max-height: 400px; overflow-y: auto;">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>SKU</th>
                                            <th>Product</th>
                                            <th>Pack Size</th>
                                            <th>Packs Ordered</th>
                                            <th>Packs Rcvd</th>
                                            <th>Receiving (packs)</th>
                                            <th>Units to Add</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${pendingItems.map(i => {
                                            const packSize = i.supplier_pack_size || 1;
                                            const remaining = i.quantity_ordered - i.quantity_received;
                                            return `
                                            <tr>
                                                <td><strong>${escapeHtml(i.sku)}</strong></td>
                                                <td>${escapeHtml(i.name)}</td>
                                                <td style="color: #718096;">${packSize}/pack</td>
                                                <td>${i.quantity_ordered}</td>
                                                <td>${i.quantity_received}</td>
                                                <td>
                                                    <input type="number" class="receive-qty" data-id="${i.id}" data-pack-size="${packSize}"
                                                           value="${remaining}" 
                                                           min="0" max="${remaining}"
                                                           style="width: 70px; padding: 8px;"
                                                           onchange="updateUnitsPreview(this)">
                                                </td>
                                                <td class="units-preview" style="font-weight: 600; color: #38a169;">+${remaining * packSize} units</td>
                                            </tr>
                                        `}).join('')}
                                    </tbody>
                                </table>
                            </div>
                            
                            ${pendingItems.length === 0 ? '<p style="text-align: center; color: #38a169; padding: 20px;">All items have been received!</p>' : ''}
                            
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button class="btn btn-secondary" onclick="showPODetail(${poId})">Cancel</button>
                                ${pendingItems.length > 0 ? `<button class="btn btn-success" onclick="receiveItems(${poId})">‚úì Receive & Update Stock</button>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            } catch (err) {
                showAlert(err.message);
            }
        }

        function updateUnitsPreview(input) {
            const packSize = parseInt(input.dataset.packSize) || 1;
            const qty = parseInt(input.value) || 0;
            const units = qty * packSize;
            const row = input.closest('tr');
            row.querySelector('.units-preview').textContent = '+' + units + ' units';
        }

        async function receiveItems(poId) {
            const items = [];
            document.querySelectorAll('.receive-qty').forEach(input => {
                const qty = parseInt(input.value) || 0;
                if (qty > 0) {
                    items.push({ id: parseInt(input.dataset.id), quantity_received: qty });
                }
            });
            
            if (items.length === 0) {
                showAlert('No items to receive');
                return;
            }
            
            try {
                await api(`/api/admin/po/${poId}/receive`, {
                    method: 'POST',
                    body: JSON.stringify({ items })
                });
                showAlert('Items received and stock updated!', 'success');
                showPODetail(poId);
            } catch (err) {
                showAlert(err.message);
            }
        }

        async function closePO(poId) {
            if (!confirm('Close this PO? You can reopen it later if needed.')) return;
            try {
                await api(`/api/admin/po/${poId}/close`, { method: 'POST' });
                showAlert('PO closed', 'success');
                showPODetail(poId);
            } catch (err) {
                showAlert(err.message);
            }
        }

        async function reopenPO(poId) {
            try {
                await api(`/api/admin/po/${poId}/reopen`, { method: 'POST' });
                showAlert('PO reopened', 'success');
                showPODetail(poId);
            } catch (err) {
                showAlert(err.message);
            }
        }

        // Reports
        async function renderReports() {
            const content = document.getElementById('tabContent');
            const today = new Date().toISOString().split('T')[0];
            const lastMonth = new Date(Date.now() - 30*24*60*60*1000).toISOString().split('T')[0];
            
            content.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;">
                    <div class="card" style="margin-bottom: 0;">
                        <h3 style="margin-bottom: 15px;">üí∞ Financial Report</h3>
                        <p style="color: #718096; margin-bottom: 15px;">Revenue, costs, and margins</p>
                        <div class="form-row" style="margin-bottom: 15px;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label style="font-size: 0.8rem;">Start</label>
                                <input type="date" id="finStartDate" value="${lastMonth}">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label style="font-size: 0.8rem;">End</label>
                                <input type="date" id="finEndDate" value="${today}">
                            </div>
                        </div>
                        <button class="btn" onclick="loadFinancialReport()">Generate Report</button>
                        <div id="financialReportContent" style="margin-top: 20px;"></div>
                    </div>
                    
                    <div class="card" style="margin-bottom: 0;">
                        <h3 style="margin-bottom: 15px;">üì¶ Inventory & Reorder</h3>
                        <p style="color: #718096; margin-bottom: 15px;">Stock levels based on per-product reorder quantities</p>
                        <div class="form-row" style="margin-bottom: 15px;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label style="font-size: 0.8rem;">Order Threshold $</label>
                                <input type="number" id="orderThreshold" value="1000" min="100" style="width: 100px;">
                                <small style="color: #718096;">Min order to generate</small>
                            </div>
                        </div>
                        <button class="btn" onclick="loadInventoryReport()">Check Inventory</button>
                        <div id="inventoryReportContent" style="margin-top: 20px;"></div>
                    </div>
                    
                    <div class="card" style="margin-bottom: 0;">
                        <h3 style="margin-bottom: 15px;">üìä Discount Code Report</h3>
                        <p style="color: #718096; margin-bottom: 15px;">Sales breakdown by discount code</p>
                        <div class="form-row" style="margin-bottom: 15px;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label style="font-size: 0.8rem;">Start</label>
                                <input type="date" id="discStartDate" value="${lastMonth}">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label style="font-size: 0.8rem;">End</label>
                                <input type="date" id="discEndDate" value="${today}">
                            </div>
                        </div>
                        <button class="btn" onclick="loadDiscountReport()">Generate Report</button>
                        <div id="discountReportContent" style="margin-top: 20px;"></div>
                    </div>
                    
                    <div class="card" style="margin-bottom: 0;">
                        <h3 style="margin-bottom: 15px;">üßæ Order Summary</h3>
                        <p style="color: #718096; margin-bottom: 15px;">Overview of order statuses</p>
                        <div class="form-row" style="margin-bottom: 15px;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label style="font-size: 0.8rem;">Start</label>
                                <input type="date" id="orderStartDate" value="${lastMonth}">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label style="font-size: 0.8rem;">End</label>
                                <input type="date" id="orderEndDate" value="${today}">
                            </div>
                        </div>
                        <button class="btn" onclick="loadOrderSummary()">Generate Report</button>
                        <div id="orderSummaryContent" style="margin-top: 20px;"></div>
                    </div>
                </div>
            `;
        }

        async function loadFinancialReport() {
            const startDate = document.getElementById('finStartDate').value;
            const endDate = document.getElementById('finEndDate').value;
            const container = document.getElementById('financialReportContent');
            
            container.innerHTML = '<p style="color: #718096;">Loading...</p>';
            
            try {
                const report = await api(`/api/admin/reports/financial?start_date=${startDate}&end_date=${endDate}`);
                const s = report.summary;
                const inv = report.inventory;
                
                container.innerHTML = `
                    <div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <div style="text-align: center; padding: 10px; background: white; border-radius: 6px;">
                                <div style="font-size: 1.5rem; font-weight: 600; color: #38a169;">$${s.gross_revenue.toFixed(2)}</div>
                                <div style="font-size: 0.8rem; color: #718096;">Gross Revenue</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: white; border-radius: 6px;">
                                <div style="font-size: 1.5rem; font-weight: 600; color: #e53e3e;">$${s.cogs.toFixed(2)}</div>
                                <div style="font-size: 0.8rem; color: #718096;">Cost of Goods</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: white; border-radius: 6px;">
                                <div style="font-size: 1.5rem; font-weight: 600; color: #2b6cb0;">$${s.gross_profit.toFixed(2)}</div>
                                <div style="font-size: 0.8rem; color: #718096;">Gross Profit</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: white; border-radius: 6px;">
                                <div style="font-size: 1.5rem; font-weight: 600; color: #805ad5;">${s.gross_margin_pct.toFixed(1)}%</div>
                                <div style="font-size: 0.8rem; color: #718096;">Gross Margin</div>
                            </div>
                        </div>
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e2e8f0; display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 0.9rem;">
                            <div><span style="color: #718096;">Orders:</span> <strong>${s.total_orders}</strong></div>
                            <div><span style="color: #718096;">Discounts:</span> <strong>$${s.total_discounts.toFixed(2)}</strong></div>
                            <div><span style="color: #718096;">Inventory Value:</span> <strong>$${inv.total_value.toFixed(2)}</strong></div>
                            <div><span style="color: #718096;">Units in Stock:</span> <strong>${inv.total_units}</strong></div>
                        </div>
                    </div>
                    ${report.products.length > 0 ? `
                        <h4 style="margin-bottom: 10px;">Top Products by Profit</h4>
                        <div style="max-height: 200px; overflow-y: auto;">
                            <table style="font-size: 0.85rem;">
                                <thead><tr><th>Product</th><th>Units</th><th>Revenue</th><th>COGS</th><th>Profit</th></tr></thead>
                                <tbody>
                                    ${report.products.slice(0, 10).map(p => `
                                        <tr>
                                            <td>${p.sku}</td>
                                            <td>${p.units_sold}</td>
                                            <td>$${parseFloat(p.revenue || 0).toFixed(2)}</td>
                                            <td>$${parseFloat(p.cost_of_goods || 0).toFixed(2)}</td>
                                            <td style="color: ${p.gross_profit >= 0 ? '#38a169' : '#e53e3e'};">$${parseFloat(p.gross_profit || 0).toFixed(2)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : '<p style="color: #718096;">No sales in this period.</p>'}
                `;
            } catch (err) {
                container.innerHTML = '<p style="color: #e53e3e;">Error loading report: ' + err.message + '</p>';
            }
        }

        async function loadInventoryReport() {
            const orderThreshold = parseFloat(document.getElementById('orderThreshold').value) || 1000;
            const container = document.getElementById('inventoryReportContent');
            
            container.innerHTML = '<p style="color: #718096;">Loading...</p>';
            
            try {
                const report = await api(`/api/admin/reports/inventory?order_threshold=${orderThreshold}`);
                
                const needsOrder = report.needs_reorder || [];
                const orderTotal = needsOrder.reduce((sum, p) => sum + (p.order_cost || 0), 0);
                const readyToOrder = orderTotal >= orderThreshold;
                
                container.innerHTML = `
                    <div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; text-align: center;">
                            <div>
                                <div style="font-size: 1.3rem; font-weight: 600; color: #2b6cb0;">$${parseFloat(report.inventory_cost || 0).toFixed(2)}</div>
                                <div style="font-size: 0.75rem; color: #718096;">Inventory Cost</div>
                            </div>
                            <div>
                                <div style="font-size: 1.3rem; font-weight: 600; color: #38a169;">$${parseFloat(report.potential_revenue || 0).toFixed(2)}</div>
                                <div style="font-size: 0.75rem; color: #718096;">Potential Sales</div>
                            </div>
                            <div>
                                <div style="font-size: 1.3rem; font-weight: 600; color: #805ad5;">${report.total_units || 0}</div>
                                <div style="font-size: 0.75rem; color: #718096;">Units in Stock</div>
                            </div>
                        </div>
                    </div>
                    
                    ${needsOrder.length > 0 ? `
                        <div style="background: ${readyToOrder ? '#fed7d7' : '#fefcbf'}; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <strong style="color: ${readyToOrder ? '#c53030' : '#975a16'};">
                                    ${readyToOrder ? 'üö® Order Ready!' : '‚ö†Ô∏è Low Stock Items'} 
                                    (${needsOrder.length} products)
                                </strong>
                                <span style="font-size: 1.1rem; font-weight: 600;">Order Total: $${orderTotal.toFixed(2)}</span>
                            </div>
                            ${readyToOrder ? `
                                <button class="btn btn-danger" onclick="generateWhatsAppOrder()" style="margin-bottom: 15px;">
                                    üì± Generate WhatsApp Order
                                </button>
                            ` : `
                                <p style="font-size: 0.85rem; color: #975a16;">Order total needs to reach $${orderThreshold.toFixed(0)} to generate order.</p>
                            `}
                        </div>
                        
                        <div style="max-height: 250px; overflow-y: auto;">
                            <table style="font-size: 0.85rem;">
                                <thead><tr><th>SKU</th><th>Product</th><th>Stock</th><th>Min</th><th>Order Qty</th><th>Cost</th></tr></thead>
                                <tbody>
                                    ${needsOrder.map(p => `
                                        <tr>
                                            <td><strong>${p.sku}</strong></td>
                                            <td>${p.name}</td>
                                            <td class="low-stock">${p.stock}</td>
                                            <td>${p.min_units} (${p.reorder_qty} boxes)</td>
                                            <td>${p.boxes_to_order} boxes</td>
                                            <td>$${parseFloat(p.order_cost || 0).toFixed(2)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : `
                        <p style="color: #38a169; text-align: center; padding: 20px;">‚úÖ All products are well stocked!</p>
                    `}
                `;
                
                // Store for WhatsApp order generation
                window.reorderData = { needsOrder, orderTotal };
                
            } catch (err) {
                container.innerHTML = '<p style="color: #e53e3e;">Error: ' + err.message + '</p>';
            }
        }

        function generateWhatsAppOrder() {
            if (!window.reorderData || !window.reorderData.needsOrder.length) {
                showAlert('No items to order');
                return;
            }
            
            const items = window.reorderData.needsOrder;
            const total = window.reorderData.orderTotal;
            
            let orderLines = ['PEPTIDE ORDER', '=============', ''];
            
            items.forEach(p => {
                orderLines.push(p.sku + ', ' + p.boxes_to_order + ', $' + (p.cost * 10).toFixed(2));
            });
            
            orderLines.push('', '=============', 'TOTAL: $' + total.toFixed(2));
            
            const orderText = orderLines.join(String.fromCharCode(10));
            
            document.getElementById('modalContainer').innerHTML = `
                <div class="modal" onclick="if(event.target===this)closeModal()">
                    <div class="modal-content">
                        <h3>üì± WhatsApp Order</h3>
                        <p style="color: #718096; margin-bottom: 15px;">Copy and paste into WhatsApp:</p>
                        <textarea id="whatsappOrder" readonly style="width: 100%; height: 300px; font-family: monospace; font-size: 0.9rem; padding: 15px; border: 2px solid #e2e8f0; border-radius: 6px;"></textarea>
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                            <button class="btn btn-success" onclick="copyWhatsAppOrder()">üìã Copy to Clipboard</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('whatsappOrder').value = orderText;
        }

        function copyWhatsAppOrder() {
            const textarea = document.getElementById('whatsappOrder');
            textarea.select();
            document.execCommand('copy');
            showAlert('Order copied to clipboard!', 'success');
        }

        async function loadDiscountReport() {
            const startDate = document.getElementById('discStartDate').value;
            const endDate = document.getElementById('discEndDate').value;
            
            try {
                const report = await api(`/api/admin/reports/discounts?start_date=${startDate}&end_date=${endDate}`);
                const container = document.getElementById('discountReportContent');
                
                if (!report.usage || report.usage.length === 0) {
                    container.innerHTML = '<p style="color: #718096;">No discount codes used in this period.</p>';
                    return;
                }
                
                const t = report.totals || {};
                
                container.innerHTML = `
                    <div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; text-align: center;">
                            <div>
                                <div style="font-size: 1.3rem; font-weight: 600; color: #2b6cb0;">$${parseFloat(t.total_revenue || 0).toFixed(2)}</div>
                                <div style="font-size: 0.75rem; color: #718096;">Revenue</div>
                            </div>
                            <div>
                                <div style="font-size: 1.3rem; font-weight: 600; color: #38a169;">${t.total_orders_with_discount || 0}</div>
                                <div style="font-size: 0.75rem; color: #718096;">Orders</div>
                            </div>
                            <div>
                                <div style="font-size: 1.3rem; font-weight: 600; color: #e53e3e;">$${parseFloat(t.total_discount_given || 0).toFixed(2)}</div>
                                <div style="font-size: 0.75rem; color: #718096;">Discounts</div>
                            </div>
                        </div>
                    </div>
                    <table style="font-size: 0.85rem;">
                        <thead>
                            <tr><th>Code</th><th>Uses</th><th>Revenue</th><th>Discounts</th></tr>
                        </thead>
                        <tbody>
                            ${report.usage.map(r => `
                                <tr>
                                    <td><strong>${r.code}</strong></td>
                                    <td>${r.times_used}</td>
                                    <td>$${parseFloat(r.total_revenue || 0).toFixed(2)}</td>
                                    <td style="color: #e53e3e;">-$${parseFloat(r.total_discount || 0).toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (err) {
                document.getElementById('discountReportContent').innerHTML = `<p style="color: #e53e3e;">Error: ${err.message}</p>`;
            }
        }

        async function loadOrderSummary() {
            const startDate = document.getElementById('orderStartDate').value;
            const endDate = document.getElementById('orderEndDate').value;
            
            try {
                const report = await api(`/api/admin/reports/orders?start_date=${startDate}&end_date=${endDate}`);
                const container = document.getElementById('orderSummaryContent');
                
                container.innerHTML = `
                    <div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; text-align: center;">
                            <div>
                                <div style="font-size: 1.5rem; font-weight: 600; color: #2b6cb0;">${report.total_orders || 0}</div>
                                <div style="font-size: 0.8rem; color: #718096;">Total Orders</div>
                            </div>
                            <div>
                                <div style="font-size: 1.5rem; font-weight: 600; color: #38a169;">$${parseFloat(report.total_revenue || 0).toFixed(2)}</div>
                                <div style="font-size: 0.8rem; color: #718096;">Total Revenue</div>
                            </div>
                        </div>
                    </div>
                    <table style="font-size: 0.85rem;">
                        <thead><tr><th>Status</th><th>Count</th><th>Value</th></tr></thead>
                        <tbody>
                            ${(report.by_status || []).map(s => `
                                <tr>
                                    <td><span class="status-badge status-${s.status}">${s.status}</span></td>
                                    <td>${s.count}</td>
                                    <td>$${parseFloat(s.total || 0).toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (err) {
                document.getElementById('orderSummaryContent').innerHTML = `<p style="color: #e53e3e;">Error: ${err.message}</p>`;
            }
        }

        // ============================================
        // RETURNS MANAGEMENT
        // ============================================

        async function loadReturns() {
            try {
                const filter = state.returnsFilter || '';
                const returns = await api('/api/admin/returns' + (filter ? '?status=' + filter : ''));
                state.returns = returns;
                renderReturns();
            } catch (err) {
                showAlert('Error loading returns: ' + err.message, 'error');
            }
        }

        function renderReturns() {
            const returns = state.returns || [];
            
            const reasonLabels = {
                'damaged_shipping': 'Damaged in Shipping',
                'wrong_item': 'Wrong Item Sent',
                'quality_issue': 'Quality Issue',
                'other': 'Other'
            };
            
            const statusLabels = {
                'pending': 'Pending Review',
                'approved': 'Approved',
                'denied': 'Denied',
                'refund_pending': 'Refund Pending',
                'refunded': 'Refunded',
                'replacement_pending': 'Replacement Pending'
            };
            
            const pendingCount = returns.filter(r => r.status === 'pending').length;
            
            document.getElementById('tabContent').innerHTML = `
                <div class="toolbar">
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <h3 style="margin: 0;">Returns & Credit Requests</h3>
                        ${pendingCount > 0 ? '<span class="status-badge status-pending">' + pendingCount + ' pending</span>' : ''}
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <select onchange="state.returnsFilter=this.value; loadReturns();" style="padding: 8px; border-radius: 6px; border: 2px solid #e2e8f0;">
                            <option value="">All Status</option>
                            <option value="pending" ${state.returnsFilter === 'pending' ? 'selected' : ''}>Pending</option>
                            <option value="approved" ${state.returnsFilter === 'approved' ? 'selected' : ''}>Approved</option>
                            <option value="denied" ${state.returnsFilter === 'denied' ? 'selected' : ''}>Denied</option>
                            <option value="refund_pending" ${state.returnsFilter === 'refund_pending' ? 'selected' : ''}>Refund Pending</option>
                        </select>
                        <button class="btn btn-secondary" onclick="loadReturns()">‚Üª Refresh</button>
                    </div>
                </div>
                
                ${returns.length === 0 ? `
                    <div style="text-align: center; padding: 40px; color: #718096;">
                        <div style="font-size: 3rem; margin-bottom: 10px;">üì¶</div>
                        <p>No return requests ${state.returnsFilter ? 'with this status' : 'yet'}</p>
                    </div>
                ` : ''}
                
                <div id="returnsList">
                    ${returns.map(ret => `
                        <div class="return-card-admin ${ret.status}">
                            <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 15px;">
                                <div>
                                    <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 5px;">
                                        Return #${ret.id} - Order ${escapeHtml(ret.order_number)}
                                    </div>
                                    <div style="color: #718096; font-size: 0.9rem;">
                                        ${escapeHtml(ret.full_name)} (${escapeHtml(ret.email)})<br>
                                        Submitted: ${new Date(ret.created_at).toLocaleString()}
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <span class="return-status-admin ${ret.status}">${statusLabels[ret.status] || ret.status}</span>
                                    <div style="margin-top: 5px; color: #718096; font-size: 0.85rem;">
                                        Order Total: $${parseFloat(ret.order_total || 0).toFixed(2)}
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin: 15px 0; padding: 15px; background: #f7fafc; border-radius: 6px;">
                                <div style="font-weight: 500; margin-bottom: 8px;">
                                    Reason: ${reasonLabels[ret.reason] || ret.reason}
                                </div>
                                ${ret.reason_details ? `
                                    <div style="color: #4a5568; font-size: 0.9rem;">
                                        "${escapeHtml(ret.reason_details)}"
                                    </div>
                                ` : ''}
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <strong>Items Requested:</strong>
                                <table style="width: 100%; margin-top: 10px; font-size: 0.9rem;">
                                    <thead>
                                        <tr><th>Product</th><th>SKU</th><th>Qty</th><th>Unit Price</th><th>Subtotal</th></tr>
                                    </thead>
                                    <tbody>
                                        ${(ret.items || []).map(item => `
                                            <tr>
                                                <td>${escapeHtml(item.name)}</td>
                                                <td>${escapeHtml(item.sku)}</td>
                                                <td>${item.quantity}</td>
                                                <td>$${parseFloat(item.price_single || 0).toFixed(2)}</td>
                                                <td>$${(item.quantity * (item.price_single || 0)).toFixed(2)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                                <div style="text-align: right; margin-top: 10px; font-weight: 500;">
                                    Suggested Credit: $${parseFloat(ret.suggested_amount || 0).toFixed(2)}
                                </div>
                            </div>
                            
                            ${ret.status === 'pending' ? `
                                <div class="process-form" id="processForm_${ret.id}">
                                    <h4 style="margin-bottom: 15px;">Process This Return</h4>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>Resolution Type</label>
                                            <select id="resolution_${ret.id}" onchange="toggleCreditAmount(${ret.id}, this.value)">
                                                <option value="">-- Select --</option>
                                                <option value="store_credit">Issue Store Credit</option>
                                                <option value="partial_credit">Partial Credit</option>
                                                <option value="full_refund">Full Refund (External)</option>
                                                <option value="replacement">Send Replacement</option>
                                                <option value="denied">Deny Request</option>
                                            </select>
                                        </div>
                                        <div class="form-group" id="amountGroup_${ret.id}" style="display: none;">
                                            <label>Credit Amount</label>
                                            <input type="number" id="amount_${ret.id}" step="0.01" value="${ret.suggested_amount || 0}">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>Admin Notes</label>
                                        <textarea id="notes_${ret.id}" rows="2" placeholder="Internal notes or message to customer..."></textarea>
                                    </div>
                                    <div style="display: flex; gap: 10px;">
                                        <button class="btn" onclick="processReturn(${ret.id})">Process Return</button>
                                    </div>
                                </div>
                            ` : `
                                <div style="padding: 15px; background: #f7fafc; border-radius: 6px;">
                                    <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
                                        <div>
                                            <strong>Resolution:</strong> ${ret.resolution_type || 'N/A'}
                                            ${ret.resolution_amount > 0 ? ' - $' + parseFloat(ret.resolution_amount).toFixed(2) : ''}
                                        </div>
                                        ${ret.processed_at ? `
                                            <div style="color: #718096; font-size: 0.85rem;">
                                                Processed: ${new Date(ret.processed_at).toLocaleString()}
                                            </div>
                                        ` : ''}
                                    </div>
                                    ${ret.admin_notes ? `
                                        <div style="margin-top: 10px; color: #4a5568; font-size: 0.9rem;">
                                            <strong>Notes:</strong> ${escapeHtml(ret.admin_notes)}
                                        </div>
                                    ` : ''}
                                    ${ret.status === 'refund_pending' ? `
                                        <div style="margin-top: 15px;">
                                            <button class="btn btn-success btn-small" onclick="completeRefund(${ret.id})">
                                                ‚úì Mark Refund Complete
                                            </button>
                                        </div>
                                    ` : ''}
                                </div>
                            `}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function toggleCreditAmount(returnId, resolutionType) {
            const amountGroup = document.getElementById('amountGroup_' + returnId);
            if (resolutionType === 'store_credit' || resolutionType === 'partial_credit') {
                amountGroup.style.display = 'block';
            } else {
                amountGroup.style.display = 'none';
            }
        }

        async function processReturn(returnId) {
            const resolution = document.getElementById('resolution_' + returnId).value;
            const amount = document.getElementById('amount_' + returnId).value;
            const notes = document.getElementById('notes_' + returnId).value;
            
            if (!resolution) {
                showAlert('Please select a resolution type', 'error');
                return;
            }
            
            if ((resolution === 'store_credit' || resolution === 'partial_credit') && (!amount || amount <= 0)) {
                showAlert('Please enter a credit amount', 'error');
                return;
            }
            
            if (resolution === 'denied') {
                if (!confirm('Are you sure you want to deny this return request?')) {
                    return;
                }
            }
            
            try {
                await api('/api/admin/returns/' + returnId + '/process', {
                    method: 'POST',
                    body: JSON.stringify({
                        resolution_type: resolution,
                        resolution_amount: parseFloat(amount) || 0,
                        admin_notes: notes
                    })
                });
                
                showAlert('Return processed successfully!', 'success');
                loadReturns();
                
            } catch (err) {
                showAlert('Error: ' + err.message, 'error');
            }
        }

        async function completeRefund(returnId) {
            const notes = prompt('Enter any notes about the refund (optional):');
            
            try {
                await api('/api/admin/returns/' + returnId + '/complete-refund', {
                    method: 'POST',
                    body: JSON.stringify({ notes: notes || '' })
                });
                
                showAlert('Refund marked as complete', 'success');
                loadReturns();
                
            } catch (err) {
                showAlert('Error: ' + err.message, 'error');
            }
        }

        function showAddCreditModal(userId, userName, currentCredit) {
            document.getElementById('modalContainer').innerHTML = `
                <div class="modal" onclick="if(event.target===this)closeModal()">
                    <div class="modal-content" style="max-width: 400px;">
                        <h3>üí∞ Add/Remove Credit</h3>
                        <p style="color: #718096; margin-bottom: 15px;">
                            ${escapeHtml(userName)}<br>
                            Current balance: $${parseFloat(currentCredit || 0).toFixed(2)}
                        </p>
                        
                        <div class="form-group">
                            <label>Amount (use negative to remove)</label>
                            <input type="number" id="creditAmount" step="0.01" placeholder="e.g. 25.00 or -10.00">
                        </div>
                        
                        <div class="form-group">
                            <label>Reason</label>
                            <input type="text" id="creditReason" placeholder="e.g. Return credit, Goodwill gesture...">
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn" onclick="submitAddCredit(${userId})">Apply Credit</button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function submitAddCredit(userId) {
            const amount = parseFloat(document.getElementById('creditAmount').value);
            const reason = document.getElementById('creditReason').value;
            
            if (!amount || amount === 0) {
                showAlert('Please enter a non-zero amount', 'error');
                return;
            }
            
            if (!reason.trim()) {
                showAlert('Please enter a reason', 'error');
                return;
            }
            
            try {
                const result = await api('/api/admin/users/' + userId + '/add-credit', {
                    method: 'POST',
                    body: JSON.stringify({ amount, reason })
                });
                
                showAlert('Credit updated! New balance: $' + parseFloat(result.new_balance).toFixed(2), 'success');
                closeModal();
                loadUsers();
                
            } catch (err) {
                showAlert('Error: ' + err.message, 'error');
            }
        }

        function showResetPasswordModal(userId, userName, userEmail) {
            document.getElementById('modalContainer').innerHTML = `
                <div class="modal" onclick="if(event.target===this)closeModal()">
                    <div class="modal-content" style="max-width: 450px;">
                        <h3>üîê Reset Password</h3>
                        <p style="color: #718096; margin-bottom: 15px;">
                            ${escapeHtml(userName)} (${escapeHtml(userEmail)})
                        </p>
                        
                        <div style="display: flex; flex-direction: column; gap: 15px;">
                            <button class="btn" onclick="sendPasswordResetEmail(${userId})">
                                üìß Send Password Reset Email
                            </button>
                            
                            <div style="text-align: center; color: #718096;">‚Äî or ‚Äî</div>
                            
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Set Temporary Password</label>
                                <input type="text" id="tempPassword" placeholder="Enter temporary password (min 6 chars)">
                            </div>
                            <button class="btn btn-warning" onclick="setTempPassword(${userId})">
                                Set Temporary Password
                            </button>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function sendPasswordResetEmail(userId) {
            try {
                const result = await api('/api/admin/users/' + userId + '/reset-password', {
                    method: 'POST',
                    body: JSON.stringify({ action: 'send_email' })
                });
                showAlert(result.message, 'success');
                closeModal();
            } catch (err) {
                showAlert('Error: ' + err.message, 'error');
            }
        }

        async function setTempPassword(userId) {
            const tempPassword = document.getElementById('tempPassword').value;
            if (!tempPassword || tempPassword.length < 6) {
                showAlert('Password must be at least 6 characters', 'error');
                return;
            }
            
            try {
                const result = await api('/api/admin/users/' + userId + '/reset-password', {
                    method: 'POST',
                    body: JSON.stringify({ action: 'set_temp', temp_password: tempPassword })
                });
                showAlert(result.message + ' Password: ' + tempPassword, 'success');
                closeModal();
            } catch (err) {
                showAlert('Error: ' + err.message, 'error');
            }
        }

        // ============================================
        // END RETURNS MANAGEMENT
        // ============================================

        async function logout() {
            try {
                await api('/api/logout', { method: 'POST' });
            } catch (e) {}
            window.location.href = '/';
        }

        function closeModal() {
            document.getElementById('modalContainer').innerHTML = '';
        }

        init();
    </script>
</body>
</html>
