<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Research Materials Ordering Platform</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f7fa; color: #333; line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        header { background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%); color: white; padding: 20px 0; margin-bottom: 30px; }
        header .container { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        header h1 { font-size: 1.5rem; }
        .header-right { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        .user-info { font-size: 0.9rem; opacity: 0.9; }
        nav { display: flex; gap: 10px; flex-wrap: wrap; }
        nav button { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s; }
        nav button:hover { background: rgba(255,255,255,0.25); }
        nav button.active { background: white; color: #1a365d; }
        .card { background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); padding: 25px; margin-bottom: 20px; }
        .card h2 { color: #1a365d; margin-bottom: 20px; font-size: 1.3rem; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; }
        .form-group { margin-bottom: 18px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 500; color: #4a5568; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; transition: border-color 0.2s; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #4299e1; }
        .btn { background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 500; transition: transform 0.2s, box-shadow 0.2s; }
        .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(66, 153, 225, 0.4); }
        .btn:disabled { background: #a0aec0; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-secondary { background: linear-gradient(135deg, #718096 0%, #4a5568 100%); }
        .btn-success { background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); }
        .btn-danger { background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%); }
        .btn-small { padding: 6px 12px; font-size: 0.85rem; }
        .alert { padding: 15px 20px; border-radius: 8px; margin-bottom: 20px; }
        .alert-error { background: #fed7d7; color: #c53030; border: 1px solid #fc8181; }
        .alert-success { background: #c6f6d5; color: #276749; border: 1px solid #68d391; }
        .alert-warning { background: #fefcbf; color: #975a16; border: 1px solid #f6e05e; }
        .alert-info { background: #bee3f8; color: #2b6cb0; border: 1px solid #63b3ed; }
        .hidden { display: none !important; }
        .grid { display: grid; gap: 20px; }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        .grid-3 { grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
        .product-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); transition: transform 0.2s, box-shadow 0.2s; }
        .product-card:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0,0,0,0.12); }
        .product-card h3 { color: #1a365d; margin-bottom: 8px; font-size: 1.1rem; }
        .product-sku { color: #718096; font-size: 0.85rem; margin-bottom: 10px; }
        .product-price { font-size: 1.2rem; font-weight: 600; color: #2d3748; margin-bottom: 15px; }
        .product-price .bulk { font-size: 0.9rem; color: #48bb78; display: block; margin-top: 4px; }
        .product-stock { font-size: 0.85rem; margin-bottom: 15px; }
        .product-stock.low { color: #e53e3e; }
        .product-stock.ok { color: #38a169; }
        .qty-control { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        .qty-control button { width: 32px; height: 32px; border: none; background: #e2e8f0; border-radius: 6px; cursor: pointer; font-size: 1.2rem; }
        .qty-control input { width: 60px; text-align: center; border: 2px solid #e2e8f0; border-radius: 6px; padding: 6px; }
        .category-filter { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
        .category-filter button { padding: 8px 16px; border: 2px solid #e2e8f0; background: white; border-radius: 20px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s; }
        .category-filter button:hover, .category-filter button.active { border-color: #4299e1; background: #ebf8ff; color: #2b6cb0; }
        .cart-badge { background: #e53e3e; color: white; font-size: 0.75rem; padding: 2px 6px; border-radius: 10px; margin-left: 5px; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #e2e8f0; }
        .cart-item:last-child { border-bottom: none; }
        .cart-item-info h4 { margin-bottom: 4px; }
        .cart-item-info p { color: #718096; font-size: 0.9rem; }
        .cart-summary { background: #f7fafc; padding: 20px; border-radius: 8px; margin-top: 20px; }
        .cart-summary-row { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .cart-summary-row.total { font-size: 1.2rem; font-weight: 600; border-top: 2px solid #e2e8f0; padding-top: 10px; margin-top: 10px; }
        .discount-form { display: flex; gap: 10px; margin-bottom: 15px; }
        .discount-form input { flex: 1; }
        .order-row { padding: 15px; border-bottom: 1px solid #e2e8f0; cursor: pointer; transition: background 0.2s; }
        .order-row:hover { background: #f7fafc; }
        .order-row h4 { margin-bottom: 5px; }
        .order-row p { color: #718096; font-size: 0.9rem; }
        .order-status { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 500; }
        .status-pending { background: #fefcbf; color: #975a16; }
        .status-paid { background: #c6f6d5; color: #276749; }
        .status-processing { background: #bee3f8; color: #2b6cb0; }
        .status-shipped { background: #e9d8fd; color: #6b46c1; }
        .status-delivered { background: #c6f6d5; color: #276749; }
        .status-fulfilled { background: #c6f6d5; color: #276749; }
        .status-cancelled { background: #fed7d7; color: #c53030; }
        .status-refunded { background: #feebc8; color: #c05621; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; border-radius: 12px; padding: 30px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-content h2 { margin-bottom: 20px; }
        .checkbox-group { display: flex; align-items: flex-start; gap: 12px; margin-bottom: 15px; }
        .checkbox-group input[type="checkbox"] { width: 22px; height: 22px; min-width: 22px; margin-top: 2px; cursor: pointer; }
        .checkbox-group label { font-size: 0.95rem; color: #4a5568; cursor: pointer; }
        .tabs { display: flex; border-bottom: 2px solid #e2e8f0; margin-bottom: 20px; }
        .tabs button { background: none; border: none; padding: 12px 20px; cursor: pointer; font-size: 1rem; color: #718096; border-bottom: 2px solid transparent; margin-bottom: -2px; }
        .tabs button.active { color: #2b6cb0; border-bottom-color: #4299e1; }
        .order-detail { padding: 20px; background: #f7fafc; border-radius: 8px; }
        .order-detail h4 { margin-bottom: 15px; }
        .order-items-table { width: 100%; border-collapse: collapse; }
        .order-items-table th, .order-items-table td { padding: 10px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        .order-items-table th { background: #edf2f7; font-weight: 500; }
        .verification-banner { background: #fefcbf; color: #975a16; padding: 15px 20px; border-radius: 8px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        @media (max-width: 600px) {
            header .container { flex-direction: column; text-align: center; }
            .header-right { justify-content: center; }
            .cart-item { flex-direction: column; text-align: center; gap: 10px; }
        }
        /* Returns styles */
        .return-card { background: #f7fafc; border-radius: 8px; padding: 15px; margin-bottom: 10px; border-left: 4px solid #e2e8f0; }
        .return-card.pending { border-left-color: #ed8936; }
        .return-card.approved { border-left-color: #48bb78; }
        .return-card.denied { border-left-color: #e53e3e; }
        .return-card.refund_pending { border-left-color: #4299e1; }
        .return-card.refunded { border-left-color: #48bb78; }
        .return-card.replacement_pending { border-left-color: #9f7aea; }
        .return-status { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 500; }
        .return-status.pending { background: #fefcbf; color: #975a16; }
        .return-status.approved { background: #c6f6d5; color: #276749; }
        .return-status.denied { background: #fed7d7; color: #c53030; }
        .return-status.refund_pending { background: #bee3f8; color: #2b6cb0; }
        .return-status.refunded { background: #c6f6d5; color: #276749; }
        .return-status.replacement_pending { background: #e9d8fd; color: #6b46c1; }
        .return-item-check { display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid #e2e8f0; }
        .return-item-check:last-child { border-bottom: none; }
        .return-item-check input[type="checkbox"] { width: 18px; height: 18px; }
        .return-item-check .item-info { flex: 1; }
        .return-item-check .qty-input { width: 60px; padding: 5px; border: 1px solid #e2e8f0; border-radius: 4px; }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>üî¨ Research Materials</h1>
            <div class="header-right">
                <span class="user-info" id="userInfo"></span>
                <nav id="mainNav"></nav>
            </div>
        </div>
    </header>

    <div class="container">
        <div id="alertContainer"></div>
        <div id="verificationBanner" class="verification-banner hidden">
            <span>‚ö†Ô∏è Please verify your email address to place orders.</span>
            <button class="btn btn-small" onclick="resendVerification()">Resend Verification Email</button>
        </div>
        <main id="mainContent"></main>
    </div>

    <div id="modalContainer"></div>

    <script>
        // State
        let state = {
            user: null,
            csrfToken: null,
            products: [],
            categories: [],
            cart: JSON.parse(localStorage.getItem('cart') || '[]'),
            orders: [],
            currentView: 'products',
            selectedCategory: 'All',
            discount: null,
            referrerChoice: null,
            userCredit: 0,
            eligibleOrders: [],
            myReturns: []
        };

        // API helpers
        async function api(endpoint, options = {}) {
            const headers = { 'Content-Type': 'application/json' };
            if (state.csrfToken && ['POST', 'PUT', 'DELETE'].includes(options.method)) {
                headers['X-CSRF-Token'] = state.csrfToken;
            }
            const res = await fetch(endpoint, { ...options, headers, credentials: 'same-origin' });
            const data = await res.json();
            if (!res.ok) throw new Error(data.error || 'Request failed');
            return data;
        }

        function showAlert(message, type = 'error') {
            const container = document.getElementById('alertContainer');
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }

        function saveCart() {
            localStorage.setItem('cart', JSON.stringify(state.cart));
        }

        // Initialize
        async function init() {
            // Check for URL parameters (verification result)
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('verified') === '1') {
                showAlert('Email verified successfully! You can now log in.', 'success');
                window.history.replaceState({}, document.title, '/');
            }
            if (urlParams.get('error')) {
                const errorMsg = {
                    'missing_token': 'Missing verification token',
                    'invalid_token': 'Invalid or expired verification link',
                    'verification_failed': 'Verification failed. Please try again.'
                }[urlParams.get('error')] || 'An error occurred';
                showAlert(errorMsg);
                window.history.replaceState({}, document.title, '/');
            }
            
            try {
                const tokenRes = await api('/api/csrf-token');
                state.csrfToken = tokenRes.token;
            } catch (e) { console.error('CSRF error:', e); }

            try {
                const user = await api('/api/me');
                state.user = user;
                // Show/hide verification banner based on email status
                if (!user.email_verified) {
                    document.getElementById('verificationBanner').classList.remove('hidden');
                } else {
                    document.getElementById('verificationBanner').classList.add('hidden');
                }
                // First login reaffirmation - required for compliance
                if (!user.first_login_confirmed) {
                    showFirstLoginModal();
                }
            } catch (e) {
                state.user = null;
            }

            renderNav();
            if (state.user) {
                await loadProducts();
                renderView();
            } else {
                showLogin();
            }
        }

        function renderNav() {
            const nav = document.getElementById('mainNav');
            const userInfo = document.getElementById('userInfo');
            
            if (state.user) {
                userInfo.textContent = `Welcome, ${state.user.full_name}`;
                const cartCount = state.cart.reduce((sum, item) => sum + item.qty, 0);
                nav.innerHTML = `
                    <button onclick="showView('products')" class="${state.currentView === 'products' ? 'active' : ''}">Products</button>
                    <button onclick="showView('cart')" class="${state.currentView === 'cart' ? 'active' : ''}">Cart${cartCount > 0 ? `<span class="cart-badge">${cartCount}</span>` : ''}</button>
                    <button onclick="showView('orders')" class="${state.currentView === 'orders' ? 'active' : ''}">My Orders</button>
                    <button onclick="showView('returns')" class="${state.currentView === 'returns' ? 'active' : ''}">Returns</button>
                    ${state.user.is_admin ? '<button onclick="window.location.href=\'/admin\'">Admin</button>' : ''}
                    <button onclick="logout()">Logout</button>
                `;
            } else {
                userInfo.textContent = '';
                nav.innerHTML = `
                    <button onclick="showLogin()" class="active">Login</button>
                    <button onclick="showRegister()">Register</button>
                `;
            }
        }

        async function loadProducts() {
            try {
                state.products = await api('/api/products');
                const catRes = await api('/api/categories');
                state.categories = ['All', ...catRes.categories];
            } catch (e) {
                showAlert('Failed to load products');
            }
        }

        function showView(view) {
            state.currentView = view;
            renderNav();
            renderView();
        }

        function renderView() {
            switch (state.currentView) {
                case 'products': renderProducts(); break;
                case 'cart': renderCart(); break;
                case 'orders': renderOrders(); break;
                case 'returns': renderReturns(); break;
            }
        }

        // Auth views
        function showLogin() {
            document.getElementById('mainContent').innerHTML = `
                <div class="card" style="max-width: 450px; margin: 0 auto;">
                    <h2>Login</h2>
                    <form onsubmit="login(event)" autocomplete="off">
                        <div class="form-group">
                            <label>Email</label>
                            <input type="text" id="loginEmail" required autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input type="text" id="loginPassword" required autocomplete="off" style="-webkit-text-security: disc;">
                        </div>
                        <button type="submit" class="btn" style="width: 100%;">Login</button>
                    </form>
                    <p style="margin-top: 15px; text-align: center; color: #718096;">
                        <a href="#" onclick="showForgotPassword()" style="color: #4299e1;">Forgot password?</a>
                    </p>
                    <p style="margin-top: 10px; text-align: center; color: #718096;">
                        Don't have an account? <a href="#" onclick="showRegister()" style="color: #4299e1;">Register</a>
                    </p>
                </div>
            `;
        }

        async function login(e) {
            e.preventDefault();
            try {
                await api('/api/login', {
                    method: 'POST',
                    body: JSON.stringify({
                        email: document.getElementById('loginEmail').value,
                        password: document.getElementById('loginPassword').value
                    })
                });
                await init();
                showAlert('Login successful!', 'success');
            } catch (err) {
                showAlert(err.message);
            }
        }

        function showRegister() {
            document.getElementById('mainContent').innerHTML = `
                <div class="card" style="max-width: 600px; margin: 0 auto;">
                    <h2>Create Research Account</h2>
                    
                    <div style="background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                        <h3 style="margin-top: 0; color: #2d3748; font-size: 1.1rem;">Research Use Only Acknowledgment</h3>
                        <p style="color: #4a5568; font-size: 0.95rem; line-height: 1.6;">
                            By creating an account with The Peptide Wizard, I acknowledge and agree to the following:
                        </p>
                        <ul style="color: #4a5568; font-size: 0.9rem; line-height: 1.8; margin: 15px 0; padding-left: 20px;">
                            <li>All products offered are <strong>Research Use Only (RUO)</strong> materials.</li>
                            <li>Products are <strong>not intended for human or veterinary use</strong>, including but not limited to injection, ingestion, or topical application.</li>
                            <li>I am purchasing these materials solely for <strong>legitimate research, analytical, or educational purposes</strong>.</li>
                            <li>I understand that The Peptide Wizard does not provide medical advice, dosing guidance, or instructions for human use.</li>
                            <li>I accept full responsibility for ensuring that my purchase, handling, and use of these materials complies with all applicable local, state, and federal laws and regulations.</li>
                            <li>I acknowledge that <strong>misuse of these materials is strictly prohibited</strong>.</li>
                        </ul>
                    </div>
                    
                    <form onsubmit="register(event)">
                        <div class="grid grid-2">
                            <div class="form-group">
                                <label>Full Name *</label>
                                <input type="text" id="regName" required>
                            </div>
                            <div class="form-group">
                                <label>Email *</label>
                                <input type="text" id="regEmail" required placeholder="your@email.com" autocomplete="off">
                            </div>
                            <div class="form-group">
                                <label>Phone *</label>
                                <input type="text" id="regPhone" required placeholder="e.g. 555-123-4567" autocomplete="off">
                            </div>
                            <div class="form-group">
                                <label>Country *</label>
                                <input type="text" id="regCountry" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Organization/Institution</label>
                            <input type="text" id="regOrg">
                        </div>
                        <div class="form-group">
                            <label>Password *</label>
                            <input type="password" id="regPassword" required minlength="8">
                        </div>
                        <div class="form-group">
                            <label>Confirm Password *</label>
                            <input type="password" id="regPassword2" required>
                        </div>
                        
                        <div class="checkbox-group" style="background: #fffbeb; padding: 15px; border-radius: 8px; border: 1px solid #f6e05e; margin: 20px 0;">
                            <input type="checkbox" id="ruoAcknowledgment" style="width: 22px; height: 22px; min-width: 22px;">
                            <label for="ruoAcknowledgment" style="font-weight: 500; color: #744210;">
                                I certify that I have read, understand, and agree to the Research Use Only terms above.
                            </label>
                        </div>
                        <p style="font-size: 0.85rem; color: #718096; text-align: center; margin-bottom: 15px;">
                            You may not create an account or place orders without accepting these terms.
                        </p>
                        
                        <button type="submit" class="btn" style="width: 100%; padding: 14px; font-size: 1rem;">Create Research Account</button>
                    </form>
                    <p style="margin-top: 15px; text-align: center; color: #718096;">
                        Already have an account? <a href="#" onclick="showLogin()" style="color: #4299e1;">Login</a>
                    </p>
                </div>
            `;
        }

        async function register(e) {
            e.preventDefault();
            
            // Check RUO acknowledgment
            if (!document.getElementById('ruoAcknowledgment').checked) {
                showAlert('You must accept the Research Use Only terms to create an account.');
                return;
            }
            
            const pw = document.getElementById('regPassword').value;
            const pw2 = document.getElementById('regPassword2').value;
            if (pw !== pw2) {
                showAlert('Passwords do not match');
                return;
            }
            try {
                await api('/api/register', {
                    method: 'POST',
                    body: JSON.stringify({
                        full_name: document.getElementById('regName').value,
                        email: document.getElementById('regEmail').value,
                        phone: document.getElementById('regPhone').value,
                        country: document.getElementById('regCountry').value,
                        organization: document.getElementById('regOrg').value,
                        password: pw,
                        ruo_acknowledged: true
                    })
                });
                showAlert('Account created! Please check your email to verify your account.', 'success');
                showLogin();
            } catch (err) {
                showAlert(err.message);
            }
        }

        async function logout() {
            try {
                await api('/api/logout', { method: 'POST' });
            } catch (e) {}
            state.user = null;
            state.cart = [];
            saveCart();
            document.getElementById('verificationBanner').classList.add('hidden');
            init();
        }

        function showForgotPassword() {
            document.getElementById('mainContent').innerHTML = `
                <div class="card" style="max-width: 450px; margin: 0 auto;">
                    <h2>Reset Password</h2>
                    <form onsubmit="forgotPassword(event)">
                        <div class="form-group">
                            <label>Email</label>
                            <input type="text" id="forgotEmail" required placeholder="your@email.com">
                        </div>
                        <button type="submit" class="btn" style="width: 100%;">Send Reset Link</button>
                    </form>
                    <p style="margin-top: 15px; text-align: center;">
                        <a href="#" onclick="showLogin()" style="color: #4299e1;">Back to Login</a>
                    </p>
                </div>
            `;
        }

        async function forgotPassword(e) {
            e.preventDefault();
            try {
                await api('/api/forgot-password', {
                    method: 'POST',
                    body: JSON.stringify({ email: document.getElementById('forgotEmail').value })
                });
                showAlert('If an account exists with that email, a reset link has been sent.', 'success');
                showLogin();
            } catch (err) {
                showAlert(err.message);
            }
        }

        async function resendVerification() {
            try {
                await api('/api/resend-verification', { method: 'POST' });
                showAlert('Verification email sent! Please check your inbox.', 'success');
            } catch (err) {
                showAlert(err.message);
            }
        }

        // Products view
        function renderProducts() {
            const filtered = state.selectedCategory === 'All' 
                ? state.products 
                : state.products.filter(p => p.category === state.selectedCategory);

            document.getElementById('mainContent').innerHTML = `
                <div class="card">
                    <h2>Product Catalog</h2>
                    <div class="category-filter">
                        ${state.categories.map(cat => `
                            <button class="${cat === state.selectedCategory ? 'active' : ''}" onclick="filterCategory('${cat}')">${cat}</button>
                        `).join('')}
                    </div>
                    <div class="grid grid-3">
                        ${filtered.map(p => {
                            const saleActive = p.sale_active && p.sale_price > 0;
                            const saleMinQty = p.sale_min_qty || 1;
                            const discountPercent = saleActive ? Math.round((p.price_single - p.sale_price) / p.price_single * 100) : 0;
                            
                            return `
                            <div class="product-card" style="${saleActive ? 'border: 2px solid #e53e3e; position: relative;' : ''}">
                                ${saleActive ? '<div style="position: absolute; top: -10px; right: -10px; background: #e53e3e; color: white; padding: 5px 10px; border-radius: 20px; font-weight: bold; font-size: 0.85rem;">' + discountPercent + '% OFF</div>' : ''}
                                <h3>${p.name}</h3>
                                <p class="product-sku">SKU: ${p.sku}</p>
                                <div class="product-price">
                                    $${p.price_single.toFixed(2)}
                                    ${!saleActive && p.price_bulk ? `<span class="bulk">Bulk (${p.bulk_quantity}+): $${(p.price_bulk / p.bulk_quantity).toFixed(2)} each</span>` : ''}
                                </div>
                                ${saleActive ? `
                                    <div style="background: #fed7d7; padding: 8px; border-radius: 6px; margin: 8px 0;">
                                        <strong style="color: #c53030;">üè∑Ô∏è SALE: ${saleMinQty > 1 ? 'Buy ' + saleMinQty + '+ for ' : ''}$${p.sale_price.toFixed(2)}/ea</strong>
                                        ${saleMinQty > 1 ? '<div style="font-size: 0.8rem; color: #742a2a;">Min ' + saleMinQty + ' to qualify</div>' : ''}
                                    </div>
                                ` : ''}
                                <p class="product-stock ${p.stock < 10 ? 'low' : 'ok'}">
                                    ${p.stock > 0 ? `${p.stock} in stock` : 'Out of stock'}
                                </p>
                                <div class="qty-control">
                                    <button onclick="updateCartQty(${p.id}, -1)">‚àí</button>
                                    <input type="number" id="qty-${p.id}" value="${getCartQty(p.id)}" min="0" max="${p.stock}" onchange="setCartQty(${p.id}, this.value)">
                                    <button onclick="updateCartQty(${p.id}, 1)">+</button>
                                </div>
                                <button class="btn btn-small" onclick="addToCart(${p.id})" ${p.stock === 0 ? 'disabled' : ''}>
                                    Add to Cart
                                </button>
                            </div>
                        `}).join('')}
                    </div>
                </div>
            `;
        }

        function filterCategory(cat) {
            state.selectedCategory = cat;
            renderProducts();
        }

        function getCartQty(productId) {
            const item = state.cart.find(i => i.productId === productId);
            return item ? item.qty : 0;
        }

        function updateCartQty(productId, delta) {
            const input = document.getElementById(`qty-${productId}`);
            const newVal = Math.max(0, parseInt(input.value || 0) + delta);
            input.value = newVal;
        }

        function setCartQty(productId, value) {
            const input = document.getElementById(`qty-${productId}`);
            input.value = Math.max(0, parseInt(value) || 0);
        }

        function addToCart(productId) {
            const qty = parseInt(document.getElementById(`qty-${productId}`).value) || 1;
            if (qty <= 0) return;
            
            const product = state.products.find(p => p.id === productId);
            if (!product) return;

            const existing = state.cart.find(i => i.productId === productId);
            if (existing) {
                existing.qty = Math.min(existing.qty + qty, product.stock);
            } else {
                state.cart.push({ productId, qty: Math.min(qty, product.stock) });
            }
            saveCart();
            renderNav();
            showAlert(`Added ${qty} x ${product.name} to cart`, 'success');
        }

        // Cart view
        function renderCart() {
            const items = state.cart.map(item => {
                const product = state.products.find(p => p.id === item.productId);
                if (!product) return null;
                
                // Check if on sale first, then bulk, then single
                let subtotal;
                let priceDisplay;
                let saleMinQty = product.sale_min_qty || 1;
                let isOnSale = product.sale_active && product.sale_price > 0 && item.qty >= saleMinQty;
                let needsMoreForSale = product.sale_active && product.sale_price > 0 && item.qty < saleMinQty;
                
                if (isOnSale) {
                    // Sale price - customer meets minimum qty
                    priceDisplay = product.sale_price;
                    subtotal = product.sale_price * item.qty;
                } else if (product.price_bulk && item.qty >= product.bulk_quantity) {
                    // Bulk pricing: price_bulk is total for bulk_quantity items
                    const pricePerItem = product.price_bulk / product.bulk_quantity;
                    subtotal = pricePerItem * item.qty;
                    priceDisplay = pricePerItem;
                } else {
                    subtotal = product.price_single * item.qty;
                    priceDisplay = product.price_single;
                }
                
                return { ...item, product, price: priceDisplay, subtotal, isOnSale, needsMoreForSale, saleMinQty };
            }).filter(Boolean);

            const subtotal = items.reduce((sum, i) => sum + i.subtotal, 0);
            let discountAmount = 0;
            if (state.discount) {
                if (state.discount.discount_percent > 0) {
                    discountAmount = subtotal * (state.discount.discount_percent / 100);
                } else {
                    discountAmount = state.discount.discount_amount;
                }
            }
            const total = subtotal - discountAmount;

            document.getElementById('mainContent').innerHTML = `
                <div class="card">
                    <h2>Shopping Cart</h2>
                    ${items.length === 0 ? '<p style="text-align: center; color: #718096;">Your cart is empty</p>' : `
                        <div>
                            ${items.map(item => `
                                <div class="cart-item" style="${item.isOnSale ? 'border-left: 3px solid #e53e3e;' : item.needsMoreForSale ? 'border-left: 3px solid #f6ad55;' : ''}">
                                    <div class="cart-item-info">
                                        <h4>${item.product.name} ${item.isOnSale ? '<span style="background: #e53e3e; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; margin-left: 5px;">SALE PRICE!</span>' : ''}</h4>
                                        <p>$${item.price.toFixed(2)} x ${item.qty} = $${item.subtotal.toFixed(2)}</p>
                                        ${item.needsMoreForSale ? '<p style="color: #dd6b20; font-size: 0.85rem;">üí° Add ' + (item.saleMinQty - item.qty) + ' more for sale price ($' + item.product.sale_price.toFixed(2) + '/ea)</p>' : ''}
                                    </div>
                                    <div class="qty-control">
                                        <button onclick="changeCartItem(${item.productId}, -1)">‚àí</button>
                                        <input type="number" value="${item.qty}" min="1" max="${item.product.stock}" 
                                            onchange="changeCartItem(${item.productId}, 0, this.value)">
                                        <button onclick="changeCartItem(${item.productId}, 1)">+</button>
                                        <button class="btn btn-danger btn-small" onclick="removeFromCart(${item.productId})">Remove</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="cart-summary">
                            <div class="discount-form">
                                <input type="text" id="discountCode" placeholder="Discount code" value="${state.discount?.code || ''}">
                                <button class="btn btn-secondary btn-small" onclick="applyDiscount()">Apply</button>
                                ${state.discount ? '<button class="btn btn-danger btn-small" onclick="removeDiscount()">Remove</button>' : ''}
                            </div>
                            <div class="cart-summary-row">
                                <span>Subtotal</span>
                                <span>$${subtotal.toFixed(2)}</span>
                            </div>
                            ${discountAmount > 0 ? `
                                <div class="cart-summary-row" style="color: #38a169;">
                                    <span>Discount (${state.discount.code})${state.discount.has_sale_items ? '*' : ''}</span>
                                    <span>-$${discountAmount.toFixed(2)}</span>
                                </div>
                                ${state.discount.has_sale_items ? '<div style="font-size: 0.8rem; color: #718096; text-align: right;">*Applies to non-sale items only</div>' : ''}
                            ` : ''}
                            <div class="cart-summary-row total">
                                <span>Total</span>
                                <span>$${total.toFixed(2)}</span>
                            </div>
                            <button class="btn btn-success" style="width: 100%; margin-top: 15px;" onclick="proceedToCheckout()">
                                Proceed to Checkout
                            </button>
                        </div>
                    `}
                </div>
            `;
        }

        function changeCartItem(productId, delta, newValue = null) {
            const item = state.cart.find(i => i.productId === productId);
            if (!item) return;
            const product = state.products.find(p => p.id === productId);
            if (newValue !== null) {
                item.qty = Math.max(1, Math.min(parseInt(newValue) || 1, product.stock));
            } else {
                item.qty = Math.max(1, Math.min(item.qty + delta, product.stock));
            }
            saveCart();
            renderNav();
            renderCart();
        }

        function removeFromCart(productId) {
            state.cart = state.cart.filter(i => i.productId !== productId);
            saveCart();
            renderNav();
            renderCart();
        }

        async function applyDiscount() {
            const code = document.getElementById('discountCode').value.trim();
            if (!code) return;
            
            // Calculate subtotal and prepare cart items for validation
            let subtotal = 0;
            const cart_items = state.cart.map(item => {
                const product = state.products.find(p => p.id === item.productId);
                if (!product) return null;
                
                let price;
                let saleMinQty = product.sale_min_qty || 1;
                if (product.sale_active && product.sale_price > 0 && item.qty >= saleMinQty) {
                    price = product.sale_price;
                } else if (product.price_bulk && item.qty >= product.bulk_quantity) {
                    price = product.price_bulk / product.bulk_quantity;
                } else {
                    price = product.price_single;
                }
                subtotal += price * item.qty;
                
                return { product_id: item.productId, quantity: item.qty };
            }).filter(Boolean);
            
            try {
                const result = await api('/api/validate-discount', {
                    method: 'POST',
                    body: JSON.stringify({ code, subtotal, cart_items })
                });
                
                // Show warning if cart has sale items
                if (result.has_sale_items && result.discount_amount === 0) {
                    showAlert('All items in your cart are on sale - discount codes cannot be combined with sale prices.');
                    return;
                }
                
                // Check if this is their own referral code
                if (result.is_own_code && result.commission_percent > 0) {
                    showReferrerChoiceModal(result, result.non_sale_subtotal || subtotal);
                } else {
                    state.discount = result;
                    state.referrerChoice = null;
                    let msg = 'Discount applied!';
                    if (result.has_sale_items) {
                        msg += ' (Note: Discount applies to non-sale items only)';
                    }
                    showAlert(msg, 'success');
                    renderCart();
                }
            } catch (err) {
                showAlert(err.message);
            }
        }
        
        function showReferrerChoiceModal(discount, nonSaleSubtotal) {
            const discountPercent = discount.discount_percent;
            const commissionPercent = discount.commission_percent;
            const combinedPercent = discountPercent + commissionPercent;
            
            const discountOnly = nonSaleSubtotal * (discountPercent / 100);
            const creditAmount = nonSaleSubtotal * (commissionPercent / 100);
            const combinedDiscount = nonSaleSubtotal * (combinedPercent / 100);
            
            document.getElementById('modalContainer').innerHTML = `
                <div class="modal" onclick="if(event.target===this)closeModal()">
                    <div class="modal-content" style="max-width: 500px;">
                        <h3>üéâ This is Your Referral Code!</h3>
                        <p style="color: #718096; margin-bottom: 20px;">How would you like to use your ${combinedPercent}% benefit?</p>
                        
                        <div style="display: flex; flex-direction: column; gap: 15px;">
                            <label style="display: block; padding: 20px; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.2s;" 
                                   onclick="this.style.borderColor='#4299e1'; this.style.background='#ebf8ff';"
                                   onmouseenter="this.style.borderColor='#4299e1'" onmouseleave="if(!document.getElementById('choiceCombined').checked)this.style.borderColor='#e2e8f0'; this.style.background='white';">
                                <input type="radio" name="referrerChoice" id="choiceCombined" value="combined" style="margin-right: 10px;" checked>
                                <strong style="color: #2b6cb0; font-size: 1.1rem;">${combinedPercent}% Off This Order</strong>
                                <div style="margin-top: 8px; color: #4a5568;">
                                    Save <strong style="color: #38a169;">$${combinedDiscount.toFixed(2)}</strong> on this order
                                </div>
                            </label>
                            
                            <label style="display: block; padding: 20px; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.2s;"
                                   onclick="this.style.borderColor='#9f7aea'; this.style.background='#faf5ff';"
                                   onmouseenter="this.style.borderColor='#9f7aea'" onmouseleave="if(!document.getElementById('choiceSplit').checked)this.style.borderColor='#e2e8f0'; this.style.background='white';">
                                <input type="radio" name="referrerChoice" id="choiceSplit" value="split" style="margin-right: 10px;">
                                <strong style="color: #805ad5; font-size: 1.1rem;">${discountPercent}% Off + ${commissionPercent}% Credit</strong>
                                <div style="margin-top: 8px; color: #4a5568;">
                                    Save <strong>$${discountOnly.toFixed(2)}</strong> now + get <strong style="color: #805ad5;">$${creditAmount.toFixed(2)}</strong> credit for future orders
                                </div>
                            </label>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 25px;">
                            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                            <button type="button" class="btn btn-success" onclick="applyReferrerChoice('${discount.code}', ${discountPercent}, ${commissionPercent})">Apply</button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function applyReferrerChoice(code, discountPercent, commissionPercent) {
            const choice = document.querySelector('input[name="referrerChoice"]:checked').value;
            
            // Calculate the effective discount based on choice
            const subtotal = state.cart.reduce((sum, item) => {
                const product = state.products.find(p => p.id === item.productId);
                if (!product) return sum;
                if (product.price_bulk && item.qty >= product.bulk_quantity) {
                    return sum + (product.price_bulk / product.bulk_quantity) * item.qty;
                }
                return sum + product.price_single * item.qty;
            }, 0);
            
            let effectivePercent, effectiveAmount, message;
            if (choice === 'combined') {
                effectivePercent = discountPercent + commissionPercent;
                effectiveAmount = subtotal * (effectivePercent / 100);
                message = effectivePercent + '% off (combined)';
            } else {
                effectivePercent = discountPercent;
                effectiveAmount = subtotal * (effectivePercent / 100);
                message = discountPercent + '% off + ' + commissionPercent + '% credit';
            }
            
            state.discount = {
                code: code,
                discount_percent: effectivePercent,
                discount_amount: effectiveAmount,
                message: message,
                is_own_code: true
            };
            state.referrerChoice = choice;
            
            closeModal();
            showAlert('Discount applied: ' + message, 'success');
            renderCart();
        }

        function removeDiscount() {
            state.discount = null;
            renderCart();
        }

        function proceedToCheckout() {
            // Email verification disabled
            // if (!state.user.email_verified) {
            //     showAlert('Please verify your email address before placing an order.');
            //     return;
            // }
            showCheckoutModal();
        }

        async function showCheckoutModal() {
            const items = state.cart.map(item => {
                const product = state.products.find(p => p.id === item.productId);
                
                // Check if on sale (with min qty), then bulk, then single
                let subtotal;
                let priceDisplay;
                let saleMinQty = product.sale_min_qty || 1;
                let isOnSale = product.sale_active && product.sale_price > 0 && item.qty >= saleMinQty;
                
                if (isOnSale) {
                    priceDisplay = product.sale_price;
                    subtotal = product.sale_price * item.qty;
                } else if (product.price_bulk && item.qty >= product.bulk_quantity) {
                    const pricePerItem = product.price_bulk / product.bulk_quantity;
                    subtotal = pricePerItem * item.qty;
                    priceDisplay = pricePerItem;
                } else {
                    subtotal = product.price_single * item.qty;
                    priceDisplay = product.price_single;
                }
                
                return { ...item, product, price: priceDisplay, subtotal, isOnSale };
            });
            const subtotal = items.reduce((sum, i) => sum + i.subtotal, 0);
            
            // Apply discount if exists
            let discountAmount = 0;
            if (state.discount) {
                if (state.discount.discount_percent > 0) {
                    discountAmount = subtotal * (state.discount.discount_percent / 100);
                } else {
                    discountAmount = state.discount.discount_amount;
                }
            }
            
            // Load user's credit balance
            let userCredit = 0;
            try {
                const me = await api('/api/me');
                userCredit = parseFloat(me.referral_credit) || 0;
                state.userCredit = userCredit;
            } catch (e) {
                state.userCredit = 0;
            }

            document.getElementById('modalContainer').innerHTML = `
                <div class="modal" onclick="if(event.target===this)closeModal()">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <h2>Checkout - Research Use Acknowledgment</h2>
                        <div class="alert alert-warning">
                            <strong>Important:</strong> These materials are intended for research purposes only.
                        </div>
                        <form id="checkoutForm">
                            <div class="form-group">
                                <label><strong>Delivery Method *</strong></label>
                                <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 10px;">
                                    <label style="display: flex; align-items: center; gap: 12px; cursor: pointer; padding: 15px; border: 2px solid #e2e8f0; border-radius: 8px;">
                                        <input type="radio" name="deliveryMethod" value="pickup" onchange="updateCheckoutTotal(${subtotal}, ${discountAmount})" checked style="width: 20px; height: 20px; min-width: 20px;">
                                        <div>
                                            <strong>Pickup</strong> - Free<br>
                                            <small style="color: #718096;">Pick up at location</small>
                                        </div>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 12px; cursor: pointer; padding: 15px; border: 2px solid #e2e8f0; border-radius: 8px;">
                                        <input type="radio" name="deliveryMethod" value="ship" onchange="updateCheckoutTotal(${subtotal}, ${discountAmount})" style="width: 20px; height: 20px; min-width: 20px;">
                                        <div>
                                            <strong>Ship</strong> - +$20.00<br>
                                            <small style="color: #718096;">Shipping fee</small>
                                        </div>
                                    </label>
                                </div>
                            </div>
                            <div id="shippingAddressGroup" class="form-group" style="display: none;">
                                <label>Shipping Address *</label>
                                <textarea id="shippingAddress" rows="3" placeholder="Enter full shipping address"></textarea>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="ack1">
                                <label for="ack1">I confirm that I am purchasing these materials for legitimate research purposes only.</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="ack2">
                                <label for="ack2">I understand these products are not for human consumption or clinical use.</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="ack3">
                                <label for="ack3">I am authorized to purchase research materials for my organization/institution.</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="ack4">
                                <label for="ack4">I agree to use these materials in compliance with all applicable laws and regulations.</label>
                            </div>
                            <div id="checkoutTotals" style="background: #f7fafc; padding: 15px; border-radius: 8px; margin: 15px 0;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span>Subtotal:</span>
                                    <span>$${subtotal.toFixed(2)}</span>
                                </div>
                                ${discountAmount > 0 ? `
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px; color: #38a169;">
                                    <span>Discount:</span>
                                    <span>-$${discountAmount.toFixed(2)}</span>
                                </div>
                                ` : ''}
                                <div id="shippingLine" style="display: none; justify-content: space-between; margin-bottom: 5px;">
                                    <span>Shipping:</span>
                                    <span>$20.00</span>
                                </div>
                                <div id="creditLine" style="display: none; justify-content: space-between; margin-bottom: 5px; color: #805ad5;">
                                    <span>Credit Applied:</span>
                                    <span id="creditAppliedAmount">$0.00</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-weight: 600; font-size: 1.1rem; border-top: 1px solid #e2e8f0; padding-top: 10px; margin-top: 10px;">
                                    <span>Total:</span>
                                    <span id="checkoutTotal">$${(subtotal - discountAmount).toFixed(2)}</span>
                                </div>
                            </div>
                            <div id="creditSection" style="display: none; background: #faf5ff; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong style="color: #553c9a;">üí∞ Referral Credit Available</strong>
                                        <div style="font-size: 1.2rem; color: #805ad5; font-weight: 600;" id="availableCreditDisplay">$0.00</div>
                                    </div>
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                        <input type="checkbox" id="applyCredit" onchange="updateCheckoutTotal(${subtotal}, ${discountAmount})" style="width: 18px; height: 18px;">
                                        <span>Apply Credit</span>
                                    </label>
                                </div>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 15px;">
                                <button type="button" class="btn btn-success" onclick="submitOrder()" style="padding: 15px; font-size: 1.1rem;">Place Order</button>
                                <button type="button" class="btn btn-secondary" onclick="closeModal()" style="padding: 12px;">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Show credit section if user has credit
            if (userCredit > 0) {
                document.getElementById('creditSection').style.display = 'block';
                document.getElementById('availableCreditDisplay').textContent = '$' + userCredit.toFixed(2);
            }
        }
        
        function updateCheckoutTotal(subtotal, discountAmount) {
            const deliveryMethod = document.querySelector('input[name="deliveryMethod"]:checked').value;
            const shippingCost = deliveryMethod === 'ship' ? 20 : 0;
            
            // Handle credit application
            let creditApplied = 0;
            const applyCreditCheckbox = document.getElementById('applyCredit');
            if (applyCreditCheckbox && applyCreditCheckbox.checked && state.userCredit > 0) {
                const maxCredit = subtotal - discountAmount + shippingCost;
                creditApplied = Math.min(state.userCredit, maxCredit);
                document.getElementById('creditLine').style.display = 'flex';
                document.getElementById('creditAppliedAmount').textContent = '-$' + creditApplied.toFixed(2);
            } else {
                document.getElementById('creditLine').style.display = 'none';
            }
            
            const total = Math.max(0, subtotal - discountAmount + shippingCost - creditApplied);
            
            document.getElementById('checkoutTotal').textContent = '$' + total.toFixed(2);
            document.getElementById('shippingLine').style.display = deliveryMethod === 'ship' ? 'flex' : 'none';
            document.getElementById('shippingAddressGroup').style.display = deliveryMethod === 'ship' ? 'block' : 'none';
            
            // Make shipping address required only for ship
            const addressField = document.getElementById('shippingAddress');
            if (deliveryMethod === 'ship') {
                addressField.setAttribute('required', 'required');
            } else {
                addressField.removeAttribute('required');
            }
        }

        async function submitOrder() {
            // Check all acknowledgments are checked
            const ack1 = document.getElementById('ack1').checked;
            const ack2 = document.getElementById('ack2').checked;
            const ack3 = document.getElementById('ack3').checked;
            const ack4 = document.getElementById('ack4').checked;
            
            if (!ack1 || !ack2 || !ack3 || !ack4) {
                showAlert('Please confirm all acknowledgments');
                return;
            }
            
            const deliveryMethod = document.querySelector('input[name="deliveryMethod"]:checked').value;
            const shippingAddressEl = document.getElementById('shippingAddress');
            const shippingAddress = shippingAddressEl ? shippingAddressEl.value : '';
            
            if (deliveryMethod === 'ship' && !shippingAddress.trim()) {
                showAlert('Please enter a shipping address');
                return;
            }
            
            // Check if applying credit
            const applyCreditCheckbox = document.getElementById('applyCredit');
            const applyCredit = applyCreditCheckbox && applyCreditCheckbox.checked;
            
            const items = state.cart.map(item => ({
                product_id: item.productId,
                quantity: item.qty
            }));

            try {
                const result = await api('/api/orders', {
                    method: 'POST',
                    body: JSON.stringify({
                        items,
                        discount_code: state.discount?.code || null,
                        referrer_choice: state.referrerChoice || null,
                        delivery_method: deliveryMethod,
                        shipping_address: deliveryMethod === 'ship' ? shippingAddress : 'Pickup',
                        apply_credit: applyCredit,
                        final_attestation: true,
                        acknowledgments: {
                            research_only: ack1,
                            not_for_consumption: ack2,
                            authorized: ack3,
                            compliance: ack4
                        }
                    })
                });
                
                state.cart = [];
                state.discount = null;
                state.referrerChoice = null;
                state.userCredit = 0;
                saveCart();
                closeModal();
                
                let message = 'Order ' + result.order_number + ' placed successfully!';
                if (result.credit_applied > 0) {
                    message += ' ($' + result.credit_applied.toFixed(2) + ' credit applied)';
                }
                if (result.credit_earned > 0) {
                    message += ' (+$' + result.credit_earned.toFixed(2) + ' credit earned!)';
                }
                showAlert(message, 'success');
                showView('orders');
            } catch (err) {
                showAlert(err.message);
            }
        }

        function closeModal() {
            document.getElementById('modalContainer').innerHTML = '';
        }

        // Orders view
        async function renderOrders() {
            try {
                state.orders = await api('/api/orders');
            } catch (e) {
                showAlert('Failed to load orders');
                return;
            }

            document.getElementById('mainContent').innerHTML = `
                <div class="card">
                    <h2>My Orders</h2>
                    ${state.orders.length === 0 ? '<p style="text-align: center; color: #718096;">No orders yet</p>' : `
                        <div>
                            ${state.orders.map(order => `
                                <div class="order-row" onclick="showOrderDetail(${order.id})">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <h4>${order.order_number}</h4>
                                            <p>${new Date(order.created_at).toLocaleDateString()} - ${order.items ? order.items.length : 0} item(s)</p>
                                        </div>
                                        <div style="text-align: right;">
                                            <span class="order-status status-${order.status}">${order.status}</span>
                                            <p style="margin-top: 5px; font-weight: 600;">$${parseFloat(order.total).toFixed(2)}</p>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `}
                </div>
            `;
        }

        function showOrderDetail(orderId) {
            const order = state.orders.find(o => o.id === orderId);
            if (!order) return;

            document.getElementById('modalContainer').innerHTML = `
                <div class="modal" onclick="if(event.target===this)closeModal()">
                    <div class="modal-content">
                        <h2>Order ${order.order_number}</h2>
                        <div class="order-detail">
                            <p><strong>Status:</strong> <span class="order-status status-${order.status}">${order.status}</span></p>
                            <p><strong>Date:</strong> ${new Date(order.created_at).toLocaleString()}</p>
                            <p><strong>Delivery:</strong> ${order.delivery_method === 'ship' ? 'üì¶ Shipping' : 'üè™ Pickup'}</p>
                            ${order.tracking_number ? `<p><strong>Tracking:</strong> ${order.tracking_number}</p>` : ''}
                            ${order.delivery_method === 'ship' && order.shipping_address ? `<p><strong>Ship To:</strong> ${order.shipping_address}</p>` : ''}
                            
                            <h4 style="margin-top: 20px;">Items</h4>
                            <table class="order-items-table">
                                <thead>
                                    <tr><th>Product</th><th>Qty</th><th>Price</th><th>Subtotal</th></tr>
                                </thead>
                                <tbody>
                                    ${order.items ? order.items.map(item => `
                                        <tr>
                                            <td>${item.name}</td>
                                            <td>${item.quantity}</td>
                                            <td>$${parseFloat(item.unit_price).toFixed(2)}</td>
                                            <td>$${(item.quantity * parseFloat(item.unit_price)).toFixed(2)}</td>
                                        </tr>
                                    `).join('') : '<tr><td colspan="4">No items</td></tr>'}
                                </tbody>
                            </table>
                            
                            <div style="text-align: right; margin-top: 15px;">
                                <p>Subtotal: $${parseFloat(order.subtotal).toFixed(2)}</p>
                                ${parseFloat(order.discount_amount) > 0 ? `<p style="color: #38a169;">Discount: -$${parseFloat(order.discount_amount).toFixed(2)}</p>` : ''}
                                ${parseFloat(order.shipping_cost || 0) > 0 ? `<p>Shipping: $${parseFloat(order.shipping_cost).toFixed(2)}</p>` : ''}
                                <p style="font-size: 1.2rem; font-weight: 600;">Total: $${parseFloat(order.total).toFixed(2)}</p>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                            <button class="btn" onclick="downloadInvoice(${order.id})">Download Invoice</button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function downloadInvoice(orderId) {
            try {
                const res = await fetch(`/api/orders/${orderId}/invoice`, { credentials: 'same-origin' });
                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.error || 'Failed to download invoice');
                }
                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `invoice-${orderId}.pdf`;
                a.click();
                window.URL.revokeObjectURL(url);
            } catch (err) {
                showAlert(err.message);
            }
        }

        // First login modal
        function showFirstLoginModal() {
            document.getElementById('modalContainer').innerHTML = `
                <div class="modal">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <h2 style="color: #2d3748;">Research Use Reaffirmation</h2>
                        <div style="background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; margin: 15px 0;">
                            <p style="color: #4a5568; font-size: 0.95rem; line-height: 1.6; margin: 0;">
                                Before accessing products, you must reaffirm that you are purchasing materials for 
                                <strong>research use only</strong>. All materials offered by The Peptide Wizard are 
                                designated Research Use Only (RUO) and are not intended for human or veterinary use.
                            </p>
                        </div>
                        <div class="checkbox-group" style="background: #fffbeb; padding: 15px; border-radius: 8px; border: 1px solid #f6e05e;">
                            <input type="checkbox" id="firstLoginAck" style="width: 22px; height: 22px; min-width: 22px;">
                            <label for="firstLoginAck" style="font-weight: 500; color: #744210;">
                                I reaffirm that I understand all products are for Research Use Only and are not intended for human or veterinary use.
                            </label>
                        </div>
                        <button class="btn" style="width: 100%; margin-top: 20px; padding: 14px;" onclick="confirmFirstLogin()">Continue to Products</button>
                    </div>
                </div>
            `;
        }

        async function confirmFirstLogin() {
            if (!document.getElementById('firstLoginAck').checked) {
                showAlert('Please confirm the acknowledgment');
                return;
            }
            try {
                await api('/api/confirm-first-login', { method: 'POST' });
                closeModal();
            } catch (err) {
                showAlert(err.message);
            }
        }

        // ============================================
        // RETURNS SECTION
        // ============================================
        
        async function renderReturns() {
            document.getElementById('mainContent').innerHTML = `
                <div class="card">
                    <h2>üîÑ Returns & Store Credit</h2>
                    
                    <!-- Credit Balance -->
                    <div id="creditBalanceSection" style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 25px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                            <div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">Your Store Credit Balance</div>
                                <div id="creditBalance" style="font-size: 2rem; font-weight: 700;">$0.00</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 0.85rem; opacity: 0.9;">Credit is automatically applied at checkout</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Submit New Return Request -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="margin-bottom: 15px; font-size: 1.1rem;">Submit a Return Request</h3>
                        <p style="color: #718096; margin-bottom: 15px; font-size: 0.9rem;">
                            If you received damaged, wrong, or defective items, submit a request below. 
                            We'll review it and issue store credit, a replacement, or refund as appropriate.
                        </p>
                        
                        <div class="form-group">
                            <label>Select Order</label>
                            <select id="returnOrderSelect" onchange="loadOrderItemsForReturn()">
                                <option value="">-- Select an order --</option>
                            </select>
                        </div>
                        
                        <div id="returnOrderItems" class="hidden">
                            <div class="form-group">
                                <label>Select Items to Return</label>
                                <div id="returnItemsList" style="border: 2px solid #e2e8f0; border-radius: 8px; padding: 15px; max-height: 300px; overflow-y: auto;"></div>
                            </div>
                            
                            <div class="form-group">
                                <label>Reason for Return</label>
                                <select id="returnReason" required>
                                    <option value="">-- Select reason --</option>
                                    <option value="damaged_shipping">Damaged in Shipping</option>
                                    <option value="wrong_item">Wrong Item Sent</option>
                                    <option value="quality_issue">Quality Issue</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Additional Details</label>
                                <textarea id="returnDetails" rows="3" placeholder="Please describe the issue in detail..."></textarea>
                            </div>
                            
                            <button class="btn" onclick="submitReturnRequest()">Submit Return Request</button>
                        </div>
                    </div>
                    
                    <!-- Existing Return Requests -->
                    <div>
                        <h3 style="margin-bottom: 15px; font-size: 1.1rem;">Your Return Requests</h3>
                        <div id="myReturnsList"><p style="color: #718096;">Loading...</p></div>
                    </div>
                </div>
            `;
            
            await Promise.all([
                loadCreditBalance(),
                loadEligibleOrders(),
                loadMyReturns()
            ]);
        }

        async function loadCreditBalance() {
            try {
                const data = await api('/api/user/referral-info');
                document.getElementById('creditBalance').textContent = '$' + (data.credit_balance || 0).toFixed(2);
            } catch (err) {
                console.error('Error loading credit balance:', err);
            }
        }

        async function loadEligibleOrders() {
            try {
                const orders = await api('/api/returns/eligible-orders');
                state.eligibleOrders = orders;
                
                const select = document.getElementById('returnOrderSelect');
                select.innerHTML = '<option value="">-- Select an order --</option>';
                
                orders.forEach(order => {
                    if (order.existing_returns === 0) {
                        const date = new Date(order.created_at).toLocaleDateString();
                        select.innerHTML += `<option value="${order.id}">
                            ${escapeHtml(order.order_number)} - $${parseFloat(order.total).toFixed(2)} (${date})
                        </option>`;
                    }
                });
            } catch (err) {
                console.error('Error loading eligible orders:', err);
            }
        }

        function loadOrderItemsForReturn() {
            const orderId = document.getElementById('returnOrderSelect').value;
            const itemsSection = document.getElementById('returnOrderItems');
            const itemsList = document.getElementById('returnItemsList');
            
            if (!orderId) {
                itemsSection.classList.add('hidden');
                return;
            }
            
            const order = state.eligibleOrders.find(o => o.id == orderId);
            if (!order || !order.items) {
                itemsSection.classList.add('hidden');
                return;
            }
            
            itemsList.innerHTML = order.items.map(item => `
                <div class="return-item-check">
                    <input type="checkbox" id="returnItem_${item.order_item_id}" 
                           data-order-item-id="${item.order_item_id}"
                           data-product-id="${item.product_id}"
                           data-max-qty="${item.quantity}">
                    <div class="item-info">
                        <strong>${escapeHtml(item.name)}</strong> (${escapeHtml(item.sku)})<br>
                        <span style="color: #718096; font-size: 0.85rem;">
                            Qty: ${item.quantity} √ó $${parseFloat(item.unit_price).toFixed(2)}
                        </span>
                    </div>
                    <input type="number" class="qty-input" id="returnQty_${item.order_item_id}" 
                           value="${item.quantity}" min="1" max="${item.quantity}">
                </div>
            `).join('');
            
            itemsSection.classList.remove('hidden');
        }

        async function submitReturnRequest() {
            const orderId = document.getElementById('returnOrderSelect').value;
            const reason = document.getElementById('returnReason').value;
            const details = document.getElementById('returnDetails').value;
            
            if (!orderId) {
                showAlert('Please select an order');
                return;
            }
            
            if (!reason) {
                showAlert('Please select a reason for return');
                return;
            }
            
            const items = [];
            const checkboxes = document.querySelectorAll('#returnItemsList input[type="checkbox"]:checked');
            
            if (checkboxes.length === 0) {
                showAlert('Please select at least one item to return');
                return;
            }
            
            checkboxes.forEach(cb => {
                const orderItemId = cb.dataset.orderItemId;
                const productId = cb.dataset.productId;
                const maxQty = parseInt(cb.dataset.maxQty);
                const qty = parseInt(document.getElementById('returnQty_' + orderItemId).value) || maxQty;
                
                items.push({
                    order_item_id: parseInt(orderItemId),
                    product_id: parseInt(productId),
                    quantity: Math.min(qty, maxQty)
                });
            });
            
            try {
                const result = await api('/api/returns/submit', {
                    method: 'POST',
                    body: JSON.stringify({
                        order_id: parseInt(orderId),
                        reason: reason,
                        reason_details: details,
                        items: items
                    })
                });
                
                showAlert('Return request submitted for order ' + result.order_number + '. We\\'ll review it shortly.', 'success');
                
                document.getElementById('returnOrderSelect').value = '';
                document.getElementById('returnOrderItems').classList.add('hidden');
                document.getElementById('returnReason').value = '';
                document.getElementById('returnDetails').value = '';
                
                await Promise.all([loadEligibleOrders(), loadMyReturns()]);
                
            } catch (err) {
                showAlert(err.message || 'Error submitting return request');
            }
        }

        async function loadMyReturns() {
            try {
                const returns = await api('/api/returns/my-requests');
                state.myReturns = returns;
                
                const container = document.getElementById('myReturnsList');
                
                if (returns.length === 0) {
                    container.innerHTML = '<p style="color: #718096;">No return requests yet.</p>';
                    return;
                }
                
                const statusLabels = {
                    'pending': 'Pending Review',
                    'approved': 'Approved - Credit Issued',
                    'denied': 'Denied',
                    'refund_pending': 'Refund Processing',
                    'refunded': 'Refunded',
                    'replacement_pending': 'Replacement Processing'
                };
                
                const reasonLabels = {
                    'damaged_shipping': 'Damaged in Shipping',
                    'wrong_item': 'Wrong Item Sent',
                    'quality_issue': 'Quality Issue',
                    'other': 'Other'
                };
                
                container.innerHTML = returns.map(ret => `
                    <div class="return-card ${ret.status}">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div>
                                <strong>Order: ${escapeHtml(ret.order_number)}</strong><br>
                                <span style="color: #718096; font-size: 0.85rem;">
                                    ${new Date(ret.created_at).toLocaleDateString()} - ${reasonLabels[ret.reason] || ret.reason}
                                </span>
                            </div>
                            <span class="return-status ${ret.status}">${statusLabels[ret.status] || ret.status}</span>
                        </div>
                        ${ret.resolution_amount > 0 ? `
                            <div style="background: #c6f6d5; color: #276749; padding: 8px 12px; border-radius: 6px; font-size: 0.9rem;">
                                ‚úì Credit issued: $${parseFloat(ret.resolution_amount).toFixed(2)}
                            </div>
                        ` : ''}
                        ${ret.admin_notes && ret.status !== 'pending' ? `
                            <div style="margin-top: 10px; font-size: 0.85rem; color: #4a5568;">
                                <strong>Note:</strong> ${escapeHtml(ret.admin_notes)}
                            </div>
                        ` : ''}
                    </div>
                `).join('');
                
            } catch (err) {
                console.error('Error loading returns:', err);
                document.getElementById('myReturnsList').innerHTML = '<p style="color: #e53e3e;">Error loading returns</p>';
            }
        }

        // ============================================
        // END RETURNS SECTION
        // ============================================

        // URL hash routing for password reset
        function handleHash() {
            const hash = window.location.hash;
            if (hash.startsWith('#reset=')) {
                const token = hash.slice(7);
                showResetPasswordForm(token);
            } else if (hash.startsWith('#verify=')) {
                const token = hash.slice(8);
                verifyEmail(token);
            }
        }

        function showResetPasswordForm(token) {
            document.getElementById('mainContent').innerHTML = `
                <div class="card" style="max-width: 450px; margin: 0 auto;">
                    <h2>Set New Password</h2>
                    <form onsubmit="resetPassword(event, '${token}')">
                        <div class="form-group">
                            <label>New Password</label>
                            <input type="password" id="newPassword" required minlength="8">
                        </div>
                        <div class="form-group">
                            <label>Confirm Password</label>
                            <input type="password" id="newPassword2" required>
                        </div>
                        <button type="submit" class="btn" style="width: 100%;">Reset Password</button>
                    </form>
                </div>
            `;
        }

        async function resetPassword(e, token) {
            e.preventDefault();
            const pw = document.getElementById('newPassword').value;
            const pw2 = document.getElementById('newPassword2').value;
            if (pw !== pw2) {
                showAlert('Passwords do not match');
                return;
            }
            try {
                await api('/api/reset-password', {
                    method: 'POST',
                    body: JSON.stringify({ token, password: pw })
                });
                showAlert('Password reset successful! Please login.', 'success');
                window.location.hash = '';
                showLogin();
            } catch (err) {
                showAlert(err.message);
            }
        }

        async function verifyEmail(token) {
            try {
                await api(`/api/verify-email/${token}`, { method: 'POST' });
                showAlert('Email verified successfully!', 'success');
                window.location.hash = '';
                document.getElementById('verificationBanner').classList.add('hidden');
                if (state.user) state.user.email_verified = true;
            } catch (err) {
                showAlert(err.message);
            }
            if (!state.user) showLogin();
        }

        // Initialize on load
        window.onhashchange = handleHash;
        init().then(handleHash);
    </script>
</body>
</html>
